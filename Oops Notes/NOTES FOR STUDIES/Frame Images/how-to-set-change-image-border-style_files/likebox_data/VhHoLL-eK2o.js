/*1343357194,169775815*/

if (window.CavalryLogger) { CavalryLogger.start_js(["JEehy"]); }

__d("AjaxRequest",["ErrorUtils","Keys","URI","UserAgent","XHR","copyProperties"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h=b('Keys'),i=b('URI'),j=b('UserAgent'),k=b('XHR'),l=b('copyProperties');function m(p,q,r){this.xhr=k.create();if(!(q instanceof i))q=new i(q);if(r&&p=='GET'){q.setQueryData(r);}else this._params=r;this.method=p;this.uri=q;this.xhr.open(p,q);}m.corsEnabled=window.XMLHttpRequest&&('withCredentials' in new XMLHttpRequest());m.ERROR='ar:error';m.TIMEOUT='ar:timeout';m.PROXY_ERROR='ar:proxy error';m.TRANSPORT_ERROR='ar:transport error';m.SERVER_ERROR='ar:http error';m.PARSE_ERROR='ar:parse error';m._inflight=[];function n(){var p=m._inflight;m._inflight=[];p.forEach(function(q){q.abort();});}function o(p){p.onJSON=p.onError=p.onSuccess=null;clearTimeout(p._timer);if(p.xhr&&p.xhr.readyState<4){p.xhr.abort();p.xhr=null;}m._inflight=m._inflight.filter(function(q){return q&&q!=p&&q.xhr&&q.xhr.readyState<4;});}l(m.prototype,{timeout:60000,prelude:/^for \(;;\);/,status:null,_eol:-1,_call:function(p){if(this[p])this[p](this);},_parseStatus:function(){var p;try{this.status=this.xhr.status;p=this.xhr.statusText;}catch(q){if(this.xhr.readyState>=4){this.errorType=m.TRANSPORT_ERROR;this.errorText=q.message;}return;}if(this.status===0&&!(/^(file|ftp)/.test(this.uri))){this.errorType=m.TRANSPORT_ERROR;}else if(this.status>=100&&this.status<200){this.errorType=m.PROXY_ERROR;}else if(this.status>=200&&this.status<300){return;}else if(this.status>=300&&this.status<400){this.errorType=m.PROXY_ERROR;}else if(this.status>=400&&this.status<500){this.errorType=m.SERVER_ERROR;}else if(this.status>=500&&this.status<600){this.errorType=m.PROXY_ERROR;}else if(this.status==1223){return;}else if(this.status>=12001&&this.status<=12156){this.errorType=m.TRANSPORT_ERROR;}else{p='unrecognized status code: '+this.status;this.errorType=m.ERROR;}if(!this.errorText)this.errorText=p;},_parseResponse:function(){var p,q=this.xhr.readyState;try{p=this.xhr.responseText||'';}catch(r){if(q>=4){this.errorType=m.ERROR;this.errorText='responseText not available - '+r.message;}return;}while(this.xhr){var s=this._eol+1,t=p.indexOf('\n',s);if(t<0&&q==4)t=p.length;if(t<=this._eol)break;var u=p.substr(s,t-s).replace(/^\s*|\s*$/g,'');if(s===0&&this.prelude)if(this.prelude.test(u))u=u.replace(this.prelude,'');this._eol=t;if(u){try{this.json=JSON.parse(u);}catch(r){var v=(/(<body[\S\s]+?<\/body>)/i).test(p)&&RegExp.$1,w={message:r.message,'char':s,excerpt:((s===0&&v)||u).substr(512)};this.errorType=m.PARSE_ERROR;this.errorText='parse error - '+JSON.stringify(w);return;}g.applyWithGuard(this._call,this,['onJSON']);}}},_onReadyState:function(){var p=this.xhr&&this.xhr.readyState||0;if(this.status==null&&p>=2)this._parseStatus();if(this.status!=null&&p>=3&&!this.errorType)this._parseResponse();if(this.errorType||p==4){this._time=Date.now()-this._sentAt;this._call(!this.errorType?'onSuccess':'onError');o(this);}},send:function(p){this.xhr.onreadystatechange=function(){g.applyWithGuard(this._onReadyState,this,arguments);}.bind(this);var q=this.timeout;if(q)this._timer=setTimeout((function(){this.errorType=m.TIMEOUT;this.errorText='timeout';this._time=Date.now()-this._sentAt;this._call('onError');o(this);}).bind(this),q,false);m._inflight.push(this);if(this.method=='POST')this.xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');this._sentAt=Date.now();this.xhr.send(p?i.implodeQuery(p):'');},abort:function(){o(this);},toString:function(){var p='[AjaxRequest readyState='+this.xhr.readyState;if(this.errorType)p+=' errorType='+this.errorType+' ('+this.errorText+')';return p+']';},toJSON:function(){var p={json:this.json,status:this.status,errorType:this.errorType,errorText:this.errorText,time:this._time};for(var q in p)if(p[q]==null)delete p[q];return p;}});if(window.addEventListener&&j.firefox())window.addEventListener('keydown',function(event){if(event.keyCode===h.ESC)event.prevent();},false);if(window.attachEvent)window.attachEvent('onunload',n);e.exports=m;});
__d("DocRPC",[],function(a,b,c,d,e,f){var g={_apis:{},_dispatch:function(h){var i;h=JSON.parse(h);if(g._apis.hasOwnProperty(h.api)){var j=g._apis[h.api];if(j[h.method])i=j[h.method].apply(j,h.args);}return JSON.stringify(i);},publish:function(h,i){g._apis[i]=h;},proxy:function(h,i,j){var k={};j.forEach(function(l){k[l]=function(){var m={api:i,method:l,args:Array.prototype.slice.call(arguments)},n=h.DocRPC._dispatch(JSON.stringify(m));return typeof(n)=='string'?JSON.parse(n):n;};});return k;}};e.exports=a.DocRPC=g;});
__d("ChannelTransport",["copyProperties","bind","AjaxRequest","URI","JSLogger","DocRPC","ChannelConstants"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('bind'),i=b('AjaxRequest'),j=b('URI'),k=b('JSLogger'),l=b('DocRPC'),m=b('ChannelConstants'),n=k.create('channel'),o=null;function p(){return (1048576*Math.random()|0).toString(36);}function q(z,aa){var ba=z.subdomain;ba=ba===null?'':(ba+'-');var ca=new j(aa).setDomain(ba+z.host+'.facebook.com').setPort(z.port).setSecure(j().isSecure());return ca;}function r(event,z){if(window!==window.parent&&/iframe/.test(window.location)){if(!o)o=l.proxy(window.parent,'outerTransport',['_addJsLoggerEntry'],top.DocRPC.origin);o._addJsLoggerEntry(event,z);}else n.log(event,z);}function s(z){var aa={partition:z.partition,cb:p()},ba=q(z,'/p').setQueryData(aa);r('start_p',{uri:ba.toString()});var ca=new i('GET',ba);if(i.corsEnabled)ca.xhr.withCredentials=true;var da=function(ea){r('finish_p',{xhr:ea.toJSON?ea.toJSON():ea});};ca.timeout=z.P_TIMEOUT;ca.onError=ca.onSuccess=da;ca.send();}function t(z,aa,ba){var ca=new Image(),da=0,ea=function(ha){ca.abort();return ha?aa():ba();};ca.onload=function(){r('ping_ok',{duration:Date.now()-da});ea(true);};ca.onerror=function(){s(z);ea(false);};var fa=setTimeout(ca.onerror,10000,false);ca.abort=function(){if(fa){clearTimeout(fa);fa=null;}ca.onload=ca.onerror=null;};var ga={partition:z.partition,cb:p()};da=Date.now();ca.src=q(z,'/ping').setQueryData(ga);return ca;}function u(z,aa,ba,ca){var da=new Date(),ea=(da-z.userActive)/1000|0;if(ea<0)n.warn('idle_regression',{idleTime:ea,now:da.getTime(),userActive:z.userActive});var fa={channel:z.user_channel,seq:z.seq,partition:z.partition,clientid:z.sessionID,cb:p(),idle:ea};if(ea<60)fa.state='active';if(z.streamingCapable){fa.mode='stream';fa.format='json';}var ga=q(z,'/pull').setQueryData(fa),ha=new i('GET',ga);if(i.corsEnabled)ha.xhr.withCredentials=true;ha.timeout=z.streamingCapable?z.STREAMING_TIMEOUT:z.LONGPOLL_TIMEOUT;ha.onJSON=aa;ha.onSuccess=ba;ha.onError=function(){var ia=(this.status==12002&&this._time>=z.MIN_12002_TIMEOUT)||(this.status==504&&this._time>=z.MIN_504_TIMEOUT),ja=ia?ba:ca;return ja&&ja.apply(this,arguments);};ha.send();z.inStreaming=z.streamingCapable;return ha;}function v(z){this.manager=z;(this.init&&this.init());}function w(z){v.apply(this,arguments);}g(w.prototype,{logName:'CORS',enterState:function(z,aa){if(this._request){this._request.abort();this._request=null;}if(z=='init')setTimeout(h(this.manager,'exitState',{status:m.OK,stateId:aa.stateId}),3000,false);if(!/pull|ping/.test(z))return;var ba=this.manager;if(z=='ping'){this._request=t(aa,h(ba,'exitState',{status:m.OK,stateId:aa.stateId}),h(ba,'exitState',{status:m.ERROR,stateId:aa.stateId}));}else if(z=='pull')this._request=u(aa,h(ba,'_processTransportData',aa.stateId),h(ba,'exitState',{status:m.OK,stateId:aa.stateId}),h(ba,'exitState',{status:m.ERROR,stateId:aa.stateId}));}});function x(z){n.log('iframe_init_constructor');v.apply(this,arguments);this._iframe=document.createElement('iframe');this._iframe.style.display='none';document.body.appendChild(this._iframe);l.publish(this,'outerTransport');}g(x.prototype,{logName:'iframe',_initIframe:function(z){n.log('iframe_init_start');window.onchanneliframeready=function(){n.log('iframe_resources');return z.resources;};window.onchanneliframeloaded=function(){n.log('iframe_loaded');};if(z){this._iframeURI=q(z,z.path);if(z.bustIframe){var aa={partition:z.partition,cb:p()};this._iframeURI.setQueryData(aa);}}else this._iframeURI='about:blank';this._iframeProxy=null;try{this._iframe.contentWindow.location.replace(this._iframeURI);n.log('iframe_uri_set');}catch(ba){n.error('iframe_uri_set_error',ba);this.exitState({status:m.ERROR,stateId:z.stateId},ba+'');}},_addJsLoggerEntry:function(event,z){n.log(event,z);},enterState:function(z,aa){if(z=='init'){this._initIframe(aa);}else if(/idle|ping|pull/.test(z)){if(this._iframeProxy){this._iframeProxy.enterState.apply(this._iframeProxy,arguments);}else if(z!='idle')this.exitState({status:m.ERROR,stateId:aa.stateId},'iframe not yet loaded');}else if(z=='shutdown')this._initIframe();},_processTransportData:function(){this.manager._processTransportData.apply(this.manager,arguments);},exitState:function(z){if(this.manager.state=='init'&&z.status==m.OK)this._iframeProxy=l.proxy(this._iframe.contentWindow,'innerTransport',['enterState'],(this._iframeURI+'').replace(/iframe.*/,''));if(/ping|pull/.test(this.manager.state)&&!this._iframeProxy)return;this.manager.exitState.apply(this.manager,arguments);}});function y(){this.init=this.init.bind(this);v.apply(this,arguments);}g(y.prototype,{logName:'iframe(inner)',init:function(){l.publish(this,'innerTransport');try{var aa=l.proxy(window.parent,'outerTransport',['_processTransportData','exitState'],top.DocRPC.origin);g(this,aa);this.exitState({status:m.OK,stateId:1e+06});}catch(z){n.error('iframe_inner_init_error',z);}},enterState:function(z,aa){if(this._request){this._request.abort();this._request=null;}if(z=='ping'){this._request=t(aa,h(this,'exitState',{status:m.OK,stateId:aa.stateId}),h(this,'exitState',{status:m.ERROR,stateId:aa.stateId}));}else if(z=='pull')this._request=u(aa,h(this,'_processTransportData',aa.stateId),h(this,'exitState',{status:m.OK,stateId:aa.stateId}),h(this,'exitState',{status:m.ERROR,stateId:aa.stateId}));}});e.exports={getURI:q,Transport:v,CORSTransport:w,IframeTransport:x,IframeInnerTransport:y};});
__d("FBAjaxRequest",["$","AjaxRequest","copyProperties","XHR"],function(a,b,c,d,e,f){var g=b('$'),h=b('AjaxRequest'),i=b('copyProperties'),j=b('XHR');function k(l,m,n){n=i(j.getAsyncParams(l),n);var o=new h(l,m,n),p=o._call;o._call=function(q){if(q=='onJSON'&&this.json){if(this.json.error){this.errorType=h.SERVER_ERROR;this.errorText='AsyncResponse error: '+this.json.error;}this.json=this.json.payload;}p.apply(this,arguments);};return o;}e.exports=k;});
__d("MovingStat",[],function(a,b,c,d,e,f){function g(h){h=h||60000;var i={t:new Date(),count:0,v:0},j=i,k=0,l=0;function m(){var n=new Date()-h;while(j&&j.next&&j.t<n){k-=j.v;l-=j.count;j=j.next;}}this.add=function(n){k+=n;l++;var o=new Date();if(o-i.t<1000){i.v+=n;i.count++;}else{i.next={t:o,v:n,count:1};i=i.next;m();}};this.tally=function(n){n=n||1000;m();return {sum:k,count:l,timeAverage:k*n/h};};}e.exports=g;});
__d("randomInt",[],function(a,b,c,d,e,f){function g(h,i){if(arguments.length===1){i=h;h=0;}var j=this.random||Math.random;return Math.floor(h+j()*(i-h));}e.exports=g;});
__d("debounceAcrossTransitions",["debounce"],function(a,b,c,d,e,f){var g=b('debounce');function h(i,j,k){return g(i,j,k,true);}e.exports=h;});
__d("setIntervalAcrossTransitions",[],function(a,b,c,d,e,f){function g(h,i){return setInterval(h,i,false);}e.exports=g;});
__d("ChannelManager",["event-extensions","function-extensions","AjaxRequest","Arbiter","AsyncRequest","ChannelConstants","ChannelSubdomain","ChannelTransport","Cookie","Env","FBAjaxRequest","JSLogger","MovingStat","PresenceCookieManager","PresenceState","PresenceUtil","Run","SystemEvents","URI","UserActivity","UserAgent","copyProperties","createArrayFrom","hasArrayNature","ChannelInitialData"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('AjaxRequest'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('ChannelConstants'),k=b('ChannelSubdomain'),l=b('ChannelTransport'),m=b('Cookie'),n=b('Env'),o=b('FBAjaxRequest'),p=b('JSLogger'),q=b('MovingStat'),r=b('PresenceCookieManager'),s=b('PresenceState'),t=b('PresenceUtil'),u=b('Run'),v=b('SystemEvents'),w=b('URI'),x=b('UserActivity'),y=b('UserAgent'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('hasArrayNature'),ca=c('ChannelInitialData'),da,ea=p.create('channel'),fa={idle:{ok:'init!'},init:{ok:'pull!',error:'reconnect',sys_online:'init',sys_timetravel:'init'},pull:{ok:'pull!',error:'ping',error_missing:'pull',error_msg_type:'pull',refresh_0:'reconnect',refresh_110:'reconnect',refresh_111:'pull',refresh_112:'pull',refresh_113:'pull',refresh_117:'reconnect'},ping:{ok:'pull!',error:'ping',error_stale:'reconnect!'},reconnect:{ok:'init!',error:'reconnect',sys_online:'reconnect',sys_timetravel:'reconnect'},shutdown:{},_all:{error_max:'shutdown!',error_shutdown:'shutdown!',sys_owner:'reconnect',sys_nonowner:'idle!',sys_online:'ping',sys_offline:'idle!',sys_timetravel:'ping'}},ga={userActive:Date.now(),sessionID:(Math.random()*2147483648|0).toString(16),streamingCapable:false,inStreaming:false,LONGPOLL_TIMEOUT:60000,STREAMING_TIMEOUT:60000,P_TIMEOUT:30000,IFRAME_LOAD_TIMEOUT:30000,MIN_RETRY_INTERVAL:5000,MAX_RETRY_INTERVAL:30000,MIN_12002_TIMEOUT:9000,MIN_504_TIMEOUT:20000,STALL_THRESHOLD:180000,JUMPSTART_THRESHOLD:90000,MIN_INIT_PROBE_DELAY:3000,INIT_PROBE_DELAY_RANDOMIZE_RANGE:12000,PROBE_DELAY:60000,PROBE_HEARTBEATS_INTERVAL_LOW:1500,PROBE_HEARTBEATS_INTERVAL_HIGH:2500,STREAMING_EXIT_STATE_ON_CONTINUE:false},ha=1,ia={},ja=0;function ka(qa){return qa.toLowerCase().replace(/[^0-9a-z]+/g,'_');}function la(){return i.lastSuccessTime?Math.round((Date.now()-i.lastSuccessTime)/1000):-1;}function ma(){var qa={};if(da.getConfig('host'))qa[da.getConfig('user_channel')]=da.getConfig('seq',0);return qa;}function na(){var qa=Date.now(),ra=Date.now(),sa={total:0},ta='idle',ua=false;v.subscribe([v.USER,v.ONLINE,v.TIME_TRAVEL],function(xa,ya){pa(true);ra=null;da.lastPullTime=Date.now();var za;switch(xa){case v.USER:za=v.isPageOwner()?j.SYS_OWNER:j.SYS_NONOWNER;break;case v.ONLINE:za=ya?j.SYS_ONLINE:j.SYS_OFFLINE;break;case v.TIME_TRAVEL:za=j.SYS_TIMETRAVEL;break;}da.exitState({status:za,stateId:ha});});var va=function(xa,ya){var za=Date.now(),ab;if(ya){qa=za;ab=ya.nextState||ya.state;}else ab=ta;v.checkTimeTravel();if(ra){var bb=Math.round((za-ra)/1000);if(bb>0){sa[ta]=(sa[ta]||0)+bb;sa.total+=bb;}}ta=ab;ra=za;if(!xa){sa.lastSuccessTime=la();sa.online=v.isOnline();ea.log('rollup',sa);}};h.subscribe(j.ON_ENTER_STATE,va);setInterval(va,60000,false);h.subscribe(p.DUMP_EVENT,function(xa,ya){ya.channelRollup=sa;});var wa=function(){if(da.isShutdown()||da.shouldIdle())return;v.checkTimeTravel();var xa=Date.now()-(da.lastPullTime||n.start);if(!ua&&xa>ga.STALL_THRESHOLD){var ya=la();ea.error('stall',{lastSuccessTime:ya,rollupState:ta});ua=true;}var za=Date.now()-qa;if(da.state=='pull'&&za>ga.JUMPSTART_THRESHOLD){qa=null;ea.warn('jumpstart',{state:da.state,dormant:za});da.enterState('init');}};setInterval(wa,10000,false);}function oa(){var qa=Date.now(),ra=1;function sa(){setTimeout(sa,ra*1000,false);var xa=da.state;if(xa=='idle'&&da.shouldIdle())return;ea.bump('conn_t',ra);if(xa=='pull')ea.bump('conn_t_pull',ra);}sa();var ta=[15,30,60,120,240],ua=false,va=false;function wa(xa){setTimeout(function(){ea.rate('pullenter_'+xa,ua);ea.rate('pullexit_'+xa,va);},xa*1000,false);}while(ta.length)wa(ta.shift());h.subscribe(j.ON_ENTER_STATE,function(xa,ya){if(ya.state=='pull')ua=true;qa=Date.now();});h.subscribe(j.ON_EXIT_STATE,function(xa,ya){if(ya.state!='pull'||!qa)return;var za='other';if(ya.status==j.OK){va=true;za='ok';}else if(ya.xhr&&ya.xhr.errorType){za=/ar:(\w+)/.test(ya.xhr.errorType)&&RegExp.$1;}else if(/^sys_/.test(ya.status))return;var ab=(Date.now()-qa)/1000;if(ab<0){return;}else if(ab>3600)ab=3600;ea.bump('conn_num');ea.bump('conn_exit',ab);ea.bump('conn_num_'+za);ea.bump('conn_exit_'+za,ab);});}function pa(qa){if(qa){ja=0;ia={};}else ja++;}da={state:'idle',nextState:null,lastPullTime:Date.now(),heartbeats:[],init:function(qa){this.init=function(){};if(typeof(x)!='undefined'){x.subscribe(function(){ga.userActive=Date.now();}.bind(this));}else ea.error('user_activity_undefined');r.register('ch',ma);var ra=this.getConfig('max_conn',2);ga.subdomain=k.allocate(ra);if(typeof window.onpageshow!='undefined'){Event.listen(window,'pagehide',k.clear);}else u.onUnload(k.clear);this._transportRate=new q(30000);var sa=(g.corsEnabled&&!ga.forceIframe)?'CORSTransport':'IframeTransport';this.transport=new l[sa](this);if(qa)this.enterState.apply(this,arguments);h.subscribe(p.DUMP_EVENT,function(event,ua){ua.transportRate=this._transportRate.tally();ua.transportType=sa;ua.transportVersion=2;}.bind(this));na();oa();if(da.getConfig('tryStreaming')&&da.getConfig('host')&&g.corsEnabled&&!ga.forceIframe){var ta=ga.MIN_INIT_PROBE_DELAY+Math.random()*ga.INIT_PROBE_DELAY_RANDOMIZE_RANGE;setTimeout(this._probeTest,ta,false);}},configure:function(){var qa=aa(arguments);ea.log('configure',qa);qa.forEach(z.bind(null,ga));h.inform(j.ON_CONFIG,this);},getConfig:function(qa,ra){return qa in ga?ga[qa]:ra;},isShutdown:function(){return this.state=='shutdown';},shouldIdle:function(){return !(v.isPageOwner()&&v.isOnline());},_sendIframeError:function(qa){var ra=new i().setURI('/ajax/presence/reconnect.php').setData({reason:qa,fb_dtsg:n.fb_dtsg}).setOption('suppressErrorHandlerWarning',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);ra.specifiesWriteRequiredParams()&&ra.send();},_getDelay:function(){var qa=Math.min(ga.MIN_RETRY_INTERVAL*Math.pow(2,Math.max(0,ja-1)),ga.MAX_RETRY_INTERVAL);return qa*(.75+Math.random()/2)|0;},enterState:function(){if(this._inEnterState)ea.warn('enterstate_recursion');this._inEnterState=true;try{this._enterState.apply(this,arguments);this._inEnterState=false;}catch(qa){this._inEnterState=false;throw qa;}},_enterState:function(qa){var ra=0,sa=null,ta=aa(arguments);if(this.isShutdown())return;if(qa!='idle!'&&this.shouldIdle())return;ha++;ga.stateId=ha;clearTimeout(this._deferredTransition);this._deferredTransition=null;this.transport.enterState('idle');this.state='idle';this.nextState=null;if(/!$/.test(qa)){var ua=this._transportRate.tally().timeAverage,va=da.getConfig('MAX_CHANNEL_STATES_PER_SEC',1);if(ua>=va){if(!this._throttled){this._throttled=true;ea.warn('throttled');}ea.bump('throttle');ra=1000/va;}}else if(!(/#$/.test(qa)))ra=this._getDelay();qa=qa.replace(/\W*$/,'');if(!fa[qa])throw new Error('invalid state:'+qa);var wa;if(ra<=0){wa={state:qa};this._transportRate.add(1);this.state=qa;var xa=this['_enter_'+this.state];if(xa){ta.shift();xa.apply(this,ta);}if(/init|idle|pull|ping/.test(this.state)){if(ga.streamingCapable&&/pull/.test(this.state))this.heartbeats=[];this.transport.enterState(this.state,ga);if(this.state=='ping'){wa.url=l.getURI(ga).toString();wa.port=ga.port||'undefined';}}}else{this.state='idle';this.nextState=qa;wa={state:this.state,delay:ra,nextState:qa};ta[0]=qa+'#';this._deferredTransition=(function(){this._deferredTransition=null;this.enterState.apply(this,ta);}).bind(this).defer(ra,false);}if(/pull/.test(qa)){wa.client_id=ga.sessionID;wa.streaming=ga.inStreaming;}ea.log('enter_'+this.state,wa);h.inform(j.ON_ENTER_STATE,wa);},exitState:function(qa,ra){var sa=qa.stateId,ta=qa.status;if(this.isShutdown()||sa<ha)return;var ua=aa(arguments),va=this.state;ua[0]=qa.status;var wa={state:va,status:ta};if(/pull/.test(va)){wa.client_id=ga.sessionID;wa.streaming=ga.inStreaming;}if(this.nextState)wa.nextState=this.nextState;if(ra&&ra.errorType){wa.xhr=ra.toJSON?ra.toJSON():ra;delete wa.xhr.json;}if(ra&&ra.json){if(ra.json.t)wa.t=ra.json.t;if(ra.json.reason)wa.reason=ra.json.reason;if(ra.json.seq)wa.seq=ra.json.seq;}ea.log('exit_'+va,wa);h.inform(j.ON_EXIT_STATE,wa);var xa=this['_exit_'+va];if(xa)ta=xa.apply(this,ua)||ta;if(ta!=j.OK){pa();ia[va]=(ia[va]||0)+1;}var ya=fa[this.nextState||va][ta]||fa._all[ta],za=ya&&ya.replace(/!*$/,'');if(!za){ea.error('terminal_transition',wa);this._shutdownHint=j.HINT_INVALID_STATE;ya='shutdown!';}this._lastState=va;this._lastStatus=ta;this.enterState(ya);},_processTransportData:function(qa,ra){var sa=ra.json,ta=sa.t;if('s' in sa){sa.seq=sa.s;delete sa.s;}var ua=ga.seq;if('seq' in sa){ga.seq=sa.seq;s.doSync();}switch(ta){case 'continue':if(ga.inStreaming&&this.heartbeats.length<1){ga.streamingCapable=false;ea.log('switch_to_longpoll');setTimeout(this._probeTest,ga.PROBE_DELAY,false);}pa(true);if(!ga.inStreaming||ga.STREAMING_EXIT_STATE_ON_CONTINUE)this.exitState({status:j.OK,stateId:qa});break;case 'refresh':case 'refreshDelay':this.exitState({status:'refresh_'+(sa.reason||0),stateId:qa},ra);break;case 'fullReload':r.clear();ea.log('invalid_history');h.inform(j.ON_INVALID_HISTORY);this.exitState({status:j.ERROR_MISSING,stateId:qa},ra);break;case 'msg':var va,wa,xa,ya;pa(true);wa=sa.ms;xa=ga.seq-wa.length;for(va=0;va<wa.length;va++,xa++)if(xa>=ua){ya=wa[va];if(ya.type){ea.debug(ya.type);h.inform(j.getArbiterType(ya.type),{obj:ya});}}else ea.warn('seq_regression',{seq:xa,last_seq:ua,messages:wa.length});break;case 'heartbeat':if(ga.inStreaming){var za=Date.now();if(this.heartbeats.length>0){var ab=za-this.heartbeats[this.heartbeats.length-1];ea.log('heartbeat_interval',{client_id:ga.sessionID,interval:ab});}this.heartbeats.push(za);}break;default:ea.error('unknown_msg_type',{type:ta});break;}},_enter_init:function(){if(ia.init>=da.getConfig('MAX_INIT_FAILS',2))return this.exitState.bind(this,{status:j.ERROR_MAX,stateId:ha}).defer();this._initTimer=this.exitState.bind(this,{status:j.ERROR,stateId:ha},'timeout').defer(ga.IFRAME_LOAD_TIMEOUT,false);},_enter_reconnect:function(qa){var ra=ha;if(!t.hasUserCookie()){ea.warn('no_user_cookie');(function(){da._shutdownHint=j.HINT_AUTH;da.exitState({status:j.ERROR_SHUTDOWN,stateId:ra});}).defer();return;}var sa={reason:qa,fb_dtsg:n.fb_dtsg};if(n.fb_isb)sa.fb_isb=n.fb_isb;var ta=new o('GET','/ajax/presence/reconnect.php',sa);ta.onSuccess=(function(){da.configure(ta.json);r.store();this.exitState({status:j.OK,stateId:ra});}).bind(this);ta.onError=(function(){var ua=ta.json&&ta.json.error;if(ta.errorType==g.TRANSPORT_ERROR||ta.errorType==g.PROXY_ERROR)this._shutdownHint=j.HINT_CONN;if(ua&&ua==1356007){this._shutdownHint=j.HINT_MAINT;}else if(ua==1357001||ua==1357004||ua==1348009){this._shutdownHint=j.HINT_AUTH;}else this._shutdownHint=null;this.exitState({status:this._shutdownHint?j.ERROR_SHUTDOWN:j.ERROR,stateId:ra},ta);}).bind(this);ta.send();},_enter_shutdown:function(){h.inform(j.ON_SHUTDOWN,{reason:this._shutdownHint});},_exit_init:function(qa){if(this._initTimer)this._initTimer=clearTimeout(this._initTimer);if(qa==j.ERROR_MAX)this._sendIframeError(j.reason_IFrameLoadGiveUp);},_exit_pull:function(qa){if(qa==j.OK)this.lastPullTime=Date.now();},_exit_ping:function(qa){if(qa==j.OK){var ra=Date.now()-(this.lastPullTime||n.start);if(ra>ga.STALL_THRESHOLD)return j.ERROR_STALE;}},_probeTest:function(){ga.streamingCapable=false;var qa=[],ra={mode:'stream',format:'json'},sa=new w('/probe').setDomain(ga.host+'.facebook.com').setPort(ga.port).setSecure(w().isSecure()).setQueryData(ra),ta=new g('GET',sa);ta.onJSON=function(ua,va){if(ua&&ua.json&&ua.json.t==='heartbeat'){qa.push(Date.now());if(qa.length>=2){var wa=qa[1]-qa[0];if(wa>=ga.PROBE_HEARTBEATS_INTERVAL_LOW&&wa<=ga.PROBE_HEARTBEATS_INTERVAL_HIGH){ga.streamingCapable=true;ea.log('switch_to_streaming');}ea.log('probe_ok',{time:wa});}}};ta.onSuccess=function(ua){if(qa.length!=2){ga.streamingCapable=false;ea.error('probe_error',{error:'beats.length = '+qa.length});}};ta.onError=function(ua){ga.streamingCapable=false;ea.error('probe_error',ua);};ea.log('probe_request');ta.send();}};e.exports=da;if(ca.serverInitialized==null){da.configure(ca.channelConfig);if(/shutdown/.test(ca.state)){da._shutdownHint=j[ca.reason];}else ca.reconnectReason;da.init(ca.state,ca.reason);}});
__d("ChannelConnection",["Arbiter","copyProperties","ChatConfig","Run","SystemEvents","ChannelConstants","ChannelManager","JSLogger"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ChatConfig'),j=b('Run'),k=b('SystemEvents'),l=b('ChannelConstants'),m=b('ChannelManager'),n=b('JSLogger'),o=n.create('channel_connection'),p=null,q=null,r=null,s=null,t=0,u=h(new g(),{CONNECTED:'chat-connection/connected',RECONNECTING:'chat-connection/reconnecting',SHUTDOWN:'chat-connection/shutdown',MUTE_WARNING:'chat-connection/mute',UNMUTE_WARNING:'chat-connection/unmute'});function v(){if(q){clearTimeout(q);q=null;}}function w(){v();o.log('unmute_warning');u.inform(u.UNMUTE_WARNING);}function x(ba){v();q=w.defer(ba,false);o.log('mute_warning',{time:ba});u.inform(u.MUTE_WARNING);}function y(){if(r){clearTimeout(r);r=null;}}function z(ba,ca){y();if(ba===l.ON_ENTER_STATE&&(ca.nextState||ca.state)==='pull'){if(s!==u.CONNECTED){o.log('connected');var da=!s;s=u.CONNECTED;t=0;u.inform(u.CONNECTED,{init:da});}}else if(ba===l.ON_ENTER_STATE&&((ca.nextState||ca.state)==='ping'||(!ca.nextState&&ca.state==='idle'))){r=(function(){var ea=null;if(!(ca.state==='idle'&&!ca.nextState))ea=(ca.delay||0);o.log('reconnecting',{delay:ea});if(u.disconnected())o.log('reconnecting_ui',{delay:ea});s=u.RECONNECTING;(ca.state==='idle')&&t++;if(t>1){u.inform(u.RECONNECTING,ea);}else if(!ca.nextState&&ca.state==='idle')z(ba,ca);}).defer(500,false);}else if(ba===l.ON_SHUTDOWN){o.log('shutdown',{reason:ca.reason});s=u.SHUTDOWN;t=0;u.inform(u.SHUTDOWN,ca.reason);}}function aa(ba){if(m.state==='ping'||m.isShutdown())return;o.log('reconnect',{now:ba});u.inform(u.RECONNECTING,0);if(!!ba){if(p!==null){clearTimeout(p);p=null;}m.enterState('ping!');}else if(!p)p=setTimeout(function(){m.enterState('ping!');p=null;},i.get('channel_manual_reconnect_defer_msec'),false);}if(m.isShutdown()){z(l.ON_SHUTDOWN,m._shutdownHint);}else z(l.ON_ENTER_STATE,{state:m.state,nextState:m.nextState,delay:0});g.subscribe([l.ON_ENTER_STATE,l.ON_SHUTDOWN],z);k.subscribe(k.TIME_TRAVEL,function(){aa();x(i.get('mute_warning_time_msec'));});j.onBeforeUnload(y,false);h(u,{disconnected:function(){return s===u.SHUTDOWN||(s===u.RECONNECTING&&!q&&t>1);},isShutdown:function(){return s===u.SHUTDOWN;},reconnect:aa,unmuteWarning:w});e.exports=u;});
__d("CacheStorage",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties'),h={localstorage:i};function i(){this._store=a.localStorage;}i.available=function(){return !!a.localStorage;};g(i.prototype,{keys:function(){var k=[];for(var l=0;l<this._store.length;l++)k.push(this._store.key(l));return k;},get:function(k){return this._store.getItem(k);},set:function(k,l){this._store.setItem(k,l);},remove:function(k){this._store.removeItem(k);},clear:function(){this._store.clear();}});function j(k,l){this._key_prefix=l||'_cs_';this._magic_prefix='_@_';if(k=='AUTO')for(var m in h){var n=h[m];if(n.available()){k=m;break;}}if(k)if(!h[k]||!h[k].available()){this._backend=null;}else this._backend=new h[k]();this._memcache={};}g(j.prototype,{keys:function(){var k=[];if(this._backend){var l=this._backend.keys();for(var m=0;m<l.length;m++)if(l[m].substr(0,this._key_prefix.length)==this._key_prefix)k.push(l[m].substr(this._key_prefix.length));return k;}for(var n in this._memcache)k.push(n);return k;},set:function(k,l){this._memcache[k]=l;if(this._backend){if(typeof l=='string'){l=this._magic_prefix+l;}else l=JSON.stringify(l);this._backend.set(this._key_prefix+k,l);}},get:function(k,l){if(this._memcache[k]!==undefined)return this._memcache[k];var m;if(this._backend){m=this._backend.get(this._key_prefix+k);if(m!==null){if(m.substr(0,this._magic_prefix.length)==this._magic_prefix){m=m.substr(this._magic_prefix.length);}else try{m=JSON.parse(m);}catch(n){m=undefined;}if(m!==undefined)this._memcache[k]=m;}else m=undefined;}if(m===undefined&&l!==undefined){m=l;this._memcache[k]=m;if(this._backend){var o;if(typeof m=='string'){o=this._magic_prefix+m;}else o=JSON.stringify(m);this._backend.set(this._key_prefix+k,o);}}return m;},remove:function(k){delete this._memcache[k];if(this._backend)this._backend.remove(this._key_prefix+k);}});e.exports=j;});
__d("FBDesktopPlugin",["CacheStorage","DOM","Env","FBDesktopDetect","HTML","URI","$"],function(a,b,c,d,e,f){var g=b('CacheStorage'),h=b('DOM'),i=b('Env'),j=b('FBDesktopDetect'),k=b('HTML'),l=b('URI'),m=b('$'),n=new g('localstorage','_socialfox_'),o={_plugin:'_not_checked',arbiterInform:function(p,q){var r=JSON.stringify({name:p,payload:q});this._transmitCommand('arbiterinform',r);},bringToFront:function(){this._transmitCommand('bringtofront');},dock:function(){this._transmitCommand('dock');},getPlugin:function(){if(this._plugin==='_not_checked'){this._plugin=null;if(j.isPluginInstalled()){var p=h.create('div');document.body.appendChild(p);h.setContent(p,k('<object id="kiwi_plugin" '+'type="'+j.mimeType+'" width="0" height="0">'+'</object>'));this._plugin=m('kiwi_plugin');}}return this._plugin;},getUserID:function(){var p=this.getPlugin();return p&&'getUserID' in p&&p.getUserID();},isAppRunning:function(){var p=this.getPlugin();return p&&'isAppRunning' in p&&p.isAppRunning();},launchApp:function(){var p=this.getPlugin();return p&&'launchApp' in p&&p.launchApp();},logout:function(p){p=p||"0";var q=this.getPlugin();if(q)q.logout(p);},recheck:function(){if(this._plugin===null)this._plugin='_not_checked';},shouldSuppressBeeper:function(){return this.isAppRunning();},shouldSuppressMessages:function(){var p=this.getUserID();if(p){return p===i.user;}else return this.isAppRunning();},shouldSuppressSidebar:function(){var p=this.getPlugin(),q=p&&'isAppDocked' in p&&p.isAppDocked(),r=n&&n.get('active')==='true';return q||r;},transferAuthToken:function(p,q){if(p&&p.length>0){var r=this.getPlugin();if(r){r.setAccessToken(p,q);var s=setInterval(function(){r.setAccessToken(p,q);},500);setTimeout(function(){clearInterval(s);},10*1000);}}if(this.redirectHome)window.location.href=l().setPath().toString();},_transmitCommand:function(p,q){q=q||'';var r=this.getPlugin();if(r&&'transmitCommand' in r)r.transmitCommand(p,q);}};e.exports=o;});
__d("CallbackManagerController",["ErrorUtils","copyProperties"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h=b('copyProperties'),i=function(j){this._pendingIDs=[];this._allRequests=[undefined];this._callbackArgHandler=j;};h(i.prototype,{executeOrEnqueue:function(j,k,l){l=l||{};var m=this._attemptCallback(k,j,l);if(m)return 0;this._allRequests.push({fn:k,request:j,options:l});var n=this._allRequests.length-1;this._pendingIDs.push(n);return n;},unsubscribe:function(j){delete this._allRequests[j];},getRequest:function(j){return this._allRequests[j];},runPossibleCallbacks:function(){var j=this._pendingIDs;this._pendingIDs=[];var k=[];j.forEach(function(l){var m=this._allRequests[l];if(!m)return;if(this._callbackArgHandler(m.request,m.options)){k.push(l);}else this._pendingIDs.push(l);}.bind(this));k.forEach(function(l){var m=this._allRequests[l];delete this._allRequests[l];this._attemptCallback(m.fn,m.request,m.options);}.bind(this));},_attemptCallback:function(j,k,l){var m=this._callbackArgHandler(k,l);if(m){var n={ids:k};g.applyWithGuard(j,n,[m]);}return !!m;}});e.exports=i;});
__d("KeyedCallbackManager",["CallbackManagerController","copyProperties"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=function(){this._resources={};this._controller=new g(this._constructCallbackArg.bind(this));};h(i.prototype,{executeOrEnqueue:function(j,k){if(!(j instanceof Array)){var l=j,m=k;j=[j];k=function(n){m(n[l]);};}return this._controller.executeOrEnqueue(j,k);},unsubscribe:function(j){this._controller.unsubscribe(j);},getUnavailableResources:function(j){var k=this._controller.getRequest(j),l=[];if(k)l=k.request.filter(function(m){return !this._resources[m];}.bind(this));return l;},addResourcesAndExecute:function(j){h(this._resources,j);this._controller.runPossibleCallbacks();},setResource:function(j,k){this._resources[j]=k;this._controller.runPossibleCallbacks();},getResource:function(j){return this._resources[j];},getAllResources:function(){return this._resources;},dumpResources:function(){var j={};for(var k in this._resources){var l=this._resources[k];if(typeof l==='object')l=h({},l);j[k]=l;}return j;},_constructCallbackArg:function(j){var k={};for(var l=0;l<j.length;l++){var m=j[l],n=this._resources[m];if(typeof n=='undefined')return false;k[m]=n;}return k;}});e.exports=i;});
__d("AsyncLoader",["AsyncRequest","KeyedCallbackManager","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('KeyedCallbackManager'),i=b('copyProperties'),j={};function k(m,n){var o=new h(),p=false,q=[];function r(){if(!q.length||p)return;p=true;t.defer();}function s(w){p=false;w.forEach(o.unsubscribe.bind(o));r();}function t(){var w={},x=[];q=q.filter(function(z){var aa=o.getUnavailableResources(z);if(aa.length){aa.forEach(function(ba){w[ba]=true;});x.push(z);return true;}return false;});var y=Object.keys(w);if(y.length){new g(m).setData({ids:y}).setHandler(u.curry(x)).setErrorHandler(v.curry(x)).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}else p=false;}function u(w,x){var y=x.payload[n]||x.payload;o.addResourcesAndExecute(y);s(w);}function v(w){s(w);}return {get:function(w,x){var y=o.executeOrEnqueue(w,x),z=o.getUnavailableResources(y);if(z.length){q.push(y);r();}},getCachedKeys:function(){return Object.keys(o.getAllResources());},getNow:function(w){return o.getResource(w)||null;},set:function(w){o.addResourcesAndExecute(w);}};}function l(m,n){this._endpoint=m;this._type=n;}i(l.prototype,{_getLoader:function(){if(!j[this._endpoint])j[this._endpoint]=k(this._endpoint,this._type);return j[this._endpoint];},get:function(m,n){return this._getLoader().get(m,n);},getCachedKeys:function(){return this._getLoader().getCachedKeys();},getNow:function(m){return this._getLoader().getNow(m);},reset:function(){j[this._endpoint]=null;},set:function(m){this._getLoader().set(m);}});e.exports=l;});
__d("RangedCallbackManager",["CallbackManagerController","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=b('createObjectFrom'),j=function(k,l,m){this._resources=[];this._reachedEndOfArray=false;this._existingIDs={};this._controller=new g(this._constructCallbackArg.bind(this));this._getValueHandler=k;this._compareValuesHandler=l;this._skipOnStrictHandler=m;};h(j.prototype,{executeOrEnqueue:function(k,l,m,n){return this._controller.executeOrEnqueue({start:k,limit:l},m,{strict:!!n});},unsubscribe:function(k){this._controller.unsubscribe(k);},getUnavailableResources:function(k){var l=this._controller.getRequest(k),m=[];if(l&&!this._reachedEndOfArray){var n=l.request,o=this._filterForStrictResults(l.options),p=n.start+n.limit;for(var q=o.length;q<p;q++)m.push(q);}return m;},addResources:function(k){k.forEach(function(l){if(!this._existingIDs[l]){this._existingIDs[l]=true;this._resources.push(l);}}.bind(this));this.resortResources();this._controller.runPossibleCallbacks();},addResourcesWithoutSorting:function(k,l){var m=this._resources.slice(0,l);m=m.concat(k);m=m.concat(this._resources.slice(l));this._resources=m;h(this._existingIDs,i(k,true));this._controller.runPossibleCallbacks();},removeResources:function(k){k.forEach(function(l){if(this._existingIDs[l]){this._existingIDs[l]=false;this._resources.remove(l);}}.bind(this));},removeAllResources:function(){this._resources=[];this._existingIDs={};},resortResources:function(){this._resources=this._resources.sort(function(k,l){return this._compareValuesHandler(this._getValueHandler(k),this._getValueHandler(l));}.bind(this));},setReachedEndOfArray:function(){if(!this._reachedEndOfArray){this._reachedEndOfArray=true;this._controller.runPossibleCallbacks();}},hasReachedEndOfArray:function(){return this._reachedEndOfArray;},hasResource:function(k){return this._existingIDs[k];},getResourceAtIndex:function(k){return this._resources[k];},getAllResources:function(){return this._resources.concat();},getCurrentArraySize:function(){return this._resources.length;},_filterForStrictResults:function(k){var l=this._resources;if(k&&k.strict&&this._skipOnStrictHandler)l=l.filter(this._skipOnStrictHandler);return l;},_constructCallbackArg:function(k,l){var m=this._filterForStrictResults(l);if(!this._reachedEndOfArray&&k.start+k.limit>m.length){return false;}else return m.slice(k.start,k.start+k.limit);},getElementsUntil:function(k){var l=[];for(var m=0;m<this._resources.length;m++){var n=this._getValueHandler(this._resources[m]);if(this._compareValuesHandler(n,k)>0)break;l.push(this._resources[m]);}return l;}});e.exports=j;});
__d("Poller",["AsyncRequest","Cookie","copyProperties","Env"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('Cookie'),i=b('copyProperties'),j=b('Env');function k(l,m,n){this._clearOnQuicklingEvent=!n;this._requestCallback=m;this.setTimePeriod(l);}k.MIN_TIME_PERIOD=2000;i(k.prototype,{stop:function(){clearTimeout(this._token);this._token=null;this._cancelRequest();},scheduleRequest:function(){this.stop();if(this._timePeriod)this._token=this._makeRequest.bind(this).defer(this._timePeriod,this._clearOnQuicklingEvent);},requestNow:function(){this.stop();this._makeRequest();},_timePeriod:null,setTimePeriod:function(l){l=l||null;if(l&&(isNaN(l)||l<k.MIN_TIME_PERIOD))return;if(l&&this._timePeriod==null)this._token=this._makeRequest.bind(this).defer(l,this._clearOnQuicklingEvents);this._timePeriod=l;},_makeRequest:function(){this._cancelRequest();if(!this._isLoadUser())return;var l=new g(),m=true;l.setInitialHandler(function(){return m;});this._cancelRequest=function(){m=false;};l.setFinallyHandler(this.scheduleRequest.bind(this));l.setInitialHandler=bagofholding;l.setFinallyHandler=bagofholding;this._requestCallback(l);if(m)l.send();},_isLoadUser:function(){return j.user==h.get('c_user');},_cancelRequest:bagofholding,getTimePeriod:function(){return this._timePeriod;}});e.exports=k;});
__d("ChatBehavior",["Arbiter","AvailableList","AvailableListConstants","copyProperties","MercuryConstants","ChatSidebarCalloutData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('copyProperties'),k=c('MercuryConstants').ChatNotificationConstants,l=c('ChatSidebarCalloutData').isShown,m=h.getWebChatNotification(),n=l,o=j(new g(),{ON_CHANGED:'changed',notifiesUserMessages:function(){return m!==k.NO_USER_MESSAGE_NOTIFICATION;},ignoresRemoteTabRaise:function(){return n;}});function p(){o.inform(o.ON_CHANGED);}h.subscribe(i.ON_CHAT_NOTIFICATION_CHANGED,function(){var q=m,r=h.getWebChatNotification();m=r;if(q!=r)p();});g.subscribe('chat/set_does_page_occlude_tabs',function(q,r){n=!!r;p();});e.exports=o;});
__d("MercuryServerDispatcher",["AsyncRequest","JSLogger","URI","areObjectsEqual","copyProperties","debounceAcrossTransitions"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('JSLogger'),i=b('URI'),j=b('areObjectsEqual'),k=b('copyProperties'),l=b('debounceAcrossTransitions'),m={},n=h.create('mercury_dispatcher'),o=false,p={IMMEDIATE:'immediate',IDEMPOTENT:'idempotent',BATCH_SUCCESSIVE:'batch-successive',BATCH_SUCCESSIVE_UNIQUE:'batch-successive-unique',BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR:'batch-successive-piggyback-retry',BATCH_DEFERRED_MULTI:'batch-deferred-multi',BATCH_CONDITIONAL:'batch-conditional',registerEndpoints:function(r){for(var s in r){var t=r[s];m[s]=new q(s,t);}},trySend:function(r,s,t){m[r].trySend(s,t);}};function q(r,s){var t=s.mode||p.IMMEDIATE;switch(t){case p.IMMEDIATE:case p.IDEMPOTENT:case p.BATCH_SUCCESSIVE:case p.BATCH_SUCCESSIVE_UNIQUE:case p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR:case p.BATCH_DEFERRED_MULTI:case p.BATCH_CONDITIONAL:break;default:throw new Error('Invalid MercuryServerDispatcher mode '+t);}this._endpoint=r;this._mode=t;this._combineData=s.batch_function;this._combineDataIf=s.batch_if;this._handler=s.handler;this._errorHandler=s.error_handler;this._transportErrorHandler=s.transport_error_handler||s.error_handler;this._deferredSend=l(this._batchSend,0,this);}k(q.prototype,{_inFlight:0,_handler:null,_errorHandler:null,_transportErrorHandler:null,_combineData:null,_pendingRequestData:null,trySend:function(r,s){if(o)return;if(typeof r=='undefined')r=null;var t=s||this._mode;if(t==p.IMMEDIATE){this._send(r);}else if(t==p.IDEMPOTENT){if(!this._inFlight)this._send(r);}else if(t==p.BATCH_SUCCESSIVE||t==p.BATCH_SUCCESSIVE_UNIQUE){if(!this._inFlight){this._send(r);}else this._batchData(r);}else if(t==p.BATCH_CONDITIONAL){if(this._inFlight&&(this._combineDataIf(this._pendingRequestData,r)||this._combineDataIf(this._batchedData,r))){this._batchData(r);}else this._send(r);}else if(t==p.BATCH_DEFERRED_MULTI){this._batchData(r);this._deferredSend();}else if(t==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR){this._batchData(r);if(!this._inFlight)this._batchSend();}},_send:function(r){this._inFlight++;this._pendingRequestData=k({},r);n.log('send',{endpoint:this._endpoint,data:r,inflight_count:this._inFlight});new g(this._endpoint).setData(r).setHandler(this._handleResponse.bind(this)).setErrorHandler(this._handleError.bind(this)).setTransportErrorHandler(this._handleTransportError.bind(this)).setAllowCrossPageTransition(true).send();},_batchData:function(r){if(this._mode==p.BATCH_SUCCESSIVE_UNIQUE&&this._pendingRequestData&&j(r,this._pendingRequestData)){return;}else if(typeof this._batchedData=='undefined'){this._batchedData=r;}else this._batchedData=this._combineData(this._batchedData,r);},_batchSend:function(){if(typeof this._batchedData!='undefined'){this._send(this._batchedData);delete this._batchedData;}},_handleResponse:function(r){this._inFlight--;n.log('response',{endpoint:this._endpoint,inflight_count:this._inFlight});var s=r.getPayload();o=s&&s.kill_chat;if(o)n.log('killswitch_enabled',{endpoint:this._endpoint,inflight_count:this._inFlight});if(s&&s.error_payload){if(this._errorHandler)this._errorHandler(r);}else this._handler&&this._handler(s);if(this._mode==p.BATCH_SUCCESSIVE||this._mode==p.BATCH_SUCCESSIVE_UNIQUE||this._mode==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR||this._mode==p.BATCH_CONDITIONAL)this._batchSend();this._pendingRequestData=null;},_handleErrorCommon:function(r,s){n.error('error',{endpoint:this._endpoint,inflight_count:this._inFlight-1});s&&s(r);this._inFlight--;var t=this._mode;if(t==p.BATCH_SUCCESSIVE||t==p.BATCH_SUCCESSIVE_UNIQUE||t==p.BATCH_CONDITIONAL){this._batchSend();}else if(t==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR)if(typeof this._batchedData=='undefined'){this._batchedData=this._pendingRequestData;}else{this._batchedData=this._combineData(this._pendingRequestData,this._batchedData);this._batchSend();}this._pendingRequestData=null;},_handleError:function(r){this._handleErrorCommon(r,this._errorHandler);},_handleTransportError:function(r){this._handleErrorCommon(r,this._transportErrorHandler);}});e.exports=p;});
__d("setTimeoutAcrossTransitions",[],function(a,b,c,d,e,f){function g(h,i){return setTimeout(h,i,false);}e.exports=g;});
__d("MessagingReliabilityLogger",["function-extensions","AsyncRequest","copyProperties","isEmpty","PresenceUtil","Run","MercuryServerDispatcher","setTimeoutAcrossTransitions","MessagingReliabilityLoggerInitialData"],function(a,b,c,d,e,f){b('function-extensions');var g=b('AsyncRequest'),h=b('copyProperties'),i=b('isEmpty'),j=b('PresenceUtil'),k=b('Run'),l=b('MercuryServerDispatcher'),m=b('setTimeoutAcrossTransitions'),n=c('MessagingReliabilityLoggerInitialData'),o='/ajax/mercury/client_reliability.php',p=60000;function q(w,x){var y={app:n.app,categories:JSON.stringify(w)};if(!i(x))y.extra=JSON.stringify(x);return y;}function r(w,x,y,z){if(w[x]===undefined)w[x]={};if(w[x][y]===undefined)w[x][y]=0;w[x][y]+=z;}function s(w,x,y,z){if(w[x]===undefined)w[x]={};if(w[x][y]===undefined)w[x][y]=[];for(var aa=0;aa<z.length;++aa)w[x][y].push(z[aa]);}function t(w,x){if(!w.categories||!x.categories)return;var y=JSON.parse(w.categories),z=w.extra?JSON.parse(w.extra):{},aa=JSON.parse(x.categories),ba=x.extra?JSON.parse(x.extra):{};for(var ca in aa){var da=aa[ca],ea=ba[ca];for(var fa in da){r(y,ca,fa,da[fa]);if(ea!==undefined){var ga=ea[fa];if(ga!==undefined)s(z,ca,fa,ga);}}}return q(y,z);}var u={};u[o]={mode:l.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:t};l.registerEndpoints(u);var v={addEntry:function(w,x,y){if(!n.enabled)return;var z={};r(z,w,x,1);var aa={};if(y!==undefined)s(aa,w,x,[y]);l.trySend(o,q(z,aa));}};(function w(){v.addEntry('page_event','active',j.getSessionID());m(w,p);})();e.exports=v;});
__d("MercuryIDs",[],function(a,b,c,d,e,f){function g(h){return typeof h==='string'&&h.indexOf(':')!==-1;}e.exports={isValid:function(h){if(!h)return false;return g(h);},tokenize:function(h){if(!this.isValid(h))throw 'bad_id_format';var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};}};});
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f){var g=b('MercuryIDs');e.exports={isParticipantID:function(h){if(!g.isValid(h))throw 'bad_participant_id';},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw 'bad_user_id';},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw 'bad_email_id';},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw 'bad_thread_id';}};});
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;});
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f){var g=b('KeyedCallbackManager'),h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;});
__d("MercuryThreadInformer",["Arbiter","copyProperties","MercuryAssert"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('MercuryAssert'),j={},k={},l={},m=false,n=false,o=false,p={},q={},r={},s=0;function t(){if(!s){var v=j,w=k,x=l,y=m,z=n,aa=o,ba=p,ca=q,da=r;j={};k={};l={};m=false;n=false;o=false;p={};q={};r={};var ea=Object.keys(w);if(ea.length||y)u.inform('threadlist-updated',ea);if(ea.length)u.inform('threads-updated',w);for(var fa in x){u.inform('thread-read-changed',x);break;}for(var fa in v){u.inform('threads-deleted',v);break;}if(z)u.inform('unseen-updated',null);if(aa)u.inform('unread-updated',null);for(fa in ba){u.inform('messages-received',ba);break;}for(fa in ca){u.inform('messages-reordered',ca);break;}for(fa in da){u.inform('messages-updated',da);break;}}}var u=h(new g(),{updatedThread:function(v){k[v]=true;t();},deletedThread:function(v){j[v]=true;t();},updatedThreadlist:function(){m=true;t();},updatedUnseenState:function(){n=true;t();},updatedUnreadState:function(){o=true;t();},changedThreadReadState:function(v,w,x){if(!l[v]||l[v].timestamp<x)l[v]={mark_as_read:w,timestamp:x};t();},receivedMessage:function(v){i.isThreadID(v.thread_id);var w=v.thread_id;if(!p[w])p[w]=[];p[w].push(v);this.updatedThread(w);},reorderedMessages:function(v,w){q[v]={source:w};t();},updatedMessage:function(v,w,x){if(!r[v])r[v]={};r[v][w]={source:x};t();},synchronizeInforms:function(v){s++;try{v();}catch(w){throw w;}finally{s--;t();}},listen:function(v,w){return this.subscribe('threads-updated',function(x,y){if(y[v])w(v);});}});e.exports=u;});
__d("MercuryServerRequests",["Arbiter","AsyncResponse","KeyedCallbackManager","TimestampConverter","copyProperties","Env","JSLogger","MercuryAssert","MercuryMessageIDs","MercuryServerDispatcher","MercuryThreadInformer","MercuryIDs","MessagingReliabilityLogger","createObjectFrom","hasArrayNature","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncResponse'),i=b('KeyedCallbackManager'),j=b('TimestampConverter'),k=b('copyProperties'),l=b('Env'),m=b('JSLogger'),n=b('MercuryAssert'),o=b('MercuryMessageIDs'),p=b('MercuryServerDispatcher'),q=b('MercuryThreadInformer'),r=b('MercuryIDs'),s=b('MessagingReliabilityLogger'),t=b('createObjectFrom'),u=b('hasArrayNature'),v=c('MercuryConstants'),w=v.MercuryGenericConstants,x=0,y=m.create('mercury_server'),z=new i(),aa=new i(),ba=[],ca={},da={};function ea(ab){if(ab)x=j.maxValidActionID(x,ab);}function fa(ab){var bb=ab.thread_id,cb=z.getResource(bb);if(!cb){if(ab.is_canonical){if(ab.canonical_fbid===undefined){var db=ab.participants.filter(function(fb){return fb!='fbid:'+l.user;});if(db.length){var eb=r.tokenize(db[0]);if(eb.type=='email'){ab.canonical_email=eb.value;}else ab.canonical_fbid=eb.value;}else ab.canonical_fbid=l.user;}cb=ab.canonical_fbid?'user:'+ab.canonical_fbid:'email:'+ab.canonical_email;}else if(ab.is_canonical_group){cb='group:'+ab.group_id;}else if(ab.root_message_threading_id)cb='root:'+ab.root_message_threading_id;cb=cb||'thread:'+bb;ga(bb,cb);}ab.thread_id=cb;}function ga(ab,bb){z.setResource(ab,bb);aa.setResource(bb,ab);da[ab]=bb;}function ha(ab,bb){var cb=aa.executeOrEnqueue(ab,bb),db=aa.getUnavailableResources(cb),eb=xa.tokenizeThreadID(ab);if(db.length&&eb.type!='root')xa.fetchThreadData(db);}function ia(ab){return aa.getResource(ab);}function ja(ab){return !!z.getResource(ab);}function ka(ab){var bb=z.getResource(ab);if(typeof bb=='undefined')y.warn('no_client_thread_id',{server_id:ab});return bb;}function la(ab,bb){z.executeOrEnqueue(ab,bb);xa.ensureThreadIsFetched(ab);}function ma(ab,bb){if(ab.action_type!=v.MercuryActionType.SEND_MESSAGE)return;var cb=ab.client_thread_id;if(!cb)cb=ka(ab.thread_id);var db=null;if(cb)db=r.tokenize(cb).type;s.addEntry('send_'+db,bb,ab.thread_id+','+ab.message_id);}function na(ab){var bb=null;switch(ab.status){case v.MercuryActionStatus.SUCCESS:bb='success';break;case v.MercuryActionStatus.FAILED_UNKNOWN_REASON:bb='confirmed_error';break;case v.MercuryActionStatus.UNABLE_TO_CONFIRM:bb='confirm_error';break;default:return;}ma(ab,bb);}function oa(ab){(ab.message_counts||[]).forEach(function(jb){ea(jb.last_action_id);});(ab.threads||[]).forEach(function(jb){fa(jb);delete ca[jb.thread_id];delete ca[ia(jb.thread_id)];ea(jb.last_action_id);});(ab.ordered_threadlists||[]).forEach(function(jb){jb.thread_ids=jb.thread_ids.map(ka);});ab.actions=ab.actions||[];ab.actions.forEach(function(jb){na(jb);if(jb.status&&jb.status!=v.MercuryActionStatus.SUCCESS&&!jb.thread_id){jb.thread_id=jb.client_thread_id;return;}if(jb.action_type==v.MercuryActionType.SEND_MESSAGE&&jb.client_thread_id&&jb.client_thread_id!=w.PENDING_THREAD_ID)ga(jb.thread_id,jb.client_thread_id);jb.server_thread_id=jb.thread_id;jb.thread_id=ja(jb.thread_id)?ka(jb.thread_id):null;ea(jb.action_id);});if(ab.end_of_history){var bb=[];for(var cb=0;cb<ab.end_of_history.length;cb++){var db=ab.end_of_history[cb];if(db.type=='user'){bb.push('user:'+db.id);}else if(db.type=='thread'&&ja(db.id))bb.push(ka(db.id));}ab.end_of_history=bb;}if(ab.roger){var eb={};for(var fb in ab.roger){var gb=z.getResource(fb);if(gb){var hb=ab.roger[fb];eb[gb]={};for(var ib in hb)eb[gb]['fbid:'+ib]=hb[ib];}}ab.roger=eb;}}function pa(){if(ba&&ba.length){var ab=ba[0];ba=ba.slice(1);xa.handleUpdate(ab);}}function qa(ab,bb){var cb=k({},ab),db;if(bb.threads){if(!cb.threads)cb.threads={};for(db in bb.threads)cb.threads[db]=Object.keys(t((cb.threads[db]||[]).concat(bb.threads[db])));}if(bb.messages){if(!cb.messages)cb.messages={};for(db in bb.messages){if(!cb.messages[db])cb.messages[db]={};for(var eb in bb.messages[db])if(cb.messages[db][eb]){cb.messages[db][eb]=ta(cb.messages[db][eb],bb.messages[db][eb]);}else cb.messages[db][eb]=bb.messages[db][eb];}}return cb;}function ra(ab,bb){var cb=k(t(ab.folders,true),t(bb.folders,true));return {folders:Object.keys(cb)};}function sa(ab,bb){for(var cb in bb)if(ab[cb]){ab[cb]=ta(ab[cb],bb[cb]);}else{var db={};k(db,bb[cb]);ab[cb]=db;}return ab;}function ta(ab,bb){var cb=ab.offset<bb.offset?ab.offset:bb.offset,db=ab.offset+ab.limit,eb=bb.offset+bb.limit,fb=(db>eb)?db:eb,gb=fb-cb;return {offset:cb,limit:gb};}function ua(ab,bb){var cb={ids:{}};k(cb.ids,ab.ids);k(cb.ids,bb.ids);return cb;}function va(ab,bb){var cb={},db;for(db in ab)k(cb,t(ab[db],db));for(db in bb)k(cb,t(bb[db],db));var eb={};for(var fb in cb){db=cb[fb];if(!eb[db])eb[db]=[];eb[db].push(fb);}return eb;}function wa(ab,bb){var cb=t(ab.ids,true),db=t(bb.ids,true),eb=k(cb,db);return {ids:Object.keys(eb)};}var xa=k(new g(),{tokenizeThreadID:function(ab){n.isThreadID(ab);return r.tokenize(ab);},getServerThreadID:function(ab,bb){n.isThreadID(ab);ha(ab,bb);},getClientThreadID:function(ab,bb){la(ab,bb);},getClientThreadIDNow:function(ab){return ka(ab);},getServerThreadIDNow:function(ab){return ia(ab);},convertThreadIDIfAvailable:function(ab){var bb=z.getResource(ab);if(bb===undefined){return ab;}else return bb;},canLinkExternally:function(ab){n.isThreadID(ab);var bb=xa.tokenizeThreadID(ab);return (bb.type=='user')||!!ia(ab);},fetchThreadlistInfo:function(ab,bb,cb){cb=cb||v.MessagingTag.INBOX;var db={};db[cb]={offset:ab,limit:bb};p.trySend('/ajax/mercury/threadlist_info.php',db);},fetchUnseenThreadIDs:function(ab){this.fetchThreadlistInfo(v.MercuryThreadlistConstants.RECENT_THREAD_OFFSET,v.MercuryThreadlistConstants.JEWEL_THREAD_COUNT,ab);},fetchUnreadThreadIDs:function(ab){p.trySend('/ajax/mercury/unread_threads.php',{folders:[ab]});},fetchMissedMessages:function(ab){p.trySend('/ajax/mercury/thread_sync.php',{last_action_id:x,folders:ab});},fetchThreadData:function(ab){n.allThreadID(ab);var bb={threads:{}},cb=[],db=[],eb=[],fb=[];ab.forEach(function(hb){if(ca[hb])return;ca[hb]=true;var ib=ia(hb);if(ib){db.push(ib);bb.threads.thread_ids=db;}else{var jb=xa.tokenizeThreadID(hb);if(jb.type=='user'){cb.push(jb.value);bb.threads.user_ids=cb;}else if(jb.type=='group'){eb.push(jb.value);bb.threads.group_ids=eb;}else if(jb.type=='thread'){db.push(jb.value);bb.threads.thread_ids=db;}else if(jb.type!='root'&&jb.type!='email'&&jb.type!='pending')throw new Error('Unknown thread type',jb);}});this.inform("fetch-thread-data",bb);for(var gb in bb.threads){p.trySend('/ajax/mercury/thread_info.php',bb);break;}},ensureThreadIsFetched:function(ab){if(!z.getResource(ab)&&!ca[ab]){ca[ab]=true;p.trySend('/ajax/mercury/thread_info.php',{threads:{thread_ids:[ab]}});}},fetchThreadMessages:function(ab,bb,cb,db){n.isThreadID(ab);var eb,fb,gb=xa.tokenizeThreadID(ab),hb=ia(ab),ib=false;if(hb&&gb.type!='group'){fb='thread_ids';eb=hb;}else{eb=gb.value;switch(gb.type){case 'user':fb='user_ids';ib=true;break;case 'group':fb='group_ids';break;case 'thread':fb='thread_ids';break;}}var jb={messages:{},threads:{}};if(fb){jb.messages[fb]={};jb.messages[fb][eb]={offset:bb,limit:cb};if(ib)jb.threads[fb]=[eb];p.trySend('/ajax/mercury/thread_info.php',jb,db);}else ha(ab,function(kb){jb.messages.thread_ids={};jb.messages.thread_ids[kb]={offset:bb,limit:cb};p.trySend('/ajax/mercury/thread_info.php',jb,db);});},handleThreadInfoError:function(ab){var bb=ab.getRequest().getData(),cb=[];if(bb.messages){for(var db in bb.messages.thread_ids)cb.push(ya(ka(db)));for(var eb in bb.messages.user_ids)cb.push(ya('user:'+eb));for(var fb in bb.messages.group_ids)cb.push(ya('group:'+fb));}if(cb.length)xa.handleUpdate({actions:cb,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});if(bb.threads&&(bb.threads.user_ids||bb.threads.group_ids||bb.threads.thread_ids)&&!bb.is_retry){if(bb.messages)delete bb.messages;y.log('retry_thread',bb);bb.is_retry=true;p.trySend('/ajax/mercury/thread_info.php',bb);}},markFolderAsRead:function(ab){p.trySend('/ajax/mercury/mark_folder_as_read.php',{folder:ab});var bb=[{action_type:v.MercuryGlobalActionType.MARK_ALL_READ,action_id:null,folder:ab}];this.handleUpdate({global_actions:bb,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(ab,bb,cb){n.isThreadID(ab);ha(ab,function(eb){var fb={ids:{}};fb.ids[eb]=bb;p.trySend('/ajax/mercury/change_read_status.php',fb);});var db=[{action_type:v.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:ab,mark_as_read:bb,folder:cb}];this.handleUpdate({actions:db,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(ab,bb){n.isThreadID(ab);ha(ab,function(eb){var fb={ids:{}};fb.ids[eb]=bb;p.trySend('/ajax/mercury/change_archived_status.php',fb);});var cb={action_type:v.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ab,archived:bb},db={actions:[cb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(db);},changeThreadFolder:function(ab,bb){n.isThreadID(ab);ha(ab,function(eb){var fb={};fb[bb]=[eb];p.trySend('/ajax/mercury/move_thread.php',fb);});var cb={action_type:v.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:bb},db={actions:[cb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(db);},markThreadSpam:function(ab){n.isThreadID(ab);ha(ab,function(db){p.trySend('/ajax/mercury/mark_spam.php',{id:db});});var bb={action_type:v.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:v.MessagingTag.SPAM},cb={actions:[bb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(cb);},unmarkThreadSpam:function(ab){n.isThreadID(ab);ha(ab,function(db){p.trySend('/ajax/mercury/unmark_spam.php',{id:db});});var bb={action_type:v.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:v.MessagingTag.INBOX},cb={actions:[bb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(cb);},deleteThread:function(ab){n.isThreadID(ab);ha(ab,function(db){var eb={ids:[db]};p.trySend('/ajax/mercury/delete_thread.php',eb);});var bb={action_type:v.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ab},cb={actions:[bb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_DELETE_THREAD};this.handleUpdate(cb);},deleteMessages:function(ab,bb,cb){o.getServerIDs(bb||[],function(eb){p.trySend('/ajax/mercury/delete_messages.php',{message_ids:eb});});var db;if(cb){db={action_type:v.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ab};}else db={action_type:v.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ab,message_ids:bb};this.handleUpdate({actions:[db],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_DELETE_MESSAGES});},clearChat:function(ab,bb,cb){n.isThreadID(ab);p.trySend('/ajax/chat/settings.php',{clear_history_id:bb});var db=[{action_type:v.MercuryActionType.CLEAR_CHAT,action_id:null,thread_id:ab,clear_time:cb}];this.handleUpdate({actions:db,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CLEAR_CHAT});},_batchThreadRead:function(ab,bb){var cb={};k(cb,ab.ids);k(cb,bb.ids);return {ids:cb};},sendNewMessage:function(ab){o.getServerIDs(ab.forward_message_ids||[],function(cb){var db=xa.tokenizeThreadID(ab.thread_id),eb=db.type,fb=k({},ab);fb.forward_message_ids=cb;var gb=ia(ab.thread_id);if((eb=='root'&&db.value==fb.message_id)||(eb=='user')||(ab.thread_id==w.PENDING_THREAD_ID)){fb.client_thread_id=fb.thread_id;fb.thread_id=null;this._sendNewMessageToServer(fb);}else ha(fb.thread_id,function(hb){fb.thread_id=hb;xa._sendNewMessageToServer(fb);});}.bind(this));if(ab.thread_id!=w.PENDING_THREAD_ID){var bb={actions:[k({},ab)],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_SEND_MESSAGE};xa.handleUpdate(bb);}},_sendNewMessageToServer:function(ab){p.trySend('/ajax/mercury/send_messages.php',{message_batch:[ab]});},_batchMessageSend:function(ab,bb){return {message_batch:ab.message_batch.concat(bb.message_batch)};},requestMessageConfirmation:function(ab){var bb={},cb={};for(var db in ab){var eb=ia(db);if(eb){bb[eb]=ab[db];}else{var fb=ab[db];for(var gb=0;gb<fb.length;gb++)cb[fb[gb]]=db;}}var hb=Object.keys(bb),ib=Object.keys(cb);if(hb.length||ib.length)p.trySend('/ajax/mercury/confirm_messages.php',{thread_message_map:bb,local_messages:cb});},handleMessageConfirmError:function(ab){var bb=ab.getRequest().getData().thread_message_map,cb=ab.getRequest().getData().local_messages;if(!bb&&!cb)return;var db=[];for(var eb in bb){var fb=bb[eb];fb.forEach(function(ib){db.push({action_type:v.MercuryActionType.SEND_MESSAGE,client_message_id:ib,message_id:ib,client_thread_id:null,thread_id:eb,status:v.MercuryActionStatus.UNABLE_TO_CONFIRM});});}for(var gb in cb){var hb=cb[gb];db.push({action_type:v.MercuryActionType.SEND_MESSAGE,client_message_id:gb,message_id:gb,client_thread_id:hb,thread_id:null,status:v.MercuryActionStatus.UNABLE_TO_CONFIRM});}if(db.length)this.handleUpdate({actions:db,payload_source:v.MercuryPayloadSource.CLIENT_HANDLE_ERROR});},markSeen:function(){var ab=j.convertActionIDToTimestamp(x);p.trySend('/ajax/mercury/mark_seen.php',{seen_timestamp:ab});},_batchMarkSeen:function(ab,bb){return bb;},handleRoger:function(ab){var bb=ab.tid?z.getResource(ab.tid):('user:'+ab.reader);if(bb){var cb={};cb[bb]={};cb[bb]['fbid:'+ab.reader]=ab.time;this.inform('update-roger',cb);}},handleUpdateWaitForThread:function(ab,bb){var cb=z.getResource(bb);if(cb){xa.handleUpdate(ab);return;}z.executeOrEnqueue(bb,function(){ba.push(ab);});if(!ca[bb]){ca[bb]=true;p.trySend('/ajax/mercury/thread_info.php',{threads:{thread_ids:[bb]}});}},handleUpdate:function(ab){y.debug('handle_update',{payload:ab,from_client:ab.from_client});for(var bb in ab){q.synchronizeInforms(function(){if(!ab.from_client){oa(ab);this.inform('payload-preprocessed',ab);}this.inform('update-thread-ids',da);da={};this.inform('update-participants',ab);this.inform('update-threads',ab);this.inform('update-unread',ab);this.inform('update-threadlist',ab);this.inform('update-messages',ab);this.inform('update-unseen',ab);this.inform('update-typing-state',ab);this.inform('update-roger',ab.roger);this.inform('model-update-completed',null);pa();}.bind(this));break;}},_handleSendMessageErrorCommon:function(ab,bb){var cb=ab.getPayload(),db=ab.getRequest().getData(),eb=db.message_batch;if(!eb){ma({action_type:v.MercuryActionType.SEND_MESSAGE,status:v.MercuryActionStatus.REQUEST_EMPTY_MESSAGE_LIST});return;}var fb,gb=null;if(cb&&cb.error_payload){fb=v.MercuryActionStatus.UNCONFIRMED;gb='send_error';}else{gb=bb==v.MercuryActionStatus.REQUEST_ERROR?'request_error':'transport_error';if(ab.getError())gb+='_'+ab.getError();fb=bb;}var hb=eb.map(function(jb){return {action_type:v.MercuryActionType.SEND_MESSAGE,client_message_id:jb.message_id,message_id:jb.message_id,client_thread_id:jb.client_thread_id,thread_id:jb.thread_id,status:fb};});hb.forEach(function(jb){ma(jb,gb);});var ib={actions:hb,payload_source:v.MercuryPayloadSource.CLIENT_HANDLE_ERROR};this.handleUpdate(ib);},handleSendMessageError:function(ab){if(ab.error===1404074)h.verboseErrorHandler(ab);this._handleSendMessageErrorCommon(ab,v.MercuryActionStatus.REQUEST_ERROR);},handleSendMessageTransportError:function(ab){this._handleSendMessageErrorCommon(ab,v.MercuryActionStatus.TRANSPORT_ERROR);},getLastActionID:function(){return x;}});function ya(ab){return {action_type:v.MercuryActionType.LOG_MESSAGE,thread_id:ab,message_id:ab,timestamp:(new Date()).getTime(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:v.MercurySourceType.UNKNOWN,log_message_type:v.MercuryLogMessageType.SERVER_ERROR,log_message_data:{}};}var za=xa.handleUpdate.bind(xa);p.registerEndpoints({'/ajax/mercury/thread_sync.php':{mode:p.IDEMPOTENT,handler:za},'/ajax/mercury/thread_info.php':{mode:p.BATCH_DEFERRED_MULTI,batch_function:qa,handler:za,error_handler:xa.handleThreadInfoError.bind(xa)},'/ajax/mercury/mark_folder_as_read.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/change_read_status.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchThreadRead,handler:za},'/ajax/mercury/send_messages.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchMessageSend,handler:za,error_handler:xa.handleSendMessageError.bind(xa),transport_error_handler:xa.handleSendMessageTransportError.bind(xa)},'/ajax/mercury/mark_seen.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchMarkSeen,handler:za},'/ajax/mercury/confirm_messages.php':{mode:p.IMMEDIATE,handler:za,error_handler:xa.handleMessageConfirmError.bind(xa)},'/ajax/mercury/threadlist_info.php':{mode:p.BATCH_SUCCESSIVE_UNIQUE,batch_function:sa,handler:za},'/ajax/mercury/mark_spam.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/unmark_spam.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/unread_threads.php':{mode:p.BATCH_SUCCESSIVE_UNIQUE,batch_function:ra,handler:za},'/ajax/chat/settings.php':{mode:p.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{mode:p.BATCH_SUCCESSIVE,batch_function:ua,handler:za},'/ajax/mercury/delete_thread.php':{mode:p.BATCH_SUCCESSIVE,batch_function:wa,handler:za},'/ajax/mercury/delete_messages.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/move_thread.php':{mode:p.BATCH_SUCCESSIVE,batch_function:va,handler:za}});e.exports=xa;});
__d("MercuryParticipants",["Env","JSLogger","MercuryAssert","MercuryIDs","ShortProfiles","MercuryServerRequests","copyProperties","getObjectValues","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Env'),h=b('JSLogger'),i=b('MercuryAssert'),j=b('MercuryIDs'),k=b('ShortProfiles'),l=b('MercuryServerRequests'),m=b('copyProperties'),n=b('getObjectValues'),o=c('MercuryConstants'),p='fbid:'+g.user,q={},r=h.create('mercury_participants'),s=function(v){if(!q[v.id])q[v.id]=m({},v);};function t(v){i.isEmailParticipantID(v);var w=j.tokenize(v),x=w.value;return {gender:o.MercuryParticipantsConstants.UNKNOWN_GENDER,href:null,id:v,image_src:o.MercuryParticipantsConstants.EMAIL_IMAGE,name:x,short_name:x,employee:false,call_promo:false};}var u={user:p,getNow:function(v){return q[v];},get:function(v,w){i.isParticipantID(v);this.getMulti([v],function(x){w(x[v]);});},getMulti:function(v,w){i.allParticipantIDs(v);var x={},y={};v.forEach(function(aa){if(q[aa]){x[aa]=m({},q[aa]);}else{var ba=j.tokenize(aa);if(ba.type=='fbid'){var ca=ba.value;y[aa]=ca;}else if(ba.type=='email')x[aa]=t(aa);}});var z=n(y);if(z.length){k.getMulti(z,function(aa){for(var ba in y){var ca=y[ba],da=aa[ca];x[ba]={gender:da.gender,href:da.uri,id:ba,image_src:da.thumbSrc,name:da.name,short_name:da.firstName,employee:da.employee,call_promo:da.showVideoPromo};}w(x);});}else w(x);},getUserID:function(v){if(!j.isValid(v))return null;var w=j.tokenize(v);if(w.type!='fbid')return null;return w.value;},getIDForUser:function(v){return 'fbid:'+v;},addParticipants:function(v){v.forEach(s);}};l.subscribe('update-participants',function(v,w){u.addParticipants(w.participants||[]);});e.exports=u;});
__d("MercuryFolders",["array-extensions","MercuryConstants"],function(a,b,c,d,e,f){b('array-extensions');var g=c('MercuryConstants'),h=[g.MessagingTag.INBOX,g.MessagingTag.OTHER,g.MessagingTag.ACTION_ARCHIVED,g.MessagingTag.SPAM],i={getSupportedFolders:function(){return h.concat();},isSupportedFolder:function(j){return h.contains(j);},getFromMeta:function(j){var k=j.folder;if(j.is_archived)k=g.MessagingTag.ACTION_ARCHIVED;return k;}};e.exports=i;});
__d("MercuryAttachment",["startsWith","MercuryConstants"],function(a,b,c,d,e,f){var g=b('startsWith'),h=c('MercuryConstants'),i={getAttachIconClass:function(j){switch(j){case h.MercuryAttachmentContentType.PHOTO:return 'MercuryPhotoIcon';case h.MercuryAttachmentContentType.VIDEO:return 'MercuryVideoIcon';case h.MercuryAttachmentContentType.MUSIC:return 'MercuryMusicIcon';case h.MercuryAttachmentContentType.TEXT:return 'MercuryTextIcon';case h.MercuryAttachmentContentType.MSWORD:return 'MercuryMSWordIcon';case h.MercuryAttachmentContentType.MSXLS:return 'MercuryMSXLSIcon';case h.MercuryAttachmentContentType.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(j){if(g(j,'image')){return 'MercuryPhotoIcon';}else if(g(j,'video')){return 'MercuryVideoIcon';}else if(g(j,'audio')){return 'MercuryMusicIcon';}else if(g(j,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(j){if(g(j,'image')){return h.MercuryAttachmentContentType.PHOTO;}else if(g(j,'video')){return h.MercuryAttachmentContentType.VIDEO;}else if(g(j,'audio')){return h.MercuryAttachmentContentType.MUSIC;}else if(g(j,'text/plain')){return h.MercuryAttachmentContentType.TEXT;}else return h.MercuryAttachmentContentType.UNKNOWN;},convertRaw:function(j){var k=[];for(var l=0;l<j.length;l++){var m=j[l];if(m.filename){var n={};n.attach_type=h.MercuryAttachmentType.FILE;n.name=m.filename;n.icon_type=i.getAttachTypeByMime(m.filetype);n.url='#';k.push(n);}}return k;}};e.exports=i;});
__d("MercuryTimestampTracker",["MercuryServerRequests","MercuryConstants"],function(a,b,c,d,e,f){var g=b('MercuryServerRequests'),h=c('MercuryConstants'),i=0;e.exports={getLastUserMessageTimestamp:function(){return i;}};g.subscribe('update-messages',function(j,k){if(!k.actions||!k.actions.length)return;var l=h.MercuryPayloadSource;if(k.payload_source==l.CLIENT_SEND_MESSAGE||k.payload_source==l.UNKNOWN)return;for(var m=0;m<k.actions.length;m++){var n=k.actions[m],o=n.action_type;if(o==h.MercuryActionType.USER_GENERATED_MESSAGE&&n.thread_id&&n.timestamp>i)i=n.timestamp;}});});
__d("MercuryThreads",["Arbiter","copyProperties","JSLogger","createObjectFrom","KeyedCallbackManager","TimestampConverter","MercuryFolders","MercuryAssert","MercuryAttachment","MercuryIDs","MercuryServerRequests","MercuryThreadInformer","MercuryTimestampTracker","MercuryParticipants","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('JSLogger'),j=b('createObjectFrom'),k=b('KeyedCallbackManager'),l=b('TimestampConverter'),m=b('MercuryFolders'),n=b('MercuryAssert'),o=b('MercuryAttachment'),p=b('MercuryIDs'),q=b('MercuryServerRequests'),r=b('MercuryThreadInformer'),s=b('MercuryTimestampTracker'),t=b('MercuryParticipants'),u=c('MercuryConstants'),v=i.create('mercury_threads'),w=new k();function x(ha,ia){var ja=j(ha.participants,true),ka=t.user;ia.forEach(function(la){if(ja[la]!==true){ha.participants.push(la);if(la===ka)ha.is_subscribed=true;}});}function y(ha,ia){ha.participants.remove(ia);if(ia===t.user)ha.is_subscribed=false;}function z(ha,ia){if(ha.participants[0]!=ia){ha.participants.remove(ia);ha.participants.unshift(ia);}}function aa(ha,ia){var ja=ia.body,ka=ia.subject,la='';if(ka){ka=ka.toLowerCase();if(ja.slice(0,ka.length).toLowerCase()==ka){la=ja;}else if(ja){la=ka+' \u00B7 '+ja;}else la=ka;}else la=ja;ha.snippet=la;ha.snippet_has_attachment=ia.has_attachment;if(ia.raw_attachments&&ia.raw_attachments.length>0){var ma=o.convertRaw(ia.raw_attachments);ha.snippet_attachments=ma;}else ha.snippet_attachments=ia.attachments;ha.is_forwarded_snippet=!!ia.forward_count;}function ba(ha,ia){if(!ha)return false;var ja=!ha.unread_count;if(ia==ja)return false;ha.unread_count=ia?0:1;w.setResource(ha.thread_id,ha);r.updatedThread(ha.thread_id);return true;}function ca(ha){var ia=w.getAllResources();for(var ja in ia){var ka=ia[ja];if(ka.folder==ha){ka.unread_count=0;w.setResource(ja,ka);r.updatedThread(ja);}}}function da(ha,ia){if(!ha||ha.chat_clear_time===ia)return false;ha.chat_clear_time=ia;w.setResource(ha.thread_id,ha);r.reorderedMessages(ha.thread_id);return true;}function ea(ha,ia,ja){var ka=ia.action_type;if(ka==u.MercuryActionType.USER_GENERATED_MESSAGE||ka==u.MercuryActionType.LOG_MESSAGE){ia.is_unread&&ha.unread_count++;ha.is_archived=false;}switch(ka){case u.MercuryActionType.USER_GENERATED_MESSAGE:z(ha,ia.author);break;case u.MercuryActionType.LOG_MESSAGE:var la=ia.log_message_type;if(la==u.MercuryLogMessageType.SUBSCRIBE){x(ha,ia.log_message_data.added_participants);}else if(la==u.MercuryLogMessageType.UNSUBSCRIBE){y(ha,ia.author);}else if(la==u.MercuryLogMessageType.THREAD_IMAGE){ha.image_src=ia.log_message_data.image?ia.log_message_data.image.preview_url:null;}else if(la==u.MercuryLogMessageType.THREAD_NAME)ha.name=ia.log_message_data.name;break;case u.MercuryActionType.CHANGE_READ_STATUS:if(ia.timestamp)r.changedThreadReadState(ha.thread_id,ia.mark_as_read,ia.timestamp);ba(ha,ia.mark_as_read);break;case u.MercuryActionType.CLEAR_CHAT:da(ha,ia.clear_time);break;case u.MercuryActionType.CHANGE_ARCHIVED_STATUS:ha.is_archived=ia.archived;break;case u.MercuryActionType.CHANGE_FOLDER:ha.folder=ia.new_folder;break;case u.MercuryActionType.DELETE_MESSAGES:if(ja){ha.snippet='...';ha.snippet_has_attachment=false;ha.snippet_attachments=null;ha.is_forwarded_snippet=false;r.updatedThread(ia.thread_id);}break;}if(ia.action_id)ha.last_action_id=l.maxValidActionID(ia.action_id,ha.last_action_id);}function fa(ha){var ia=q.tokenizeThreadID(ha.thread_id);if(ia.type=='group'){v.error('invalid_new_thread_message',ha);return undefined;}var ja={thread_id:ha.thread_id,last_action_id:ha.action_id,participants:ha.specific_to_list,name:null,snippet:ha.body,snippet_has_attachment:false,snippet_attachments:[],unread_count:0,image_src:null,timestamp_absolute:ha.timestamp_absolute,timestamp_relative:ha.timestamp_relative,timestamp:ha.timestamp,is_canonical_user:ia.type=='user',is_canonical:ia.type=='user'||ia.type=='email',is_subscribed:true,is_canonical_group:false,is_chatlogger_thread:false,group_id:null,root_message_threading_id:ha.message_id,folder:u.MessagingTag.INBOX,is_archived:false,mode:u.MercuryThreadMode.TITAN_ORIGINATED};w.setResource(ja.thread_id,ja);return ja;}g.subscribe(i.DUMP_EVENT,function(ha,ia){ia.messaging=ia.messaging||{};ia.messaging.threads=w.dumpResources();});var ga={getThreadMetaNow:function(ha){n.isThreadID(ha);return w.getResource(ha);},getThreadMeta:function(ha,ia){n.isThreadID(ha);var ja=w.executeOrEnqueue(ha,ia),ka=w.getUnavailableResources(ja);if(ka.length){var la=q.tokenizeThreadID(ha);if(la.type=='user'){this.getCanonicalThreadToUser(la.value);}else q.fetchThreadData(ka);}return ja;},unsubscribe:function(ha){w.unsubscribe(ha);},changeThreadReadStatus:function(ha,ia){n.isThreadID(ha);var ja=w.getResource(ha);if(ba(ja,ia))q.changeThreadReadStatus(ha,ia,m.getFromMeta(ja));},changeThreadArchivedStatus:function(ha,ia){n.isThreadID(ha);var ja=w.getResource(ha);if(ja.is_archived!=ia){ja.is_archived=ia;r.updatedThread(ja.thread_id);q.changeThreadArchivedStatus(ha,ia);}},markThreadSpam:function(ha){q.markThreadSpam(ha);},unmarkThreadSpam:function(ha){q.unmarkThreadSpam(ha);},changeFolder:function(ha,ia){n.isThreadID(ha);var ja=w.getResource(ha);if(ja&&ja.folder!=ia){ja.folder=ia;r.updatedThread(ja.thread_id);q.changeThreadFolder(ha,ia);}},deleteThread:function(ha){n.isThreadID(ha);q.deleteThread(ha);},updateThreads:function(ha){if(!ha||!ha.length)return;var ia={};ha.forEach(function(ja){ia[ja.thread_id]=ja;});w.addResourcesAndExecute(ia);},updateMetadataByActions:function(ha,ia){if(!ha||!ha.length)return;var ja={},ka={},la={};for(var ma=0;ma<ha.length;ma++){var na=ha[ma];if(na.is_forward)continue;var oa=na.action_type,pa=na.thread_id;n.isThreadID(pa);var qa=this.getThreadMetaNow(pa);if(oa==u.MercuryActionType.LOG_MESSAGE&&na.log_message_type==u.MercuryLogMessageType.SERVER_ERROR)continue;if(!qa&&!na.action_id&&oa==u.MercuryActionType.USER_GENERATED_MESSAGE)qa=fa(na);if(qa){if(oa==u.MercuryActionType.DELETE_THREAD){r.deletedThread(pa);continue;}var ra=!!na.action_id;if(oa==u.MercuryActionType.LOG_MESSAGE||oa==u.MercuryActionType.USER_GENERATED_MESSAGE)ra=!ia;if(na.timestamp<=qa.timestamp&&ra){v.log('ignore_old_timestamp',{action:na,from_client:ia,thread_timestamp:qa.timestamp});continue;}if(!la[pa])la[pa]=h({},qa);ea(la[pa],na,ia);if(oa==u.MercuryActionType.USER_GENERATED_MESSAGE)ja[pa]=na;if(oa==u.MercuryActionType.USER_GENERATED_MESSAGE||oa==u.MercuryActionType.LOG_MESSAGE||oa==u.MercuryActionType.SEND_MESSAGE)if(na&&na.timestamp&&(!ka[pa]||na.timestamp>ka[pa].timestamp))ka[pa]=na;}}for(var sa in la){var ta=la[sa],ua=ja[sa];if(ua)aa(ta,ua);var va=ka[sa],wa=ta.timestamp;if(va&&va.timestamp>wa)ta=h(ta,{timestamp_absolute:va.timestamp_absolute,timestamp_relative:va.timestamp_relative,timestamp:va.timestamp});w.setResource(sa,ta);}},getCanonicalThreadToGroup:function(ha,ia){var ja='group:'+ha;this.getThreadMeta(ja,ia);},getCanonicalThreadToUser:function(ha,ia){return ga.getCanonicalThreadToParticipant('fbid:'+ha,ia);},getCanonicalThreadToParticipant:function(ha,ia){var ja=ga.getThreadIDForParticipant(ha),ka=w.getResource(ja);if(typeof ka=='undefined'){ka=ga.createNewLocalThread(ja,[t.user,ha],ia);q.fetchThreadData([ja]);}return ka;},getThreadIdForUser:function(ha){return 'user:'+ha;},getThreadIdForEmail:function(ha){return 'email:'+ha;},getThreadIDForParticipant:function(ha){var ia=p.tokenize(ha);return ia.type=='fbid'?ga.getThreadIdForUser(ia.value):ga.getThreadIdForEmail(ia.value);},createNewLocalThread:function(ha,ia,ja){var ka=w.getResource(ha);if(!ka){var la=q.tokenizeThreadID(ha);ka={thread_id:ha,last_action_id:null,participants:ia,name:null,snippet:'',snippet_has_attachment:false,unread_count:ja?ja:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,is_canonical_user:la.type=='user',is_canonical:la.type=='user'||la.type=='email',is_subscribed:true,is_canonical_group:la.type=='group',group_id:(la.type=='group'?la.value:null),root_message_threading_id:null,folder:u.MessagingTag.INBOX,is_archived:false,mode:u.MercuryThreadMode.TITAN_ORIGINATED};ka.is_chatlogger_thread=ka.is_canonical_group;w.setResource(ha,ka);}return ka;},addParticipantsToThreadLocally:function(ha,ia){var ja=w.getResource(ha);if(ja){x(ja,ia);r.updatedThread(ja.thread_id);}},getCanonicalUserInThread:function(ha){var ia=q.tokenizeThreadID(ha);return ia.type=='user'?ia.value:null;},getCanonicalGroupInThread:function(ha){var ia=q.tokenizeThreadID(ha);return ia.type=='group'?ia.value:null;},isEmptyLocalThread:function(ha){var ia=w.getResource(ha);if(!ia)return false;var ja=q.tokenizeThreadID(ha);return ja.type=='root'&&!ia.timestamp;},isMultichatThread:function(ha){var ia=q.tokenizeThreadID(ha).type;return ia!='user'&&ia!='group';}};q.subscribe('update-threads',function(ha,ia){var ja=(ia.actions||[]).filter(function(na){return na.thread_id;});ga.updateThreads(ia.threads);ga.updateMetadataByActions(ja,ia.from_client);(ia.threads||[]).forEach(function(na){r.updatedThread(na.thread_id);});var ka=ia.global_actions||[];for(var la=0;la<ka.length;la++){var ma=ka[la];if(ma.action_type==u.MercuryGlobalActionType.MARK_ALL_READ)ca(ma.folder);}});e.exports=ga;});
__d("MercuryChannelHandler",["Arbiter","ChannelConstants","copyProperties","Env","MessagingReliabilityLogger","MercuryParticipants","PresenceUtil","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('copyProperties'),j=b('Env'),k=b('MessagingReliabilityLogger'),l=b('MercuryParticipants'),m=b('PresenceUtil'),n=b('MercuryServerRequests'),o=b('MercuryThreadInformer'),p=b('MercuryThreads'),q=c('MercuryConstants');function r(ha,ia){var ja=ia.obj.to;p.getCanonicalThreadToGroup(ja,function(ka){var la=ka.thread_id;n.getServerThreadID(la,function(ma){var na=aa(ja,ia.obj.from,ia.obj.msg.time),oa=ia.obj.from!=j.user,pa={obj:{message:{action_id:null,body:ia.obj.msg.text,is_unread:oa,mid:na,mercury_author_id:'fbid:'+ia.obj.from,mercury_author_email:null,mercury_coordinates:null,mercury_spoof_warning:false,mercury_source:q.MercurySourceType.CHAT_WEB,mercury_source_tags:[q.MercuryMessageSourceTags.CHAT],sender_fbid:ia.obj.from,tid:ma,timestamp:ia.obj.msg.time,threading_id:ia.obj.sync_id},folder:'group_chat'}};s(h.getArbiterType('messaging'),pa);});});}function s(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.message){k.addEntry('channel_receive','invalid_data');return;}var ja=ia.obj.message,ka={author:ja.mercury_author_id,author_email:ja.mercury_author_email,body:ja.body,subject:ja.subject,has_attachment:ja.has_attachment,attachments:ja.attachments,html_body:ja.html_body,thread_id:ja.tid,message_id:ja.mid,coordinates:ja.mercury_coordinates,spoof_warning:ja.mercury_spoof_warning,source:ja.mercury_source,source_tags:ja.mercury_source_tags,threading_id:ja.threading_id,timestamp:ja.timestamp,timestamp_absolute:new Date(ja.timestamp).toLocaleString(),action_type:q.MercuryActionType.USER_GENERATED_MESSAGE,is_unread:ja.is_unread,action_id:ja.action_id,is_forward:false,forward_count:ja.forward_count||ja.forward,forward_message_ids:ja.forward_msg_ids,location_text:ja.location_text,folder:ia.obj.folder},la=[i({},ka)];la=la.concat(ja.forward_actions||[]);var ma=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:la,payload_source:ma},ja.tid);if(!ja.is_unread&&ja.mercury_author_id===l.user){var na={};na[ja.tid]=ia.obj.folder;t(h.getArbiterType('messaging'),{obj:{event:q.MessagingEventTypes.READ,tids:[ja.tid],folder_info:na}});}k.addEntry('channel_receive','success',[ka.thread_id,ka.message_id,m.getSessionID()]);}function t(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.tids)return;var ja=[],ka=ia.obj.event==q.MessagingEventTypes.READ;ia.obj.tids.forEach(function(la){ja.push({action_type:q.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:la,mark_as_read:ka,timestamp:ia.obj.timestamp||0,folder:ia.obj.folder_info[la]});});n.handleUpdate({actions:ja,payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function u(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.tids)return;var ja=[];ia.obj.tids.forEach(function(ka){ja.push({action_type:q.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ka});});n.handleUpdate({actions:ja,payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function v(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.tids||!ia.obj.mids)return;var ja=ia.obj.tids[0],ka={action_type:q.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ja,message_ids:ia.obj.mids};n.handleUpdate({actions:[ka],threads:[ia.obj.updated_thread],payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function w(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj||!ia.obj.folder)return;var ja={action_type:q.MercuryGlobalActionType.MARK_ALL_READ,action_id:ia.obj.action_id,folder:ia.obj.folder};n.handleUpdate({global_actions:[ja]});}function x(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj.tids)return;var ja=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;ia.obj.tids.forEach(function(ka){var la={action_type:q.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ka,archived:ia.obj.state};n.handleUpdateWaitForThread({actions:[i({},la)],payload_source:ja},ka);});}function y(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj.tids)return;var ja=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE,ka;ia.obj.tids.forEach(function(la){if(ia.obj.event==q.MessagingEventTypes.TAG){ka=ia.obj.tag;}else ka=ia.obj.marked_as_spam?q.MessagingTag.SPAM:q.MessagingTag.INBOX;var ma={action_type:q.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:la,new_folder:ka};n.handleUpdateWaitForThread({actions:[i({},ma)],payload_source:ja},la);});}function z(ha,ia){if(ha!=h.getArbiterType('messaging')||!ia.obj.tag)return;switch(ia.obj.tag){case q.MessagingTag.ACTION_ARCHIVED:x(ha,ia);break;case q.MessagingTag.INBOX:case q.MessagingTag.OTHER:y(ha,ia);break;}}function aa(ha,ia,ja){return ha+':'+ia+':'+ja;}function ba(ha,ia){if(ha!=h.getArbiterType('inbox')||!ia.obj||!ia.obj.seen_timestamp)return;n.handleUpdate({message_counts:[{seen_timestamp:ia.obj.seen_timestamp,folder:q.MessagingTag.INBOX}],unseen_thread_ids:[{thread_ids:[],folder:q.MessagingTag.INBOX}],payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function ca(ha,ia){if(ha!=h.getArbiterType('mercury')||!ia.obj)return;o.synchronizeInforms(function(){var ja=ia.obj,ka=[];(ja.actions||[]).forEach(function(la){var ma=q.MercuryActionType.USER_GENERATED_MESSAGE;if(la.action_type==q.MercuryActionType.LOG_MESSAGE){var na=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:[i({},la)],payload_source:na},la.thread_id);}else if(la.action_type!=ma)ka.push(la);});ja.actions=ka;ja.payload_source=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdate(ja);});}function da(ha,ia){n.handleRoger(ia.obj);}function ea(ha,ia){switch(ia.obj.event){case q.MessagingEventTypes.DELIVER:s(ha,ia);break;case q.MessagingEventTypes.READ:case q.MessagingEventTypes.UNREAD:t(ha,ia);break;case q.MessagingEventTypes.READ_ALL:w(ha,ia);break;case q.MessagingEventTypes.DELETE:u(ha,ia);break;case q.MessagingEventTypes.DELETE_MESSAGES:v(ha,ia);break;case q.MessagingEventTypes.TAG:z(ha,ia);break;case q.MessagingEventTypes.REPORT_SPAM:y(ha,ia);break;case q.MessagingEventTypes.READ_RECEIPT:da(ha,ia);break;}}var fa=[],ga={turnOn:function(){if(!fa.length){var ha={mercury:ca,messaging:ea,group_msg:r,inbox:ba};for(var ia in ha)fa.push(g.subscribe(h.getArbiterType(ia),ha[ia]));}},turnOff:function(){if(fa.length){fa.forEach(g.unsubscribe);fa=[];}}};ga.turnOn();e.exports=ga;});
__d("MercuryMessages",["Arbiter","copyProperties","Env","JSLogger","randomInt","tx","KeyedCallbackManager","MercuryAssert","MercuryIDs","MercuryMessageIDs","MercuryParticipants","PresenceUtil","RangedCallbackManager","MercuryServerRequests","MercuryServerDispatcher","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('Env'),j=b('JSLogger'),k=b('randomInt'),l=b('tx'),m=b('KeyedCallbackManager'),n=b('MercuryAssert'),o=b('MercuryIDs'),p=b('MercuryMessageIDs'),q=b('MercuryParticipants'),r=b('PresenceUtil'),s=b('RangedCallbackManager'),t=b('MercuryServerRequests'),u=b('MercuryServerDispatcher'),v=b('MercuryThreadInformer'),w=b('MercuryThreads'),x=c('MercuryConstants'),y=x.MercuryGenericConstants,z={},aa={},ba={},ca=function(ra){var sa=ra;if(aa[ra])sa=aa[ra];return z[sa];},da={},ea={},fa=new m();function ga(ra){if(ra.status===undefined)ra.status=x.MercuryActionStatus.UNSENT;ra.message_id=ra.message_id||ma.generateNewClientMessageID(ra.timestamp);var sa=q.user;ra.specific_to_list=ra.specific_to_list||[];if(ra.specific_to_list.length&&ra.specific_to_list.indexOf(sa)===-1)ra.specific_to_list.push(sa);if(!ra.thread_id){if(ra.specific_to_list.length==1){ra.thread_id='user:'+i.user;}else if(ra.specific_to_list.length==2){var ta=ra.specific_to_list[0]==sa?ra.specific_to_list[1]:ra.specific_to_list[0];if(o.tokenize(ta).type=='email'){ra.thread_id=y.PENDING_THREAD_ID;}else ra.thread_id=w.getThreadIDForParticipant(ta);}ra.thread_id=ra.thread_id||'root:'+ra.message_id;}if(!ra.specific_to_list.length){var ua=t.tokenizeThreadID(ra.thread_id);if(ua.type=='user')ra.specific_to_list=['fbid:'+ua.value,sa];}}function ha(ra,sa,ta){var ua=qa(sa)?[x.MercuryMessageSourceTags.CHAT]:[],va=(new Date()).getTime(),wa={action_type:ra,thread_id:ta,author:q.user,author_email:null,coordinates:null,timestamp:va,timestamp_absolute:(new Date(va)).toLocaleString(),timestamp_relative:"a few seconds ago",is_unread:false,is_cleared:false,is_forward:false,spoof_warning:false,source:sa,source_tags:ua};return wa;}function ia(ra){switch(ra){case x.MercuryPayloadSource.UNKNOWN:case x.MercuryPayloadSource.SERVER_INITIAL_DATA:case x.MercuryPayloadSource.SERVER_FETCH_THREAD_INFO:case x.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;}return false;}function ja(ra){return ra&&ra.substr(0,6)==='server';}function ka(ra){if(!da[ra])da[ra]=new s(function(sa){return ca(sa).timestamp;},function(sa,ta){return ta-sa;});return da[ra];}g.subscribe(j.DUMP_EVENT,function(ra,sa){var ta={};for(var ua in z){var va=z[ua],wa=va.thread_id;ta[wa]=ta[wa]||{};ta[wa][va.message_id]=h({},va);}sa.messaging=sa.messaging||{};sa.messaging.local_message_ids=h({},aa);sa.messaging.messages=ta;});function la(ra,sa){ra.forEach(function(ta){var ua=ka(ta);ua.setReachedEndOfArray();v.reorderedMessages(ta,sa);});}var ma={getMessagesFromIDs:function(ra){return (ra||[]).map(ca).filter(function(sa){return sa;});},hasLoadedNMessages:function(ra,sa){var ta=ka(ra);return ta.hasReachedEndOfArray()||ta.getCurrentArraySize()>=sa;},getThreadMessagesRangeImmediately:function(ra,sa,ta,ua){return this.getThreadMessagesRange(ra,sa,ta,ua,u.IMMEDIATE);},getThreadMessagesRange:function(ra,sa,ta,ua,va){var wa=ka(ra),xa=function(cb){ua(na(cb));},ya=wa.executeOrEnqueue(sa,ta,xa),za=wa.getUnavailableResources(ya),ab=ba[ra];if(za.length&&!ab){var bb=ea[ra]||0;t.fetchThreadMessages(ra,bb,za.length,va);}else ba[ra]=false;return ya;},getThreadMessagesSinceTimestamp:function(ra,sa){var ta=ka(ra),ua=ta.getElementsUntil(sa);return na(ua);},hasLoadedAllMessages:function(ra){return ka(ra).hasReachedEndOfArray();},unsubscribe:function(ra,sa){n.isThreadID(sa);var ta=ka(sa);ta.unsubscribe(ra);},handleUpdates:function(ra,sa,ta){var ua={},va={},wa=x.MercuryActionStatus;for(var xa=0;xa<ra.length;xa++){var ya=ra[xa];if(ya.is_forward||ta==x.MercuryPayloadSource.SERVER_SEARCH){if(!z[ya.message_id])z[ya.message_id]=ya;continue;}var za=ya.action_type;if(za==x.MercuryActionType.SEND_MESSAGE){var ab=ya.client_message_id;if(ab&&aa[ab]&&ya.status){if(ya.status==wa.UNCONFIRMED){if(!va[ya.thread_id])va[ya.thread_id]=[];va[ya.thread_id].push(ya.client_message_id);}else if(!ua[ya.thread_id])ua[ya.thread_id]=[];var bb=ca(ya.client_message_id),cb=bb.status;bb.status=ya.status;if(ya.status==wa.SUCCESS){this.updateLocalMessage(ya,ta);if(ya.client_thread_id==y.PENDING_THREAD_ID){bb.thread_id=ya.thread_id;ua[ya.thread_id].push(bb.message_id);fa.setResource(bb.message_id,bb.thread_id);}}if(typeof cb!='undefined'||ya.status==wa.REQUEST_ERROR||ya.status==wa.TRANSPORT_ERROR||ya.status==wa.FAILED_UNKNOWN_REASON||ya.status==wa.UNABLE_TO_CONFIRM||ya.status==wa.SUCCESS)v.updatedMessage(ya.thread_id,ca(ya.client_message_id).message_id,ta);}continue;}else if(za==x.MercuryActionType.DELETE_THREAD){ka(ya.thread_id).removeAllResources();continue;}else if(za==x.MercuryActionType.DELETE_MESSAGES){var db=ya.message_ids.map(function(lb){return ca(lb).message_id;}),eb=ka(ya.thread_id);eb.removeResources(db);v.reorderedMessages(ya.thread_id,ta);continue;}else if(za==x.MercuryActionType.LOG_MESSAGE){if(ya.log_message_type==x.MercuryLogMessageType.SERVER_ERROR)ba[ya.thread_id]=true;}else if(za==x.MercuryActionType.CLEAR_CHAT){var fb=ka(ya.thread_id).getAllResources();fb.map(ca).forEach(function(lb){lb.is_cleared=true;});continue;}var gb=ca(ya.message_id);if((ya.threading_id&&aa[ya.threading_id])||(gb&&!gb.is_forward))continue;if(!ua[ya.thread_id])ua[ya.thread_id]=[];ua[ya.thread_id].push(ya.message_id);z[ya.message_id]=ya;if(ya.threading_id&&ya.threading_id!=ya.message_id)p.addServerID(ya.threading_id,ya.message_id);if(!sa)v.receivedMessage(ya);}for(var hb in ua){var eb=ka(hb),ib=eb.getAllResources(),jb=ib.filter(function(lb){var mb=z[lb];return mb.action_type==x.MercuryActionType.LOG_MESSAGE&&mb.log_message_type==x.MercuryLogMessageType.SERVER_ERROR;});eb.removeResources(jb);oa(hb,ua[hb]);if(sa){eb.addResources(ua[hb]);v.reorderedMessages(hb,ta);}else eb.addResourcesWithoutSorting(ua[hb].reverse(),0);v.updatedThread(hb);}var kb=Object.keys(va);if(kb.length)t.requestMessageConfirmation(va);},sendMessage:function(ra,sa){sa=sa||Function.prototype;ga(ra);aa[ra.message_id]=ra.message_id;if(ra.thread_id=='root:'+ra.message_id)ka(ra.thread_id).setReachedEndOfArray();t.sendNewMessage(ra);if(ra.thread_id==y.PENDING_THREAD_ID){z[ra.message_id]=ra;return fa.executeOrEnqueue(ra.message_id,sa);}else sa(ra.thread_id);},unsubscribeSend:function(ra){fa.unsubscribe(ra);},resendMessage:function(ra){var sa=h({},ra);sa.status=x.MercuryActionStatus.RESENDING;sa.timestamp=(new Date()).getTime();sa.message_id=ma.generateNewClientMessageID(sa.timestamp);var ta=ka(ra.thread_id);ta.removeResources([ra.message_id]);this.sendMessage(sa);v.reorderedMessages(ra.thread_id,x.MercuryPayloadSource.CLIENT_SEND_MESSAGE);},deleteMessages:function(ra,sa){if(sa.length){var ta=ka(ra),ua=ta.getCurrentArraySize()==sa.length&&ta.hasReachedEndOfArray();t.deleteMessages(ra,sa,ua);}},updateLocalMessage:function(ra,sa){var ta=ra.message_id,ua=ra.client_message_id;aa[ua]=ta;z[ta]=z[ua];p.addServerID(ua,ta);z[ua]={};if(ra.timestamp)ca(ua).timestamp=ra.timestamp;if(ra.attachments&&ra.attachments.length){ca(ua).raw_attachments=null;ca(ua).attachments=ra.attachments;}},constructUserGeneratedMessageObject:function(ra,sa,ta,ua){var va=ha(x.MercuryActionType.USER_GENERATED_MESSAGE,sa,ta);va.body=ra;va.has_attachment=false;va.html_body=false;va.attachments=[];va.specific_to_list=ua||[];return va;},constructLogMessageObject:function(ra,sa,ta,ua){var va=ha(x.MercuryActionType.LOG_MESSAGE,ra,sa);va.log_message_type=ta;va.log_message_data=ua;return va;},generateNewClientMessageID:function(ra){var sa=ra+':'+(k(0,4294967295)+1)+'-'+r.getSessionID();return '<'+sa+'@mail.projektitan.com>';}};t.subscribe('update-messages',function(ra,sa){var ta=(sa.actions||[]).filter(function(va){var wa=va.action_type;return (va.is_forward||va.thread_id)&&(wa==x.MercuryActionType.LOG_MESSAGE||wa==x.MercuryActionType.USER_GENERATED_MESSAGE||wa==x.MercuryActionType.SEND_MESSAGE||wa==x.MercuryActionType.CLEAR_CHAT||wa==x.MercuryActionType.DELETE_THREAD||wa==x.MercuryActionType.DELETE_MESSAGES);}),ua=ia(sa.payload_source);if(ja(sa.payload_source))ta.forEach(function(va){if(!va.is_forward){var wa=w.getThreadMetaNow(va.thread_id);if(wa)va.is_cleared=va.timestamp<wa.chat_clear_time;}});ma.handleUpdates(ta,ua,sa.payload_source);if(sa.end_of_history)la(sa.end_of_history,sa.payload_source);});function na(ra){var sa=ra.map(ca);return sa.reverse();}function oa(ra,sa){var ta=sa.filter(function(ua){return pa(ca(ua));});if(!ea[ra])ea[ra]=0;ea[ra]+=ta.length;}function pa(ra){var sa=ra.action_type;if(sa==x.MercuryActionType.USER_GENERATED_MESSAGE)return true;switch(ra.log_message_type){case x.MercuryLogMessageType.SUBSCRIBE:case x.MercuryLogMessageType.UNSUBSCRIBE:case x.MercuryLogMessageType.SERVER_ERROR:case x.MercuryLogMessageType.LIVE_LISTEN:return false;default:return true;}}function qa(ra){switch(ra){case x.MercurySourceType.CHAT_WEB:case x.MercurySourceType.CHAT_JABBER:case x.MercurySourceType.CHAT_IPHONE:case x.MercurySourceType.CHAT_MEEBO:case x.MercurySourceType.CHAT_ORCA:case x.MercurySourceType.CHAT_TEST:case x.MercurySourceType.CHAT:case x.MercurySourceType.DESKTOP:return true;default:return false;}}e.exports=ma;});
__d("MercuryRoger",["ArbiterMixin","MercuryServerRequests","LiveTimer","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('MercuryServerRequests'),i=b('LiveTimer'),j=b('copyProperties'),k={},l={getSeenBy:function(m){if(!m)return [];var n=[],o=k[m.thread_id];for(var p in o)if(o[p]>m.timestamp&&p!=m.author)n.push(p);return n;},getSeenTimestamp:function(m,n){var o=k[m];return o?o[n]:null;}};j(l,g);h.subscribe('update-roger',function(m,n){for(var o in n){if(!k[o])k[o]={};for(var p in n[o]){var q=k[o][p],r=n[o][p];if(!q||r>q)k[o][p]=r;}}if(n)l.inform('state-changed',n);});e.exports=l;});
__d("Emote",["DOM","Env","StringEscape"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('Env'),i=b('StringEscape'),j=e.exports={_initialized:false,_imageBase:null,_emoteMap:null,_emoteOrderMap:null,_fbidEmoticonPattern:'\\[\\[([A-Za-z0-9\\.]+)\\]\\]',_fbidEmoticonRegex:null,_imageURLs:null,_regex:null,_regexWithoutFBIDs:null,_init:function(){var k=h.static_base;j._imageBase=k+'images/emote/';j._blankImgSrc=k+'images/blank.gif';var l=['smile','frown','tongue','grin','gasp','wink','glasses','sunglasses','grumpy','unsure','cry','devil','angel','kiss','heart','kiki','squint','confused','upset','pacman','colonthree','like'];j._emoteMap={':-)':['\\:\\-\\)','smile'],':)':['\\:\\)','smile'],':]':['\\:\\]','smile'],'=)':['=\\)','smile'],':-(':['\\:\\-\\(','frown'],':(':['\\:\\(','frown'],':[':['\\:\\[','frown'],'=(':['=\\(','frown'],':-P':['\\:\\-P','tongue'],':P':['\\:P','tongue'],':-p':['\\:\\-p','tongue'],':p':['\\:p','tongue'],'=P':['=P','tongue'],':-D':['\\:\\-D','grin'],':D':['\\:D','grin'],'=D':['=D','grin'],':-O':['\\:\\-O','gasp'],':O':['\\:O','gasp'],':-o':['\\:\\-o','gasp'],':o':['\\:o','gasp'],';-)':['\\;\\-\\)','wink'],';)':['\\;\\)','wink'],'8-)':['8\\-\\)','glasses'],'8)':['8\\)','glasses'],'B-)':['B\\-\\)','glasses'],'B)':['B\\)','glasses'],'8-|':['8\\-\\|','sunglasses'],'8|':['8\\|','sunglasses'],'B-|':['B\\-\\|','sunglasses'],'B|':['B\\|','sunglasses'],'>:(':['>\\:\\(','grumpy'],'>:-(':['>\\:\\-\\(','grumpy'],':/':['\\:/','unsure'],':-/':['\\:\\-/','unsure'],':\\':['\\:\\\\','unsure'],':-\\':['\\:\\-\\\\','unsure'],":'(":["\\:'\\(",'cry'],'3:)':['3\\:\\)','devil'],'3:-)':['3\\:\\-\\)','devil'],'O:)':['O\\:\\)','angel'],'O:-)':['O\\:\\-\\)','angel'],':-*':['\\:\\-\\*','kiss'],':*':['\\:\\*','kiss'],'<3':['<3','heart'],'&lt;3':['&lt\\;3','heart'],'\u2665':['\u2665','heart'],'^_^':['\\^_\\^','kiki'],'-_-':['\\-_\\-','squint'],'o.O':['o\\.O','confused'],'O.o':['O\\.o','confused'],'>:O':['>\\:O','upset'],'>:-O':['>\\:\\-O','upset'],'>:o':['>\\:o','upset'],'>:-o':['>\\:\\-o','upset'],'>_<':['>_<','upset'],'>.<':['>\\.<','upset'],':v':['\\:v','pacman'],':|]':['\\:\\|\\]','robot'],':3':['\\:3','colonthree'],'<(")':['<\\(\\"\\)','penguin'],':putnam:':['\\:putnam\\:','putnam'],'(^^^)':['\\(\\^\\^\\^\\)','shark'],':42:':['\\:42\\:','42'],':like:':['\\:like\\:','like'],'(y)':['\\(y\\)','like'],'(Y)':['\\(Y\\)','like']};var m=[],n=[];if(h.fbid_emoticons){j._fbidEmoticonRegex=new RegExp(j._fbidEmoticonPattern);m.push(j._fbidEmoticonPattern);}for(var o in j._emoteMap){var p=j._emoteMap[o][0];m.push(p);n.push(p);}var q='(?:^|\\s|\'|"|\\.)('+m.join('|')+')(?:\\s|\'|"|\\.|,|!|\\?|<br>|$)',r='(?:^|\\s|\'|"|\\.)('+n.join('|')+')(?:\\s|\'|"|\\.|,|!|\\?|<br>|$)';j._regex=new RegExp(q);j._regexWithoutFBIDs=new RegExp(r);j._emoteOrderMap={};for(var s=0;s<l.length;s++)j._emoteOrderMap[l[s]]=s;j._initialized=true;},htmlEmote:function(k,l){return j._htmlEmote(k,l,true);},htmlEmoteWithoutFBID:function(k,l){return j._htmlEmote(k,l,false);},_getRegex:function(k){return k?j._regex:j._regexWithoutFBIDs;},_htmlEmote:function(k,l,m){if(typeof l!='function')l=i.htmlize;if(!j._initialized)j._init();var n=k,o=[];while(true){var p=j._getRegex(m),q=p.exec(n);if(!q||!q.length)break;var r=q[1],s=n.indexOf(r),t=n.substring(0,s);if(t)o.push(l(t));o.push('<span class="emote_text">');o.push(r);o.push('</span>');var u={title:r},v=j._fbidEmoticonRegex&&(j._fbidEmoticonRegex.exec(r)||[])[1];if(v){u.className='emote_custom';u.src=window.location.protocol+'//graph.facebook.com/'+encodeURIComponent(v)+'/picture';}else{var w=j._emoteMap[r][1],x=j._emoteOrderMap[w];if(x===undefined){u.className='emote_custom';u.src=j._imageBase+w+'.gif';}else{var y=x*-16;u.className='emote_img';u.src=j._blankImgSrc;u.style={backgroundPosition:y+'px 0'};}}var z=g.create('img',u);o.push(g.create('span',{},z).innerHTML);n=n.substring(s+r.length);}if(n)o.push(l(n));return o.join('');}};});
__d("MercuryThreadMetadataRenderer",["event-extensions","CSS","DOM","Emote","HTML","LiveTimer","MercuryAttachment","MercuryMessages","MercuryParticipants","MercurySeenByAll","MercuryServerRequests","MercuryThreads","Tooltip","URI","cx","createArrayFrom","tx","MercuryImageTemplates","MercuryThreadlistIconTemplates","MercuryStatusTemplates","MercuryConstants","MercuryConfig"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('Emote'),j=b('HTML'),k=b('LiveTimer'),l=b('MercuryAttachment'),m=b('MercuryMessages'),n=b('MercuryParticipants'),o=b('MercurySeenByAll'),p=b('MercuryServerRequests'),q=b('MercuryThreads'),r=b('Tooltip'),s=b('URI'),t=b('cx'),u=c('MercuryImageTemplates'),v=c('MercuryThreadlistIconTemplates'),w=c('MercuryStatusTemplates'),x=c('MercuryConstants'),y=c('MercuryConfig'),z=b('createArrayFrom'),aa=b('tx');e.exports={renderLiveTimestamp:function(ea,fa,ga,ha){if(fa){ea.setAttribute('data-utime',Math.floor(ha/1000));ea.setAttribute('title',fa);if(!ga)ga=Date.format(y['24h_times']?'H:i':'g:ia',Math.floor(ha/1000));k.updateNode(ea,ga);k.addTimeStamps(ea);g.show(ea);}},renderMessageSourceTags:function(ea,fa,ga,ha){var ia=x.MercuryMessageSourceTags,ja='',ka='',la='';if(ga.contains(ia.MESSENGER)){ja="Sent from Messenger";ka=new s('/mobile/messenger');la="-cx-PRIVATE-webMessengerMessageGroup__sourceMessenger";}else if(ga.contains(ia.CHAT)){ja="Sent from Chat";la="-cx-PRIVATE-webMessengerMessageGroup__sourceChat";}else if(ga.contains(ia.EMAIL)){if(ha){ja=aa._("Sent from {email}",{email:ha});}else ja="Sent from Email";la="-cx-PRIVATE-webMessengerMessageGroup__sourceEmail";}else if(ga.contains(ia.MOBILE)){ja="Sent from Mobile";ka=new s('/mobile/');la="-cx-PRIVATE-webMessengerMessageGroup__sourceMobile";}if(la){r.set(ea,ja);g.addClass(fa,la);if(ka){ea.setAttribute('href',ka);}else ea.removeAttribute('href');}else g.hide(ea);},renderMessageLocation:function(ea,fa,ga){var ha=s('/ajax/messaging/hovercard/map.php').setQueryData(ga);ea.setAttribute('data-hovercard',ha);g.removeClass(ea,"-cx-PRIVATE-webMessengerMessageGroup__noLocation");g.show(fa);},renderSpoofWarning:function(ea,fa,ga){if(fa){g.addClass(ea,"-cx-PRIVATE-webMessengerMessageGroup__spoofWarning");r.set(ea,aa._("Unable to confirm {name_or_email} as the sender.",{name_or_email:ga.name}));}},renderCoreThreadlist:function(ea,fa,ga,ha,ia){q.getThreadMeta(ea,function(ja){ha=ha||{};this.renderThreadImage(ja.thread_id,fa.getNode('image'));da(ja.thread_id,fa.getNode('name'),ha);if(ja.folder&&ia)ca(fa.getNode('folderBadge'),ja.folder);var ka=fa.getNode('timestamp');this.renderLiveTimestamp(ka,ja.timestamp_absolute,ja.timestamp_relative,ja.timestamp);this.renderSnippet(ja.thread_id,fa.getNode('snippet'));ga(fa,ja);}.bind(this));},renderCommaSeparatedParticipantList:function(ea,fa,ga){ga=ga||{};ga.last_separator_uses_and=false;return da(ea,fa,ga);},renderAndSeparatedParticipantList:function(ea,fa,ga){ga=ga||{};ga.last_separator_uses_and=true;return da(ea,fa,ga);},renderSnippet:function(ea,fa){q.getThreadMeta(ea,function(ga){var ha=h.create('span');g.addClass(ha,'MercuryRepliedIndicator');h.appendContent(fa,ha);o.updateOnSeenChange(ha,ga);if(ga.snippet_has_attachment)if(!ga.snippet&&ga.snippet_attachments){ga.snippet_attachments.forEach(function(ka){if(ka.attach_type!=x.MercuryAttachmentType.FILE)return;var la=l.getAttachIconClass(ka.icon_type),ma=v[':fb:mercury:attachment-icon-text'].build().getRoot();h.appendContent(ma,ka.name);g.addClass(ma,la);h.appendContent(fa,ma);}.bind(this));}else h.appendContent(fa,h.create('span',{className:'MercuryAttachmentIndicator'}));if(ga.is_forwarded_snippet){var ia;if(ga.snippet){ia="Forwarded Message:";}else ia="Forwarded Message";h.appendContent(fa,h.create('strong',{className:'mercuryForwardedIndicator'},ia));}var ja=ga.snippet;if(ja)if(ja.substr(0,4)=='?OTR'){ja="[encrypted message]";}else ja=ja.replace(/\r\n|[\r\n]/g," ");h.appendContent(fa,j(i.htmlEmote(ja)));}.bind(this));},renderTitanLink:function(ea,fa,ga){var ha=ea.indexOf(':'),ia=new s().setSubdomain('www'),ja,ka;if(ea.substr(0,ha)=='user'){ia.setPath('/messages/'+ea.substr(ha+1));fa.setAttribute('href',ia.toString());ga&&ga();}else p.getServerThreadID(ea,function(la){if(y.MessagesMercuryIntegrationGK){ka='selection';}else ka='read';ia.setPath('/messages/');ia.setQueryData({action:ka,tid:la});fa.setAttribute('href',ia.toString());ga&&ga();});},renderThreadImage:function(ea,fa){q.getThreadMeta(ea,function(ga){if(ga.image_src){this._renderThreadImageSingle(ga.image_src,fa);return;}var ha=[],ia=ga.participants.filter(function(ja){return ja!=n.user;});if(!ia.length){ha=[n.user];}else if(ia.length==1){ha=[ia[0]];}else{ha=ia.slice(0,3);if(ha.length==2)ha.push(n.user);}n.getMulti(ha,function(ja){var ka=ha.map(function(la){return ja[la];});this.renderParticipantImages(ka,fa);}.bind(this));}.bind(this));},renderParticipantImages:function(ea,fa){if(ea.length>2){this._renderThreadImageSplit(ea,fa);}else this._renderThreadImageSingle(ea[0].image_src,fa);},renderErrorIndicator:function(ea,fa){var ga=w[':fb:mercury:error-indicator'].render(),ha;switch(ea){case x.MercuryActionStatus.REQUEST_ERROR:case x.MercuryActionStatus.TRANSPORT_ERROR:case x.MercuryActionStatus.FAILED_UNKNOWN_REASON:case x.MercuryActionStatus.UNABLE_TO_CONFIRM:ha="This message failed to send. Click to send again.";break;default:throw new Error('Invalid error code '+ea);}r.set(ga,ha,'above','center');if(fa){Event.listen(ga,'click',fa);g.addClass(ga,'mercuryClickableErrorIndicator');}return ga;},renderResendIndicator:function(){return w[':fb:mercury:resend-indicator'].render();},renderStatusIndicator:function(ea,fa){var ga=x.MercuryActionStatus,ha;if(ea==ga.RESENDING){ha=this.renderResendIndicator();}else if(ea!==undefined&&ea!=ga.UNSENT&&ea!=ga.UNCONFIRMED&&ea!=ga.SUCCESS)ha=this.renderErrorIndicator(ea,fa);return ha;},renderParticipantList:function(ea,fa,ga,ha){var ia={abbr_mode:true,last_separator_uses_and:true,link_mode:true,names_renderer:true};ha=ha||{};var ja=null;if(ha.names_renderer){ja=ha.names_renderer(fa);}else ja=fa.map(function(ma){return ma.name;});var ka=null;if(ja.length==1){ka=ja[0];}else if(ja.length==2){var la={participant1:ja[0],participant2:ja[1]};if(ha.last_separator_uses_and){ka=aa._("{participant1} and {participant2}",la);}else ka=aa._("{participant1}, {participant2}",la);}else if(ha.last_separator_uses_and){if(ha.abbr_mode){ka=aa._("{participant1} and {others_link}",{participant1:ja[0],others_link:this.renderParticipantCount(ea,{render_subset:true,count:ga-1,as_link:ha.link_mode})});}else if(ja.length==3){ka=aa._("{participant1}, {participant2}, and {participant3}",{participant1:ja[0],participant2:ja[1],participant3:ja[2]});}else ka=aa._("{participant1}, {participant2}, and {others_link}",{participant1:ja[0],participant2:ja[1],others_link:this.renderParticipantCount(ea,{render_subset:true,count:ga-2,as_link:ha.link_mode})});}else if(ja.length==3){ka=aa._("{participant1}, {participant2}, {participant3}",{participant1:ja[0],participant2:ja[1],participant3:ja[2]});}else ka=aa._("{participant1}, {participant2}, {participant3}, {others_link}",{participant1:ja[0],participant2:ja[1],participant3:ja[2],others_link:this.renderParticipantCount(ea,{render_subset:true,count:ga-3,as_link:ha.link_mode})});if(Array.isArray(ka))ka=h.create('span',{},ka);return ka;},renderParticipantCount:function(ea,fa){function ga(ka,la){return h.create('a',{className:'hoverlistLink',href:s('/ajax/messaging/profile_browser/profile_browser.php').setQueryData(ka),rel:'dialog'},la);}var ha=fa.render_subset,ia=p.getServerThreadIDNow(ea),ja;if(!ha){ja=aa._("{num} people",{num:fa.count});}else ja=fa.count>1?aa._("{others_count} others",{others_count:fa.count}):"1 other";if(fa.as_link&&ia){return ga({tid:ia},ja);}else return ja;},renderShortNames:function(ea){if(ea.length==1)return [ea[0].name];return ea.map(function(fa){return fa.short_name;});},_renderThreadImageSingle:function(ea,fa){var ga=u[':fb:mercury:thread-image:single'].build().getRoot();ga.src=ea;h.setContent(fa,ga);},_renderThreadImageSplit:function(ea,fa){var ga=u[':fb:mercury:thread-image:split'].build().setNodeProperty('left','src',ea[0].image_src).setNodeProperty('topRight','src',ea[1].image_src).setNodeProperty('bottomRight','src',ea[2].image_src);h.setContent(fa,ga.getRoot());},_cloneIfDOMElement:function(ea){if(ea.cloneNode){return ea.cloneNode();}else return ea;}};function ba(ea,fa){var ga=ea;if(fa&&fa>1)ga=h.create('span',{},aa._("{conversation_title} ({unread_count})",{conversation_title:ea,unread_count:fa}));return ga;}function ca(ea,fa){z(ea).forEach(function(ga){h.setContent(ga,fa);});}function da(ea,fa,ga){fa=z(fa);var ha={callback:true,check_length:true,show_unread_count:true};ga=ga||{};var ia={};for(var ja in ga)if(ha[ja]){ia[ja]=ga[ja];delete ga[ja];}q.getThreadMeta(ea,function(ka){if(ka.name){var la=ba(ka.name,ia.show_unread_count?ka.unread_count:0);fa.forEach(function(na){h.setContent(na,la);});ia.callback&&ia.callback(la);return;}var ma=ka.participants;if(ka.participants.length>1)ma=ka.participants.filter(function(na){return na!=n.user;});n.getMulti(ma,function(na){var oa=ma.map(function(ta){return na[ta];}),pa=e.exports.renderParticipantList(ea,oa,ma.length,ga);pa=ba(pa,ia.show_unread_count?ka.unread_count:0);var qa=ga.abbr_mode,ra={};for(var sa in ga)ra[sa]=ga[sa];ra.abbr_mode=true;fa.forEach(function(ta){var ua=fa.length>1?e.exports._cloneIfDOMElement(pa):pa;h.setContent(ta,ua);if(ia.check_length&&!qa&&ta.scrollWidth>ta.clientWidth){var va=e.exports.renderParticipantList(ea,oa,ma.length,ra);va=ba(va,ia.show_unread_count?ka.unread_count:0);h.setContent(ta,va);}}.bind(this));ia.callback&&ia.callback(pa);}.bind(this));}.bind(this));}});
__d("flattenArray",[],function(a,b,c,d,e,f){function g(h){var i=[];while(h.length){var j=h.pop();if(Array.isArray(j)){Array.prototype.push.apply(h,j);}else i.push(j);}return i.reverse();}e.exports=g;});
__d("JSXDOM",["DOM","flattenArray"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('flattenArray'),i=['a','br','button','checkbox','dd','div','dl','dt','h1','h2','h3','h4','h5','h6','hr','i','iframe','img','input','label','li','option','p','pre','select','span','strong','table','td','textarea','th','tr','ul'],j={};i.forEach(function(k){var l=function(m){var n;if(m.children){n=h(m.children);delete m.children;}return g.create(k,m,n);};j[k]=l;});e.exports=j;});
__d("XHPTemplate",["event-extensions","DataStore","DOM","HTML","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('DataStore'),h=b('DOM'),i=b('HTML'),j=b('copyProperties');function k(m){this._model=m;}j(k.prototype,{render:function(){if(i.isHTML(this._model))this._model=h.setContent(document.createDocumentFragment(),this._model)[0];return this._model.cloneNode(true);},build:function(){return new l(this.render());}});j(k,{getNode:function(m,n){return k.getNodes(m)[n];},getNodes:function(m){var n=g.get(m,'XHPTemplate:nodes');if(!n){n={};var o=h.scry(m,'[data-jsid]');o.push(m);var p=o.length;while(p--){var q=o[p];n[q.getAttribute('data-jsid')]=q;q.removeAttribute('data-jsid');}g.set(m,'XHPTemplate:nodes',n);}return n;}});function l(m){this._root=m;this._populateNodes();}j(l.prototype,{_populateNodes:function(){this._nodes={};this._leaves={};var m=this._root.getElementsByTagName('*');for(var n=0,o=m.length;n<o;n++){var p=m[n],q=p.getAttribute('data-jsid');if(q){p.removeAttribute('data-jsid');this._nodes[q]=p;this._leaves[q]=!p.childNodes.length;}}},getRoot:function(){return this._root;},getNode:function(m){return this._nodes[m];},setNodeProperty:function(m,n,o){this.getNode(m)[n]=o;return this;},setNodeContent:function(m,n){if(!this._leaves[m])throw new Error("Can't setContent on non-leaf node: "+m);h.setContent(this.getNode(m),n);return this;}});e.exports=k;});
__d("endsWith",[],function(a,b,c,d,e,f){function g(h,i){return h.indexOf(i,h.length-i.length)>-1;}e.exports=g;});
__d("ChannelConstants",[],function(a,b,c,d,e,f){var g='channel/',h={ON_SHUTDOWN:g+'shutdown',ON_INVALID_HISTORY:g+'invalid_history',ON_CONFIG:g+'config',ON_ENTER_STATE:g+'enter_state',ON_EXIT_STATE:g+'exit_state',OK:'ok',ERROR:'error',ERROR_MAX:'error_max',ERROR_MISSING:'error_missing',ERROR_MSG_TYPE:'error_msg_type',ERROR_SHUTDOWN:'error_shutdown',ERROR_STALE:'error_stale',SYS_OWNER:'sys_owner',SYS_NONOWNER:'sys_nonowner',SYS_ONLINE:'sys_online',SYS_OFFLINE:'sys_offline',SYS_TIMETRAVEL:'sys_timetravel',HINT_AUTH:'shutdown auth',HINT_CONN:'shutdown conn',HINT_DISABLED:'shutdown disabled',HINT_INVALID_STATE:'shutdown invalid state',HINT_MAINT:'shutdown maint',HINT_UNSUPPORTED:'shutdown unsupported',reason_Unknown:0,reason_AsyncError:1,reason_TooLong:2,reason_Refresh:3,reason_RefreshDelay:4,reason_UIRestart:5,reason_NeedSeq:6,reason_PrevFailed:7,reason_IFrameLoadGiveUp:8,reason_IFrameLoadRetry:9,reason_IFrameLoadRetryWorked:10,reason_PageTransitionRetry:11,reason_IFrameLoadMaxSubdomain:12,reason_NoChannelInfo:13,reason_NoChannelHost:14,getArbiterType:function(i){return g+'message:'+i;}};e.exports=h;});
__d("ChannelSubdomain",["Cookie","JSLogger"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('JSLogger'),i=h.create('channel'),j=7,k=null;function l(o){var p=null,q=m(),r;for(r=0;r<32&&(q&(1<<r));r++);o--;if(r<Math.min(32,j*o)){k=r;p=k%j;g.set('sub',q|(1<<k));}else{k=-1;p=null;i.error('subdomain_overflow',{slot:k,max:o});}return p;}function m(){var o=g.get('sub')||0;o=parseInt(o,10);return isNaN(o)?0:o;}function n(){if(k!==null&&k>=0){var o=m()&~(1<<k);if(o){g.set('sub',o);}else g.clear('sub');}}e.exports={allocate:l,clear:n};});
__d("legacy:ChannelConstants",["ChannelConstants"],function(a,b,c,d){a.ChannelConstants=b('ChannelConstants');},3);
__d("SimpleDrag",["event-extensions","ArbiterMixin","Class","UserAgent","Vector","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('Class'),i=b('UserAgent'),j=b('Vector'),k=b('copyProperties');function l(m){this.minDragDistance=0;Event.listen(m,'mousedown',this._start.bind(this));}k(l.prototype,g,{setMinDragDistance:function(m){this.minDragDistance=m;},_start:function(event){var m=false,n=true,o=null;if(this.inform('mousedown',event))n=false;if(this.minDragDistance){o=j.getEventPosition(event);}else{m=true;if(this.inform('start',event))n=false;}var p=i.ie()<9?document.documentElement:window,q=Event.listen(p,{selectstart:n?Event.prevent:bagofholding,mousemove:function(event){if(!m){var r=j.getEventPosition(event);if(o.distanceTo(r)<this.minDragDistance)return;m=true;this.inform('start',event);}this.inform('update',event);}.bind(this),mouseup:function(event){for(var r in q)q[r].remove();if(m){this.inform('end',event);}else this.inform('click',event);}.bind(this)});return !n;}});e.exports=l;});
__d("SystemEvents",["Arbiter","Env","ErrorUtils","UserAgent","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Env'),i=b('ErrorUtils'),j=b('UserAgent'),k=b('copyProperties'),l=new g(),m=[],n=1000;setInterval(function(){for(var w=0;w<m.length;w++)m[w]();},n,false);function o(){return (/c_user=(\d+)/.test(document.cookie)&&RegExp.$1)||0;}var p=h.user,q=navigator.onLine;function r(){if(!q){q=true;l.inform(l.ONLINE,q);}}function s(){if(q){q=false;l.inform(l.ONLINE,q);}}if(j.ie()){if(j.ie()>=8){window.attachEvent('onload',function(){document.body.ononline=r;document.body.onoffline=s;});}else m.push(function(){(navigator.onLine?r:s)();});}else if(window.addEventListener)if(!j.chrome()){window.addEventListener('online',r,false);window.addEventListener('offline',s,false);}var t=p;m.push(function(){var w=o();if(t!=w){l.inform(l.USER,w);t=w;}});var u=Date.now();function v(){var w=Date.now(),x=w-u,y=x<0||x>10000;u=w;if(y)l.inform(l.TIME_TRAVEL,x);return y;}m.push(v);m.push(function(){if(window.onerror!=i.onerror)window.onerror=i.onerror;});a.SystemEvents=e.exports=k(l,{USER:'SystemEvents/USER',ONLINE:'SystemEvents/ONLINE',TIME_TRAVEL:'SystemEvents/TIME_TRAVEL',isPageOwner:function(w){return (w||o())==p;},isOnline:function(){return j.chrome()||q;},checkTimeTravel:v});},3);
__d("csx",[],function(a,b,c,d,e,f){function g(h){throw new Error('csx(...): Unexpected class selector transformation.');}e.exports=g;});
__d("AccessibleLayer",["event-extensions","CSS","DOM","Input","copyProperties","csx","tx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('Input'),j=b('copyProperties'),k=b('csx'),l=b('tx');function m(n){this._layer=n;}j(m.prototype,{enable:function(){var n=this._layer.getRoot();if(n.tabIndex==-1)n.tabIndex=0;var o=h.create('a',{className:'accessible_elem',href:'#'},["Close popup and return"]);h.appendContent(n,o);this._listener=Event.listen(o,'click',this._closeListener.bind(this));this._afterShowSubscription=this._layer.subscribe('aftershow',this._onAfterShow.bind(this));},disable:function(){this._listener.remove();this._afterShowSubscription.unsubscribe();this._listener=this._afterShowSubscription=null;},_closeListener:function(event){var n=this._layer.getCausalElement();if(n){if(n.tabIndex==-1){n.tabIndex=0;g.addClass(n,"-cx-PRIVATE-accessibleLayer__noOutline");}i.focus(n);}this._layer.hide();},_onAfterShow:function(){var n=document.activeElement,o=this._layer.getRoot();if(!h.isNodeOfType(n,['input','textarea'])&&!h.contains(o,n))i.focus(o);}});e.exports=m;});
__d("Hovercard",["ClickRef","event-extensions","function-extensions","AccessibleLayer","Arbiter","AsyncRequest","AsyncSignal","ContextualDialogX","CSS","DOM","DOMQuery","LayerDestroyOnHide","LayerFadeOnHide","LayerFadeOnShow","Parent","Rect","UserAgent","URI","Vector","ViewportBounds","tx","userAction"],function(a,b,c,d,e,f){b('ClickRef');b('event-extensions');b('function-extensions');var g=b('AccessibleLayer'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('AsyncSignal'),k=b('ContextualDialogX'),l=b('CSS'),m=b('DOM'),n=b('DOMQuery'),o=b('LayerDestroyOnHide'),p=b('LayerFadeOnHide'),q=b('LayerFadeOnShow'),r=b('Parent'),s=b('Rect'),t=b('UserAgent'),u=b('URI'),v=b('Vector'),w=b('ViewportBounds'),x=b('tx'),y=b('userAction'),z=450,aa=385,ba={},ca={},da=null,ea=null,fa=null,ga=150,ha=700,ia=1000,ja=250,ka=null,la=null,ma=null,na=null;function oa(){if(t.ie()<7)return;Event.listen(document.documentElement,'mouseover',pa);Event.listen(window,'scroll',function(){kb.hide(true);});h.subscribe('page_transition',function(){va();kb.dirtyAll();},h.SUBSCRIBE_NEW);h.subscribe('layer_shown',function(lb,mb){if(mb.type!='Hovercard'&&mb.type!='ContextualDialog')va();},h.SUBSCRIBE_NEW);k.subscribe('arrow_rendered',xa,h.SUBSCRIBE_NEW);}function pa(event){var lb=r.byTag(event.getTarget(),'a');kb.processNode(lb)&&event.stop();}function qa(lb){ea=lb;if(!ra(lb)){var mb;if(!lb||!(mb=sa(lb))){ca.moveToken&&ca.moveToken.remove();ca={};return false;}if(ca.node!=lb){ca.moveToken&&ca.moveToken.remove();ca={node:lb,endpoint:mb,pos:null};}}return true;}function ra(lb){return lb&&da&&ca.node==lb;}function sa(lb){return lb.getAttribute('data-hovercard');}function ta(lb){var mb=Event.listen(lb,'mouseout',function(){clearTimeout(ka);clearTimeout(la);mb.remove();ea=null;kb.hide();});if(!ca.moveToken)ca.moveToken=Event.listen(lb,'mousemove',function(event){ca.pos=v.getEventPosition(event);});clearTimeout(ka);clearTimeout(la);clearTimeout(na);var nb=ga,ob=da?ja:ha;if(lb.getAttribute('data-hovercard-instant'))nb=ob=50;ka=setTimeout(gb.curry(lb),nb);la=setTimeout(ua.curry(lb),ob);}function ua(lb,mb){if(ca.node!=lb)return;var nb=ba[sa(lb)];if(nb){wa(nb);}else if(mb){wa(ib());}else{var ob=da?ja:ha;ma=setTimeout(ua.curry(lb,true),ia-ob);}}function va(){kb.hide(true);clearTimeout(la);}function wa(lb){var mb=ca.node,nb=da,ob=nb!=mb;if(da){var pb=k.getInstance(da);pb&&pb.hide();}if(!m.contains(document.body,mb)){kb.hide(true);return;}da=mb;fa=lb;cb();lb.setContext(mb).show();if(ob){(function(){new j('/ajax/hovercard/shown.php').send();y('himp',da,null,'FORCE',{ft:{evt:39}});}).defer();if(nb){h.inform('Hovercard/hide',{node:nb});}else h.inform('layer_shown',{type:'Hovercard'});h.inform('Hovercard/show',{node:mb});}}function xa(lb,mb){var nb=ba[ca.endpoint];if(mb.type!=='ContextualDialog'||!nb||!mb.root||mb.position!=='top')return;var ob=n.scry(mb.root,'.CustomArrow')[0];if(!ob)return;var pb=n.scry(ob,'.ArrowShadow')[0];if(!pb)return;var qb=null;if(ob.style.webkitMaskPosition!==undefined){qb=ab;}else if(ya(ob))qb=bb;if(qb){l.addClass(mb.root,'withCustomArrow');setTimeout(function(){qb(ob,pb,mb);},0);}}function ya(lb){if(!lb)lb=document.body;var mb=['transform','WebkitTransform','msTransform','MozTransform','OTransform'],nb;while(nb=mb.shift())if(lb.style[nb]!==undefined)return nb;return null;}function za(lb,mb,nb){var ob=lb.parentNode.offsetWidth,pb=Math.round(ob*nb.offset_percent/100);if(nb.side==='left'){pb=pb+nb.side_margin;}else if(nb.side==='right')pb=ob-pb-nb.side_margin-18;return pb;}function ab(lb,mb,nb){l.addClass(nb.root,'usingMask');var ob=za(lb,mb,nb);lb.style.webkitMaskPositionX=ob+'px';mb.style.left=ob+'px';}function bb(lb,mb,nb){var ob=n.scry(lb,'.CoverPhoto')[0];if(!ob)return;var pb=ya(lb);if(!pb)return;l.addClass(nb.root,'usingRotate');var qb=za(lb,mb,nb)+9,rb=Math.ceil(qb/Math.SQRT2);ob.style[pb]='translate('+(-rb)+'px, '+rb+'px) rotate(-45deg)';lb.style[pb]='translate('+qb+'px, 0) rotate(45deg)';}function cb(){var lb=v.getViewportDimensions(),mb=v.getElementPosition(da,'viewport'),nb=mb.convertTo('document'),ob=fb(da),pb='above',qb='left',rb=eb(nb,ob,'above');if(mb.y+rb<=aa){var sb=eb(nb,ob,'below');if(mb.y+sb+da.offsetHeight+aa<lb.y){pb='below';rb=sb;}}var tb=lb.x-w.getRight(),ub=db(nb,ob,'left');if(mb.x+ub+z>=tb){var vb=db(nb,ob,'right');if(mb.x+vb+da.offsetWidth>z){qb='right';ub=vb;}}fa.setPosition(pb).setAlignH(qb).setOffsetX(ub).setOffsetY(rb);}function db(lb,mb,nb){if(nb=='left')return mb.l-lb.x;return mb.r-(lb.x+da.offsetWidth);}function eb(lb,mb,nb){if(nb=='above')return mb.t-lb.y;return mb.b-(lb.y+da.offsetHeight);}function fb(lb){var mb=ca.pos,nb=lb.getClientRects();if(!mb||nb.length===0)return s.getElementBounds(lb);var ob,pb=false;for(var qb=0;qb<nb.length;qb++){var rb=new s(Math.round(nb[qb].top),Math.round(nb[qb].right),Math.round(nb[qb].bottom),Math.round(nb[qb].left),'viewport').convertTo('document'),sb=rb.getPositionVector(),tb=sb.add(rb.getDimensionVector());if(!ob||(sb.x<=ob.l&&sb.y>ob.t)){if(pb)break;ob=new s(sb.y,tb.x,tb.y,sb.x,'document');}else{ob.t=Math.min(ob.t,sb.y);ob.b=Math.max(ob.b,tb.y);ob.r=tb.x;}if(rb.contains(mb))pb=true;}return ob;}function gb(lb){if(lb.id&&ba[lb.id]!=null)return;var mb=sa(lb);if(ba[mb]!=null)return;hb(mb);var nb=function(){kb.dirty(mb);va();};new i(mb).setData({endpoint:mb}).setMethod('GET').setReadOnly(true).setErrorHandler(nb).setTransportErrorHandler(nb).send();}function hb(lb){ba[lb]=false;}var ib=function(){var lb=new k({},m.create('div',{className:'HovercardLoading'},"Loading..."));lb.disableBehavior(g).disableBehavior(o).disableBehavior(q).disableBehavior(p);jb(lb);ib=bagof(lb);return lb;};function jb(lb){lb.subscribe('mouseenter',function(){clearTimeout(na);ea=ca.node;});lb.subscribe('mouseleave',function(){kb.hide(false);ea=null;});}var kb={hide:function(lb){if(!da)return;if(lb){if(fa){h.inform('layer_hidden',{type:'Hovercard'});h.inform('Hovercard/hide',{node:da});fa.hide();}ea=null;da=null;fa=null;}else na=setTimeout(kb.hide.curry(true),ja);},setDialog:function(lb,mb){mb.disableBehavior(g);ba[lb]=mb;jb(mb);if(ca.endpoint==lb&&ea==ca.node)wa(mb);},getDialog:function(lb){return ba[lb];},contains:function(lb){if(fa)return m.contains(fa.getRoot(),lb);return false;},dirty:function(lb){var mb=ba[lb];if(mb){mb.destroy();delete ba[lb];}},dirtyAll:function(){for(var lb in ba){var mb=ba[lb];mb&&kb.dirty(lb);}h.inform('Hovercard/dirty');},processNode:function(lb){if(lb&&qa(lb)){ta(lb);return true;}return false;}};if(!a.Hovercard){oa();}else kb=a.Hovercard;e.exports=kb;a.Hovercard=e.exports;});
__d("MercuryUnseenState",["Arbiter","copyProperties","TimestampConverter","KeyedCallbackManager","JSLogger","createObjectFrom","MercuryServerRequests","MercuryThreadInformer","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('TimestampConverter'),j=b('KeyedCallbackManager'),k=b('JSLogger'),l=b('createObjectFrom'),m=b('MercuryServerRequests'),n=b('MercuryThreadInformer'),o=c('MercuryConstants'),p=o.MercuryThreadlistConstants.MAX_UNSEEN_COUNT,q=0,r=0,s=false,t=new j(),u='unseen_thread_hash',v='unseen_thread_list',w=k.create('mercury_unseen_state'),x={getUnseenCount:function(){if(this.exceedsMaxCount()){w.error('unguarded_unseen_count_fetch',{});return 0;}return ba();},exceedsMaxCount:function(){return s||(ba()>p);},markAsSeen:function(){if(ba()>0||s){m.markSeen();da(i.convertActionIDToTimestamp(m.getLastActionID()),[]);}},markThreadSeen:function(ka,la){var ma={};ma[ka]=null;fa(ma,la);}};function y(ka){t.setResource(u,ka);t.setResource(v,Object.keys(ka));}function z(ka){var la=t.executeOrEnqueue(u,ka),ma=t.getUnavailableResources(la);if(ma.length)m.fetchUnseenThreadIDs();}function aa(){return t.getResource(u);}function ba(){var ka=t.getResource(v);if(ka){return ka.length;}else return q;}function ca(ka){var la=ja(ka);if(ka.unseen_thread_ids){ka.unseen_thread_ids.forEach(function(wa){if(wa.folder!=o.MessagingTag.INBOX)return;var xa=ha(wa.thread_ids),ya=r;if(la&&la.seen_timestamp)ya=la.seen_timestamp;da(ya,xa);if(la&&la.unseen_count>p)s=true;});}else if(la&&la.seen_timestamp){r=la.seen_timestamp;if(la.unseen_count>p){s=true;y({});}else{q=la.unseen_count;if(q===0)y({});}}else{if(s)return;var ma=ka.actions;if(!ma||!(ma.length))return;var na={},oa={};for(var pa=0;pa<ma.length;pa++){var qa=ma[pa];if(qa.is_forward)continue;var ra=qa.action_type,sa=qa.action_id,ta=qa.thread_id?qa.thread_id:qa.server_thread_id,ua=qa.folder===undefined||qa.folder==o.MessagingTag.INBOX;if(!ua)continue;if(ra==o.MercuryActionType.USER_GENERATED_MESSAGE||ra==o.MercuryActionType.LOG_MESSAGE){var va=i.isGreaterThan(sa,na[ta]);if(qa.is_unread&&(!na[ta]||va))na[ta]=sa;}else if(ra==o.MercuryActionType.CHANGE_READ_STATUS&&qa.mark_as_read)oa[ta]=sa;}ea(na);fa(oa);}}function da(ka,la){var ma=aa();if(ma===undefined||ka>r||s){r=ka;la=la||[];if(la.length<=p)s=false;var na={},oa=aa()||{};for(var pa in oa)if(oa[pa]!==true){var qa=oa[pa];if(ga(qa))na[pa]=qa;}var ra=h(l(la,true),na);y(ra);n.updatedUnseenState();}}function ea(ka){if(s)return;var la={},ma=false;for(var na in ka){var oa=ka[na];if(ga(oa)){la[na]=oa;ma=true;}}if(!ma)return;z(function(pa){for(var qa in la){var ra=la[qa];if(!pa[qa]&&ga(ra))pa[qa]=la[qa];}y(pa);n.updatedUnseenState();});}function fa(ka,la){var ma=false;for(var na in ka){ma=true;break;}if(ma)z(function(oa){var pa=false;for(var qa in ka){var ra=ka[qa],sa=i.isGreaterThan(ra,oa[qa]);if(oa[qa]&&(!ra||sa)){delete oa[qa];pa=true;}}if(pa){y(oa);n.updatedUnseenState();if(la&&ba()===0)m.markSeen();}});}function ga(ka){return i.convertActionIDToTimestamp(ka)>r;}function ha(ka){return ka.map(m.convertThreadIDIfAvailable);}function ia(ka){var la=aa();if(!la)return;for(var ma in ka){var na=ka[ma];if(la[ma]){la[na]=la[ma];delete la[ma];}}y(la);}function ja(ka){var la=(ka.message_counts||[]);for(var ma=0;ma<la.length;ma++)if(la[ma].folder==o.MessagingTag.INBOX)return la[ma];return null;}m.subscribe('update-unseen',function(ka,la){ca(la);});m.subscribe('update-thread-ids',function(ka,la){ia(la);});g.subscribe(k.DUMP_EVENT,function(ka,la){la.messaging=la.messaging||{};la.messaging.unseen=h({},aa());la.messaging.unseen_max_count=s;la.messaging.unseen_time=r;});e.exports=x;});
__d("MercurySeenByAll",["CSS","DataStore","DOM","MercuryMessages","MercuryParticipants","MercuryRoger","MercuryThreads"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DataStore'),i=b('DOM'),j=b('MercuryMessages'),k=b('MercuryParticipants'),l=b('MercuryRoger'),m=b('MercuryThreads'),n={},o={updateOnSeenChange:function(r,s){n[r.tagName]=true;h.set(r,'thread-id',s.thread_id);g.addClass(r,'seenByListener');p(r,s);}};function p(r,s){var t=s.participants.filter(function(w){return w!==k.user;}),u=q(s),v=s.participants.length>0&&s.participants[0]===k.user;g.conditionClass(r,'repliedLast',v);g.conditionClass(r,'seenByAll',v&&l.getSeenBy(u).length===t.length);}function q(r){return {author:k.user,thread_id:r.thread_id,timestamp:r.timestamp};}l.subscribe('state-changed',function(r,s){for(var t in n){var u=i.scry(document.body,t+'.seenByListener');for(var v=0;v<u.length;v++){var w=u[v],x=h.get(w,'thread-id');if(s[x])m.getThreadMeta(x,function(y){p(w,y);});}}});e.exports=o;});
__d("AsyncLayout",["AjaxPipeRequest","Arbiter","AsyncResponse","AsyncRequest","CSS","DOM","HTML","NavigationMessage","PageTransitions","URI","$","copyProperties","ge","goURI"],function(a,b,c,d,e,f){var g=b('AjaxPipeRequest'),h=b('Arbiter'),i=b('AsyncResponse'),j=b('AsyncRequest'),k=b('CSS'),l=b('DOM'),m=b('HTML'),n=b('NavigationMessage'),o=b('PageTransitions'),p=b('URI'),q=b('$'),r=b('copyProperties'),s=b('ge'),t=b('goURI');function u(v){this.canvasID=v;if(s('rightCol'))this.auxiliaryID='rightCol';if(s('headerArea'))this.headerID='headerArea';if(s('toolbarContainer'))this.toolbarID='toolbarContainer';this.waitingForAux=false;o.registerHandler(this.catchPageTransition.bind(this));this.subscription=h.subscribe(n.NAVIGATION_BEGIN,this.onNavigate.bind(this));}r(u.prototype,{catchPageTransition:function(v){this.subscription.unsubscribe();return false;},getCanvasID:function(v){return v.sidecol?'contentCol':'contentArea';},onNavigate:function(v,w){var x=w.useAjaxPipe;w=w.params;if(w.endpoint){if(this.request){this.request.setFinallyHandler(bagofholding);this.request.abort();}if(this.sideRequest)this.sideRequest.abort();if(x){this.request=new g().setURI(w.endpoint).setData(w).setCanvasId(this.getCanvasID(w)).setFinallyHandler(this.finallyHandler.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFirstResponseCallback(this.firstResponseCallback.bind(this)).send();}else{w.handled=true;this.waitingForAux=w.sidecol;var y=!!w.iframe,z=new j().setOption('useIframeTransport',y).setURI(new p(w.endpoint)).setReadOnly(true).setMethod('GET').setData(w).setHandler(this.onResponse.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFinallyHandler(this.finallyHandler.bind(this));this.request=z;z.send();}}},onSideResponse:function(v){var w=v.getPayload();if(w&&this.auxiliaryID)this.receivedAux(w);},receivedAux:function(v){!this.waitingForAux;this.waitingForAux=false;l.setContent(q(this.auxiliaryID),m(v));},onResponse:function(v){var w=v.getPayload();if(w.redirect){t(w.redirect);}else{var x=w.html||w;l.setContent(q(this.canvasID),m(x));if(w.side_html&&this.auxiliaryID)this.receivedAux(w.side_html);if(this.headerID&&!w.keep_header){var y=q(this.headerID);l.setContent(y,m(w.header_html||''));k.conditionShow(y,w.header_html);}if(w.toolbar_html&&this.toolbarID)l.setContent(q(this.toolbarID),m(w.toolbar_html));if(w.js)(new Function(w.js))();k.conditionClass('contentCol','hasRightCol',this.auxiliaryID&&!w.noRightSide);var z=s('rightCol');if(z&&w.noRightSide)l.empty(z);}var aa=v.getRequest().getData();h.inform(n.NAVIGATION_COMPLETED,aa.key);},errorHandler:function(v){i.verboseErrorHandler(v);h.inform(n.NAVIGATION_FAILED);this.request=null;},firstResponseCallback:function(v){window.scrollTo(0,0);h.inform(n.NAVIGATION_FIRST_RESPONSE);},finallyHandler:function(v){this.request=null;o.transitionComplete(true);h.inform(n.NAVIGATION_COMPLETED);}});e.exports=u;});
__d("Dcode",[],function(a,b,c,d,e,f){var g,h={},i={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};(function(){var k=[];for(var l in i){h[i[l]]=l;k.push(i[l]);}k.reverse();g=new RegExp(k.join("|"),'g');})();var j={encode:function(k){return encodeURIComponent(k).replace(/([_A-Z])|%../g,function(l,m){return m?'%'+m.charCodeAt(0).toString(16):l;}).toLowerCase().replace(g,function(l){return h[l];});},decode:function(k){return decodeURIComponent(k.replace(/[_A-Z]/g,function(l){return i[l];}));}};e.exports=j;});
__d("ImageUtils",["UserAgent"],function(a,b,c,d,e,f){var g=b('UserAgent'),h={hasLoaded:function(i){if(i.naturalWidth!==undefined){return i.complete&&i.width!==0;}else if(i.height==20&&i.width==20&&i.complete){return false;}else if(i.complete===undefined&&g.safari()<500){var j=new Image();j.src=i.src;return j.complete;}return i.complete;}};e.exports=h;});
__d("throttle",["debounce"],function(a,b,c,d,e,f){var g=b('debounce');function h(i,j,k){return g(i,j,k,false,true);}e.exports=h;});
__d("OnVisible",["event-extensions","Arbiter","DOM","Run","Vector","copyProperties","throttle"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('DOM'),i=b('Run'),j=b('Vector'),k=b('copyProperties'),l=b('throttle');function m(n,o,p,q){this.element=n;this.handler=o;this.strict=p;this.buffer=q||300;this.scrollHandler=null;this.reset();i.onLeave(this.remove.bind(this));}k(m.prototype,{reset:function(){if(this.scrollListener)return;this.removed=false;this.scrollHandler=l(function(n){var o=j.getElementPosition(this.element);if(!o||this.removed){this.remove();return;}this.targetY=o.y;var p=j.getScrollPosition().y,q=j.getViewportDimensions().y,r=p+q+this.buffer;if(r>this.targetY){var s=!this.strict||(p-this.buffer<(this.targetY+j.getElementDimensions(this.element).y));if(s){this.remove();this.handler(!n);}}return true;},100,this);(function(){this.scrollListener=Event.listen(window,'scroll',this.scrollHandler);this.resizeListener=Event.listen(window,'resize',this.scrollHandler);this.domScrollListener=g.subscribe('dom-scroll',this.scrollHandler);this.scrollHandler.defer();}).bind(this).defer();},remove:function(){this.removed=true;if(this.scrollListener){this.scrollListener.remove();this.resizeListener.remove();this.domScrollListener.unsubscribe();this.scrollListener=this.resizeListener=this.domScrollListener=null;}},setBuffer:function(n){this.buffer=n;this.scrollHandler&&this.scrollHandler.defer();}});e.exports=m;});
__d("ScrollAwareDOM",["ArbiterMixin","CSS","DOM","DOMDimensions","DOMPosition","DOMQuery","HTML","Vector","ViewportBounds","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('CSS'),i=b('DOM'),j=b('DOMDimensions'),k=b('DOMPosition'),l=b('DOMQuery'),m=b('HTML'),n=b('Vector'),o=b('ViewportBounds'),p=b('copyProperties');function q(v,w){return function(){u.monitor(arguments[v],w.curry.apply(w,arguments));};}function r(v){if(!(v instanceof Array))v=[v];for(var w=0;w<v.length;w++){var x=m.replaceJSONWrapper(v[w]);if(x instanceof m){return x.getRootNode();}else if(i.isNode(x))return x;}return null;}function s(v){return k.getElementPosition(v).y>=o.getTop();}function t(v){var w=k.getElementPosition(v).y+j.getElementDimensions(v).height,x=j.getViewportDimensions().height-o.getBottom();return w>=x;}var u=p({monitor:function(v,w){var x=r(v);if(x){var y=!!x.offsetParent;if(y&&(s(x)||t(x)))return w();var z=n.getDocumentDimensions(),aa=w();if(y||(x.offsetParent&&!s(x))){var ba=n.getDocumentDimensions().sub(z);if(u.inform('scroll',{delta:ba})!==false)ba.scrollElementBy(l.getDocumentScrollElement());}return aa;}else return w();},replace:function(v,w){var x=r(w);if(!x||h.hasClass(x,'hidden_elem'))x=v;return u.monitor(x,function(){i.replace(v,w);});},prependContent:q(1,i.prependContent),insertAfter:q(1,i.insertAfter),insertBefore:q(1,i.insertBefore),setContent:q(0,i.setContent),appendContent:q(1,i.appendContent),remove:q(0,i.remove),empty:q(0,i.empty)},g);e.exports=u;});
__d("Token",["CSS","DataStore","DOM","copyProperties","tx"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DataStore'),i=b('DOM'),j=b('copyProperties'),k=b('tx');function l(m,n){this.info=m;this.paramName=n;}j(l.prototype,{getInfo:function(){return this.info;},getText:function(){return this.info.text;},getValue:function(){return this.info.uid;},isFreeform:function(){return !!this.info.freeform;},getElement:function(){if(!this.element)this.setElement(this.createElement());return this.element;},setElement:function(m){h.set(m,'Token',this);this.element=m;return this;},isRemovable:function(){return g.hasClass(this.element,'removable');},createElement:function(){var m=this.paramName,n=this.getText(),o=this.getValue(),p=i.create('a',{href:'#','aria-label':k._("Remove {item}",{item:n}),className:'remove uiCloseButton uiCloseButtonSmall'}),q=i.create('input',{type:'hidden',value:o,name:m+'[]',autocomplete:'off'}),r=i.create('input',{type:'hidden',value:n,name:'text_'+m+'[]',autocomplete:'off'}),s=i.create('span',{className:'removable uiToken'},[n,q,r,p]);return s;}});e.exports=l;});
__d("UserActivity",["event-extensions","Arbiter","ClickRefUtils","collectDataAttributes"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ClickRefUtils'),i=b('collectDataAttributes'),j=5000,k=500,l=Date.now(),m=l,n={subscribeOnce:function(p){var q=n.subscribe(function(){n.unsubscribe(q);p();});},subscribe:function(p){return g.subscribe('useractivity/activity',p);},unsubscribe:function(p){p.unsubscribe();},isActive:function(p){return (new Date()-l<(p||n.DEFAULT_IDLE_MS));},getLastInformTime:function(){return m;}};function o(event){l=Date.now();var p=l-m;if(p>k){m=l;g.inform('useractivity/activity',{event:event,idleness:p});}}Event.listen(document.documentElement,{DOMMouseScroll:o,mousewheel:o,keydown:o,mouseover:o,click:o});e.exports=n;});
__d("reportData",["EagleEye","userAction"],function(a,b,c,d,e,f){var g=b('EagleEye'),h=b('userAction');function i(j,k){k=k||{};var l={ft:(k.ft||{}),gt:(k.gt||{})},m='-',n=a.ArbiterMonitor,o=(!!n)?n.getActFields():[],p=(!n)?'r':'a',q=[Date.now(),h.getCurrentUECount(),m,j,m,m,p,a.URI?a.URI.getRequestURI(true,true).getUnqualifiedURI().toString():location.pathname+location.search+location.hash,l,0,0,0,0].concat(o);g.log('act',q);}e.exports=i;});
__d("legacy:onvisible",["OnVisible"],function(a,b,c,d){a.OnVisible=b('OnVisible');},3);
__d("PhotoEverstoreLogger",["event-extensions","AsyncRequest","copyProperties","ImageUtils"],function(a,b,c,d,e,f){b('event-extensions');var g=b('AsyncRequest'),h=b('copyProperties'),i=b('ImageUtils'),j={BATCH_WINDOW_MS:500,storedLog:[]};function k(){}h(k,{_log:function(m){j.storedLog.push(m);if(j.storedLog.length==1)setTimeout(l,j.BATCH_WINDOW_MS,false);},logImmediately:function(m){k._log(m);},registerForLogging:function(m){if(i.hasLoaded(m)){k._log(m.src);}else Event.listen(m,'load',function(event){k._log(m.src);});}});function l(){var m=j.storedLog;j.storedLog=[];var n=JSON.stringify(m);new g().setURI('/ajax/photos/logging/everstore_logging.php').setData({loggedUrls:n}).setMethod('POST').setOption('suppressErrorHandlerWarning',true).setOption('suppressErrorAlerts',true).send();}e.exports=k;});
function ufi_add_ft_hidden_node(a){if(a.link_data)return;var b=collect_data_attribs(a,['ft']).ft;if(Object.keys(b).length){var c=DOM.create('input',{type:'hidden',name:'link_data',value:JSON.stringify(b)});a.appendChild(c);}}function ufi_add_all_link_data(){Bootloader.loadComponents('dom-collect',function(){DOM.scry(document.body,'form.commentable_item').forEach(ufi_add_ft_hidden_node);});}function question_add_all_link_data(){Bootloader.loadComponents('dom-collect',function(){DOM.scry(document.body,'form.fbEigenpollForm').forEach(ufi_add_ft_hidden_node);DOM.scry(document.body,'form.fbQuestionPollForm').forEach(ufi_add_ft_hidden_node);});}
__d("UIPagelet",["AjaxPipeRequest","AsyncRequest","DOM","HTML","URI","copyProperties","ge"],function(a,b,c,d,e,f){var g=b('AjaxPipeRequest'),h=b('AsyncRequest'),i=b('DOM'),j=b('HTML'),k=b('URI'),l=b('copyProperties'),m=b('ge');function n(o,p,q,r){this._id=o||null;this._element=m(o||i.create('div'));this._src=p||null;this._context_data=q||{};this._data=r||{};this._handler=bagofholding;this._request=null;this._use_ajaxpipe=false;this._is_bundle=true;this._allow_cross_page_transition=false;this._append=false;return this;}n.loadFromEndpoint=function(o,p,q,r){r=r||{};var s='/ajax/pagelet/generic.php/';if(r.intern)s='/intern'+s;var t=(s+o).replace(/\/+/g,'/');if(r.subdomain)t=k(t).setSubdomain(r.subdomain);var u=new n(p,t,q).setUseAjaxPipe(r.usePipe).setPageletCacheMiss(r.pageletCacheMiss).setBundleOption(o.substring(0,8)!='/intern/'&&r.bundle!==false).setAppend(r.append).setJSNonBlock(r.jsNonblock).setForceFinish(r.forceFinish).setAutomatic(r.automatic).setDisplayCallback(r.displayCallback).setConstHeight(r.constHeight).setAllowCrossPageTransition(r.crossPage);r.handler&&u.setHandler(r.handler);u.go();return u;};l(n.prototype,{getElement:function(o){o=o||false;if(o)this._element=m(this._id);return this._element;},setHandler:function(o){this._handler=o;return this;},go:function(o,p){if(arguments.length>=2||typeof o=='string'){this._src=o;this._data=p||{};}else if(arguments.length==1)this._data=o;this.refresh();return this;},setAllowCrossPageTransition:function(o){this._allow_cross_page_transition=o;return this;},setBundleOption:function(o){this._is_bundle=o;return this;},refresh:function(o){var p=function(s){this._request=null;if(o&&this._id)this._element=m(this._id);var t=j(s.getPayload());if(this._append){i.appendContent(this._element,t);}else i.setContent(this._element,t);this._handler();}.bind(this);if(this._use_ajaxpipe){this._request=new g();this._request.setCanvasId(this._id).setAppend(this._append).setConstHeight(this._constHeight).setJSNonBlock(this._jsNonblock).setForceFinish(this._forceFinish).setAutomatic(this._automatic).setPageletCacheMiss(this._pageletCacheMiss).setDisplayCallback(this._displayCallback);}else{var q=this._displayCallback;this._request=new h().setMethod('GET').setReadOnly(true).setOption('bundle',this._is_bundle).setHandler(function(s){if(q){q(p.curry(s));}else p(s);});}var r={};l(r,this._context_data);l(r,this._data);this._request.setURI(this._src).setAllowCrossPageTransition(this._allow_cross_page_transition).setData({data:JSON.stringify(r)}).send();return this;},cancel:function(){if(this._request)this._request.abort();},setUseAjaxPipe:function(o){this._use_ajaxpipe=!!o;return this;},setPageletCacheMiss:function(o){this._pageletCacheMiss=o;return this;},setAppend:function(o){this._append=!!o;return this;},setJSNonBlock:function(o){this._jsNonblock=!!o;return this;},setForceFinish:function(o){this._forceFinish=!!o;return this;},setAutomatic:function(o){this._automatic=!!o;return this;},setDisplayCallback:function(o){this._displayCallback=o;return this;},setConstHeight:function(o){this._constHeight=!!o;return this;}});e.exports=n;});
__d("legacy:UIPagelet",["UIPagelet"],function(a,b,c,d){a.UIPagelet=b('UIPagelet');},3);
__d("ScrollableArea",["array-extensions","event-extensions","Animation","ArbiterMixin","CSS","DataStore","DOM","Parent","Run","SimpleDrag","Style","UserAgent","Vector","copyProperties"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Animation'),h=b('ArbiterMixin'),i=b('CSS'),j=b('DataStore'),k=b('DOM'),l=b('Parent'),m=b('Run'),n=b('SimpleDrag'),o=b('Style'),p=b('UserAgent'),q=b('Vector'),r=b('copyProperties');function s(t,u){if(!t)return;u=u||{};this._elem=t;this._wrap=k.find(t,'div.uiScrollableAreaWrap');this._body=k.find(this._wrap,'div.uiScrollableAreaBody');this._content=k.find(this._body,'div.uiScrollableAreaContent');this._track=k.find(t,'div.uiScrollableAreaTrack');this._gripper=k.find(this._track,'div.uiScrollableAreaGripper');this._options=u;this.adjustGripper.bind(this).defer();this._listeners=[Event.listen(this._wrap,'scroll',this._handleScroll.bind(this))];if(u.fade!==false)this._listeners.push(Event.listen(t,'mouseenter',this.showScrollbar.shield(this)),Event.listen(t,'mousemove',this._handleMousemove.bind(this)),Event.listen(t,'mouseout',this.hideScrollbar.shield(this)));if(p.safari()||p.chrome()){this._listeners.push(Event.listen(t,'mousedown',function(){var v=Event.listen(window,'mouseup',function(){if(t.scrollLeft)t.scrollLeft=0;v.remove();});}));}else if(p.firefox())this._wrap.addEventListener('DOMMouseScroll',function(event){event.axis===event.HORIZONTAL_AXIS&&event.preventDefault();},false);this.initDrag();j.set(this._elem,'ScrollableArea',this);if(!u.persistent)m.onLeave(this.destroy.bind(this));}r(s,{renderDOM:function(){var t=k.create('div',{className:'uiScrollableAreaContent'}),u=k.create('div',{className:'uiScrollableAreaBody'},t),v=k.create('div',{className:'uiScrollableAreaWrap'},u),w=k.create('div',{className:'uiScrollableArea native'},v);return {root:w,wrap:v,body:u,content:t};},fromNative:function(t,u){if(!i.hasClass(t,'uiScrollableArea')||!i.hasClass(t,'native'))return;u=u||{};i.removeClass(t,'native');var v=k.create('div',{className:'uiScrollableAreaTrack'},k.create('div',{className:'uiScrollableAreaGripper'}));if(u.fade!==false){i.addClass(t,'fade');i.addClass(v,'invisible_elem');}else i.addClass(t,'nofade');k.appendContent(t,v);var w=new s(t,u);w.resize();return w;},getInstance:function(t){var u=l.byClass(t,'uiScrollableArea');return u?j.get(u,'ScrollableArea'):null;},poke:function(t){var u=s.getInstance(t);u&&u.poke();}});r(s.prototype,h,{initDrag:function(){var t=new n(this._gripper);t.subscribe('start',function(u,event){if(!((event.which&&event.which===1)||(event.button&&event.button===1)))return;var v=q.getEventPosition(event).y,w=this._gripper.offsetTop,x=t.subscribe('update',function(z,event){var aa=q.getEventPosition(event).y-v,ba=this._elem.clientHeight,ca=this._content.offsetHeight,da=this._track.offsetHeight,ea=ba/ca*da,fa=ca-this._wrap.offsetHeight,ga=w+aa,ha=da-ea;ga=Math.max(Math.min(ga,ha),0);var ia=ga/ha*fa;this._wrap.scrollTop=ia;}.bind(this)),y=t.subscribe('end',function(){t.unsubscribe(x);t.unsubscribe(y);});}.bind(this));},adjustGripper:function(){var t=this._elem.clientHeight,u=this._content.offsetHeight,v=this._track.offsetHeight,w=t/u*v;if(w<v){o.set(this._gripper,'height',w+'px');var x=this._wrap.scrollTop/u*v;o.set(this._gripper,'top',x+'px');i.show(this._gripper);}else i.hide(this._gripper);this._checkContentBoundaries();return this;},_checkContentBoundaries:function(){i.conditionClass(this._elem,'contentBefore',this._wrap.scrollTop>0);i.conditionClass(this._elem,'contentAfter',!this.isScrolledToBottom());},destroy:function(){this._listeners.forEach(function(t){t.remove();});this._listeners.length=0;},_handleMousemove:function(event){var t=q.getElementPosition(this._track).x,u=q.getElementDimensions(this._track).x;if(Math.abs(t+u/2-q.getEventPosition(event).x)<25){this.showScrollbar(false);}else this.hideScrollbar();},_handleScroll:function(event){this.adjustGripper();if(this._options.fade!==false)this.showScrollbar();this.inform('scroll');},hideScrollbar:function(t){if(!this._scrollbarVisible)return this;this._scrollbarVisible=false;if(this._hideTimeout){clearTimeout(this._hideTimeout);this._hideTimeout=null;}if(t){o.set(this._track,'opacity',0);i.addClass.curry(this._track,'invisible_elem');}else this._hideTimeout=function(){if(this._hideAnimation){this._hideAnimation.stop();this._hideAnimation=null;}this._hideAnimation=(new g(this._track)).from('opacity',1).to('opacity',0).duration(250).ondone(i.addClass.curry(this._track,'invisible_elem')).go();}.bind(this).defer(750);return this;},resize:function(){var t=q.getElementDimensions(this._elem).x;if(!this._options.fade)t-=10;t=Math.max(0,t);o.set(this._body,'width',t+'px');return this;},showScrollbar:function(t){this.adjustGripper();if(this._scrollbarVisible)return this;this._scrollbarVisible=true;if(this._hideTimeout){clearTimeout(this._hideTimeout);this._hideTimeout=null;}if(this._hideAnimation){this._hideAnimation.stop();this._hideAnimation=null;}o.set(this._track,'opacity',1);i.removeClass(this._track,'invisible_elem');if(t!==false)this.hideScrollbar();return this;},isScrolledToBottom:function(){return this._wrap.scrollTop>=this._wrap.scrollHeight-this._wrap.clientHeight;},scrollToBottom:function(t){this.setScrollTop(this._wrap.scrollHeight,t);},scrollToTop:function(t){this.setScrollTop(0,t);},scrollIntoView:function(t,u){var v=this._wrap.clientHeight,w=t.offsetHeight,x=this._wrap.scrollTop,y=x+v,z=t.offsetTop,aa=z+w;if(z<x||v<w){this.setScrollTop(z,u);}else if(aa>y)this.setScrollTop(x+(aa-y),u);},poke:function(){var t=this._wrap.scrollTop;this._wrap.scrollTop+=1;this._wrap.scrollTop-=1;this._wrap.scrollTop=t;return this.showScrollbar(false);},getScrollTop:function(){return this._wrap.scrollTop;},getScrollHeight:function(){return this._wrap.scrollHeight;},setScrollTop:function(t,u){if(u!==false){if(this._scrollTopAnimation)this._scrollTopAnimation.stop();this._scrollTopAnimation=(new g(this._wrap)).to('scrollTop',t).ease(g.ease.end).go();}else this._wrap.scrollTop=t;}});e.exports=s;});
__d("legacy:ScrollableArea",["ScrollableArea"],function(a,b,c,d){a.ScrollableArea=b('ScrollableArea');},3);
__d("legacy:JSLogger",["JSLogger"],function(a,b,c,d){a.JSLogger=b('JSLogger');},3);
__d("MessagingEvents",["array-extensions","Arbiter","ChannelConstants","copyProperties","isEmpty"],function(a,b,c,d,e,f){b('array-extensions');var g=b('Arbiter'),h=b('ChannelConstants'),i=b('copyProperties'),j=b('isEmpty'),k={},l=new g();function m(n){if(!j(k))return;for(var o in n)l.inform('count/'+o,n[o]);}l.subscribe('mark-as-read',function(n,o){(o.tids||o.chat_ids||[]).forEach(function(p){p=''+p;if(!(p in k)){k[p]=true;var q=function(){l.unsubscribe(r);clearTimeout(s);delete k[p];},r=l.subscribe('read',function(t,u){if((u.tids||[]).contains(p)||(u.chat_ids||[]).contains(p))q();}),s=q.defer(60000);}});});g.subscribe(h.getArbiterType('messaging'),function(n,o){var p=i({},o.obj),event=p.event||'';delete p.type;delete p.event;l.inform(event,p);if('unread_counts' in p){var q=p.unread_counts;m({unread:q.inbox,other_unseen:q.other});}});g.subscribe(h.getArbiterType('inbox'),function(n,o){var p=i(o.obj);delete p.type;m(p);});a.MessagingEvents=e.exports=l;},3);
__d("PagesVoiceBar",["$","Arbiter","AsyncRequest","CSS","ChannelConstants","DOM","PageTransitions"],function(a,b,c,d,e,f){var g=b('$'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('CSS'),k=b('ChannelConstants'),l=b('DOM'),m=b('PageTransitions'),n='PagesVoiceBar/toggle',o='PagesVoiceBar/initialized',p='PagesVoiceBar/switchVoice',q='page_transition',r='pages_voice_bar_sync',s=null,t=null,u=false,v=false;function w(){v=!v;j.conditionClass(document.body,'hasVoiceBar',v);}function x(da,ea){new i('/ajax/pages/switch_voice.php').setData(ea).setHandler(function(fa){ba();}).send();}function y(){s=null;}function z(da,ea){if(ea.obj.profile_id&&ea.obj.profile_id==s)ba();}function aa(da){h.subscribe(o,da);}function ba(){m.getNextURI().go();}var ca={initVoiceBar:function(){if(u)return;t=g('pagesVoiceBarContent');v=j.hasClass(document.body,'hasVoiceBar');h.subscribe(n,w);h.subscribe(p,x);h.subscribe(q,y);h.subscribe(k.getArbiterType(r),z);u=true;h.inform(o,null,h.BEHAVIOR_STATE);},update:function(da,ea){aa(function(){s=ea;l.setContent(t,da);});}};e.exports=ca;});
__d("AsyncUploadRequest",["ArbiterMixin","AsyncRequest","AsyncResponse","Form","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('AsyncResponse'),j=b('Form'),k=b('copyProperties');function l(n){this.setURI(n);}l.isSupported=function(){return ('FileList' in window)&&('FormData' in window);};k(l.prototype,g,{_limit:10,setAllowCrossOrigin:function(n){this._allowCrossOrigin=!!n;return this;},setData:function(n){this._data=n;return this;},setFiles:function(n){var o={};for(var p in n){var q=n[p];if(Array.isArray(q)){o[p]=q;}else{o[p]=[];if(q instanceof window.FileList){for(var r=0;r<q.length;r++)o[p].push(q.item(r));}else if(q instanceof window.File)o[p].push(q);}}this._files=o;return this;},setLimit:function(n){this._limit=n;return this;},setRelativeTo:function(n){this._relativeTo=n;return this;},setStatusElement:function(n){this._statusElement=n;return this;},setURI:function(n){this._uri=n;return this;},send:function(){if(this._inFlight)return;this._inFlight=true;this._uploads=[];for(var n in this._files)this._files[n].forEach(function(o){this._uploads.push(new m(n,o));}.bind(this));if(this._uploads.length){this._waiting=this._uploads.slice(0);this._pending=[];this._processQueue();}else this._processUpload(new m(null,null));},_processQueue:function(){while(this._pending.length<this._limit){if(!this._waiting.length)break;var n=this._waiting.shift();this._processUpload(n);this._pending.push(n);}},_processUpload:function(n){this.inform('start',n);var o=j.createFormData(this._data);if(n.getFile())o.append(n.getName(),n.getFile());new h().setAllowCrossOrigin(this._allowCrossOrigin).setURI(this._uri).setRawData(o).setRelativeTo(this._relativeTo).setStatusElement(this._statusElement).setHandler(this._success.bind(this,n)).setErrorHandler(this._failure.bind(this,n)).setUploadProgressHandler(this._progress.bind(this,n)).setInitialHandler(this._initial.bind(this,n)).send();},_initial:function(n){this.inform('initial',n);},_success:function(n,o){this.inform('success',n.handleSuccess(o));this._complete(n);},_failure:function(n,o){if(this.inform('failure',n.handleFailure(o))!==false)i.defaultErrorHandler(o);this._complete(n);},_progress:function(n,event){this.inform('progress',n.handleProgress(event));},_complete:function(n){this._pending.remove(n);this._processQueue();if(!this._pending.length){this._inFlight=false;this.inform('complete',this._uploads);}}});var m=function(n,o){this._name=n;this._file=o;this._success=null;this._response=null;this._progressEvent=null;};k(m.prototype,{getName:function(){return this._name;},getFile:function(){return this._file;},isComplete:function(){return this._success!==null;},isSuccess:function(){return this._success===true;},getResponse:function(){return this._response;},getProgressEvent:function(){return this._progressEvent;},handleSuccess:function(n){this._success=true;this._response=n;this._progressEvent=null;return this;},handleFailure:function(n){this._success=false;this._response=n;this._progressEvent=null;return this;},handleProgress:function(event){this._progressEvent=event;return this;}});e.exports=l;});
__d("FileForm",["event-extensions","ArbiterMixin","AsyncRequest","AsyncUploadRequest","AsyncResponse","BehaviorsMixin","DataStore","DOMQuery","Env","Form","JSONPTransport","URI","UserAgent","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('AsyncUploadRequest'),j=b('AsyncResponse'),k=b('BehaviorsMixin'),l=b('DataStore'),m=b('DOMQuery'),n=b('Env'),o=b('Form'),p=b('JSONPTransport'),q=b('URI'),r=b('UserAgent'),s=b('copyProperties');function t(v){var w={},x=m.scry(v,'input[type="file"]');x.forEach(function(y){w[y.name]=y.files;});return w;}function u(v,w,x){if(v.getAttribute('rel')==='async')throw new Error('FileForm cannot be used with Primer forms.');if(v.getAttribute('method').toUpperCase()!=='POST')throw new Error('FileForm must be used with POST forms.');this._form=v;this._form.enctype=this._form.encoding='multipart/form-data';w&&this.enableBehaviors(w);this._options=x||{};this.setAllowCrossOrigin(this._options.allowCrossOrigin);this.setUploadInParallel(this._options.uploadInParallel);this._listener=Event.listen(this._form,'submit',this._submit.bind(this));l.set(this._form,'FileForm',this);}s(u,{EVENTS:['submit','initial','progress','success','failure'],getInstance:function(v){return l.get(v,'FileForm');}});s(u.prototype,g,k,{getRoot:function(){return this._form;},setAllowCrossOrigin:function(v){this._allowCrossOrigin=!!v;return this;},setUploadInParallel:function(v){this._uploadInParallel=!!v;return this;},_submit:function(event){if(this.inform('submit')===false){event.prevent();return;}var v='FormData' in window;if(v)if(!q(this._form.action).isSameOrigin()&&!this._allowCrossOrigin)v=false;return v?this._sendViaXHR(event):this._sendViaFrame(event);},_sendViaFrame:function(event){var v=new h();v.setStatusElement(this._form);v.addStatusIndicator();v.setOption('useIframeTransport',true);var w=v.handleResponse.bind(v),x=new p('iframe',this._form.action,w),y=x.createTransportFrame(),z=x.getRequestURI().addQueryData({__iframe:true,__user:n.user});this._form.setAttribute('action',z.toString());this._form.setAttribute('target',y.name);v.setURI(z);v.setHandler(this.success.bind(this,null));v.setErrorHandler(this.failure.bind(this,null));v.setInitialHandler(this.initial.shield(this,null));},_sendViaXHR:function(event){var v;if(this._uploadInParallel&&i.isSupported()){v=new i().setData(o.serialize(this._form)).setFiles(t(this._form));var w=[v.subscribe('progress',function(x,y){this.progress(y,y.getProgressEvent());}.bind(this)),v.subscribe('initial',function(x,y){this.initial(y,y.getResponse());}.bind(this)),v.subscribe('success',function(x,y){this.success(y,y.getResponse());}.bind(this)),v.subscribe('failure',function(x,y){this.failure(y,y.getResponse());return false;}.bind(this)),v.subscribe('complete',function(){while(w.length)w.pop().unsubscribe();})];}else v=new h().setRawData(o.createFormData(this._form)).setHandler(this.success.bind(this,null)).setErrorHandler(this.failure.bind(this,null)).setUploadProgressHandler(this.progress.bind(this,null)).setInitialHandler(this.initial.shield(this,null));v.setAllowCrossOrigin(this._allowCrossOrigin).setRelativeTo(this._form).setStatusElement(this._form).setURI(this._form.action).send();event.prevent();},initial:function(v){return this.inform('initial',{upload:v});},success:function(v,w){var x={response:w,upload:v};if(this.inform('success',x)!==false)Event.fire(this._form,'success',x);},failure:function(v,w){var x={response:w,upload:v};if(this.inform('failure',x)!==false)if(Event.fire(this._form,'error',x)!==false)j.defaultErrorHandler(w);},progress:function(v,event){this.inform('progress',{event:event,upload:v});},destroy:function(){this._listener.remove();this._listener=null;if(isNaN(r.ie())||(r.ie()>8))this._form.encoding=null;this._form.enctype=null;l.remove(this._form,'FileForm');}});e.exports=u;});
__d("Composer",["function-extensions","Arbiter","ArbiterMixin","Button","Class","CSS","DOM","Env","FileForm","HTML","Input","PageTransitions","Parent","Run","ServerJS","TextAreaControl","URI","URLScraper","$","copyProperties","ge","tx","event-extensions"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Button'),j=b('Class'),k=b('CSS'),l=b('DOM'),m=b('Env'),n=b('FileForm'),o=b('HTML'),p=b('Input'),q=b('PageTransitions'),r=b('Parent'),s=b('Run'),t=b('ServerJS'),u=b('TextAreaControl'),v=b('URI'),w=b('URLScraper'),x=b('$'),y=b('copyProperties'),z=b('ge'),aa=b('tx');b('event-extensions');var ba=b('event-extensions').$E,ca=1,da=4,ea={},fa=function(){var ja=l.scry(this.root,'span.linkAttachment')[0];if(!ja&&this.isMetaComposer)ja=l.scry(this.root,'span.attachmentAcceptsLink')[0];if(!ja)return;var ka=r.byTag(ja,'form');this.scraper=new w(this.input);this.scraper.subscribe('match',function(la,ma){if(this.isMetaComposer){var na=this.form.xhpc_targetid,oa=new v('/ajax/metacomposer/attachment/link/scraper.php');oa.addQueryData({scrape_url:encodeURIComponent(ma.url),alt_scrape_url:encodeURIComponent(ma.alt_url),targetid:na.value});ka.action=oa.toString();}else{k.show(ja);ka.action='/ajax/composer/attachment/link/scraper.php?scrape_url='+encodeURIComponent(ma.url);}ka.xhpc.value=ja.id;ka.xhpc.disabled=false;ka.xhpc.click();}.bind(this));this.isMetaComposer&&this.scraper.check();},ga=function(ja){if(this.inform('submit')===false){ja.kill();return false;}if(this.submitHandler)return (new Function(this.submitHandler)).apply(this.form);};function ha(ja,ka,la,ma,na){ea[ja.id]=this;this.root=ja;this.resetCfg=ka;this.dataSource=ma;this.lazyEndpoint=this.resetCfg&&this.resetCfg.lazyEndpoint;this.focus=l.find(ja,'div.focus_target');this.form=l.find(ja,'form.attachmentForm');this.content=l.find(ja,'div.attachmentContent');this.isMetaComposer=la;if(this.isMetaComposer){this.messageBox=l.find(ja,'div.uiMetaComposerMessageBox');this.metaArea=l.find(ja,'div.attachmentMetaArea');this.bottomArea=l.find(ja,'div.attachmentBottomArea');this.barArea=l.find(ja,'div.attachmentBarArea');this.blurb=l.find(ja,'div.uiMetaComposerMessageBox div.textBlurb');this.input=l.find(ja,'div.uiMetaComposerMessageBox textarea.input');this.button=l.find(ja,'div.uiMetaComposerMessageBox label.submitBtn');this.privacy=l.find(ja,'div.uiMetaComposerMessageBox li.privacyWidget');this.boosting=l.scry(ja,'div.uiMetaComposerMessageBox li.boostingWidget');}else{this.blurb=l.find(ja,'div.uiComposerMessageBox div.textBlurb');this.input=l.find(ja,'div.uiComposerMessageBox textarea.input');this.button=l.find(ja,'div.uiComposerMessageBox label.submitBtn');this.privacy=l.find(ja,'div.uiComposerMessageBox li.privacyWidget');this.boosting=[];}Event.listen(this.form,'submit',ga.bind(this));if(this.isMetaComposer){Event.listen(this.input,'focus',this.onFocus.bind(this));if(na){if(document.activeElement===this.input)this.onFocus.bind(this).defer();}else if(r.byClass(this.input,'child_was_focused'))this.onFocus.bind(this).defer();}g.inform('xhpc/construct/'+ja.id,this,g.BEHAVIOR_STATE);}y(ha.prototype,h,{init:function(ja){this.mentionsInput=ja;if(this.mentionsInput)this.mentionsInput.subscribe('init',function(){var ka=this.mentionsInput.getTypeahead().getView();ka.subscribe(['reset','render'],function(la){k.conditionClass(this.root,'uiComposerMention',(la=='render'));}.bind(this));}.bind(this));fa.call(this);this.inform('init',null,g.BEHAVIOR_PERSISTENT);this.setupListen();s.onBeforeUnload(this._handleUnsavedChanges.bind(this));},setupListen:function(){Event.listen(this.root,'click',this.clickHandler.bind(this));},clickHandler:function(event){var ja=event.getTarget();if(r.byClass(ja,'collapsedPostButton'))this.focusInput.bind(this).defer();},setBlurb:function(ja){l.setContent(this.blurb,ja);},setEnabled:function(ja){i.setEnabled(this.button,ja);},getEndpoint:function(){return this.form.getAttribute('action');},setEndpoint:function(ja){this.form.setAttribute('action',ja);},setLoading:function(ja){k.conditionClass(this.root,'async_saving',!!ja);},setContentVisible:function(ja){k.conditionClass(this.root,'uiComposerHideContent',!ja);},setMessageBoxVisible:function(ja){k.conditionClass(this.root,'uiComposerHideMessageBox',!ja);},setInputVisible:function(ja){k.conditionClass(this.root,'uiComposerHideInput',!ja);},setStatusBoxVisible:function(ja){k.conditionClass(this.root,'uiComposerHideStatusBox',!ja);},setTopicTaggerVisible:function(ja){k.conditionClass(this.root,'uiTagComposerHidden',!ja);},mutate:function(ja){if(this.lastComposerInput)p.setValue(this.input,p.getValue(z(this.lastComposerInput)));var ka=z(ja.xhpc);if(ka){var la=l.scry(this.root,'.uiComposerAttachmentSelected')[0];if(ja.confirmAugmentation&&la!==ka)return;la&&k.removeClass(la,'uiComposerAttachmentSelected');k.addClass(ka,'uiComposerAttachmentSelected');if(!ja.disableCache)Event.listen(ka,'click',function(na){ba(na).stop();ja.disableCache=true;this.mutate(ja);}.bind(this));}if(!ja.keepContentAreas){this.setContentVisible(false);l.empty(this.content);if(this.isMetaComposer){this.mentionsInput&&this.mentionsInput.setAuxContent(null);l.empty(this.metaArea);l.empty(this.bottomArea);l.empty(this.barArea);}}if(ja.content){l.setContent(this.content,o(ja.content));this.setContentVisible(true);}if(this.isMetaComposer){ja.metaContent&&l.setContent(this.metaArea,o(ja.metaContent));ja.bottomContent&&l.setContent(this.bottomArea,o(ja.bottomContent));ja.barContent&&l.setContent(this.barArea,o(ja.barContent));}this.setMessageBoxVisible(!ja.messageBoxHidden);k.conditionClass(this.root,'uiComposerWhiteMessageBox',!ja.messageBoxHidden&&!ja.inputHidden&&!ja.content);this.setInputVisible(!ja.inputHidden);this.setStatusBoxVisible(!ja.statusBoxHidden);k.conditionShow(this.privacy,!ja.privacyWidgetHidden);if(this.boosting.length>0)k.conditionShow(this.boosting[0],!ja.boostingWidgetHidden);if(!ja.keepContentAreas){p.setPlaceholder(this.input,ja.placeholder);i.setLabel(this.button,ja.buttonLabel);}this.setBlurb(o(ja.blurb));if(ja.autoscrape){this.scraper&&this.scraper.enable();}else this.scraper&&this.scraper.disable();this.setEnabled(!ja.disabled);this.setTopicTaggerVisible(!ja.hideTopicTagger);this.setEndpoint(ja.endpoint);if(ja.formType==ca){this.form.setAttribute('rel','async');}else this.form.removeAttribute('rel');this.form.removeAttribute('target');if(ja.formType==da){if(!this._fileForm){this._fileForm=new n(this.form);this._fileForm.setAllowCrossOrigin(m.allowCrossOriginComposerUpload);this._fileForm.subscribe('submit',this.setLoading.bind(this,true));this._fileForm.subscribe('failure',this.setLoading.bind(this,false));}}else if(this._fileForm){this._fileForm.destroy();this._fileForm=null;}this.submitHandler=ja.submitHandler;this.lazyEndpoint=ja.lazyEndpoint;k.addClass(this.root,'uiComposerInteracted');k.addClass(this.root,'uiComposerOpen');if(ja.messageBoxFocused){var ma=document.activeElement;if(ma===document.body||r.byClass(ma,'attachmentLink'))this.focusInput.bind(this).defer();}if(ja.inputElement){p.setValue(z(ja.inputElement),p.getValue(this.input));u.getInstance(z(ja.inputElement)).update();}else u.getInstance(this.input).update();this.lastComposerInput=ja.inputElement;g.inform('composer/mutate',this);},subscribeToMutate:function(ja){return g.subscribe('composer/mutate',function(ka,la){if(la===this)ja();}.bind(this));},unsubscribeFromMutate:function(ja){ja.unsubscribe();},reset:function(ja){if(!ja){p.reset(this.input);this.mentionsInput&&this.mentionsInput.reset();this.scraper&&this.scraper.reset();}if(this.isMetaComposer){l.empty(this.metaArea);l.empty(this.bottomArea);l.empty(this.barArea);}if(this.resetCfg){this.mutate(this.resetCfg);}else{var ka=l.scry(this.root,'.uiComposerAttachmentSelected')[0];if(ka)k.removeClass(ka,'uiComposerAttachmentSelected');}k.removeClass(this.root,'uiComposerInteracted');k.setClass(this.focus,'focus_target');this.setLoading(false);g.inform('composer/reset');},onFocus:function(){if(this.lazyEndpoint){var ja=l.find(this.root,'form.attachmentSelectForm'),ka=new v(this.lazyEndpoint);ka.addQueryData({isAugmentation:true});ja.action=ka.toString();var la=l.scry(this.root,'.uiComposerAttachmentSelected')[0];ja.xhpc.value=la&&la.id;ja.xhpc.click();k.removeClass.curry(this.root,'async_saving').defer();}this.inform('focus');},focusInput:function(){p.focus(this.input);},getInput:function(){return this.input;},updateDataSourceToken:function(ja){if(this.dataSource)this.dataSource.updateToken(ja);},_handleUnsavedChanges:function(){var ja=q.getNextURI();if(ja.getQueryData().hasOwnProperty('theater'))return;if(this.input.offsetParent!==null&&!p.isEmpty(this.input)&&!(a.Dialog&&a.Dialog.getCurrent()))return "You haven't finished your post yet. Do you want to leave without finishing?";}});var ia;y(ha,{setNodeToConfigure:function(ja){ia=ja;},configure:function(ja,ka,la){var ma=r.byClass(ia,'uiComposer').id,na=g.subscribe('xhpc/construct/'+ma,function(oa,pa){(function(){na.unsubscribe();}).defer();pa.mutate(ja);pa.subscribe('init',function(){new t().handle(ka);new Function(la)();if(ja.attachmentJS)new Function(ja.attachmentJS).call(pa);});});},publish:function(ja,ka){ka=ka||{};ka.composer_id=ja;ka.composer=ha.getInstance(ja);ka.composer&&ka.composer.reset(false);if(ka.streamNode){ka.streamStory=ka.streamNode;}else if(ka.streamMarkup)ka.streamStory=o(ka.streamMarkup).getRootNode();g.inform('composer/publish',ka);},finish:function(ja){ha.getInstance(ja).setLoading(false);},getInstance:function(ja){var ka=r.byClass(x(ja),'uiComposer');return ka?ea[ka.id]:null;}});e.exports=ha;});
__d("legacy:Composer",["Composer"],function(a,b,c,d){a.Composer=b('Composer');},3);
function MetaComposerMessageBox(){}copyProperties(MetaComposerMessageBox.prototype,{init:function(a,b){this.inputContainer=DOM.scry(a,'div.inputContainer')[0];this.textInput=DOM.scry(a,'textarea.mentionsTextarea')[0];this.metaArea=DOM.scry(a,'div.attachmentMetaArea')[0];this.bottomArea=DOM.scry(a,'div.attachmentBottomArea')[0];this.barArea=DOM.scry(a,'div.attachmentBarArea')[0];Event.listen(this.inputContainer,'click',function(c){var d=c.getTarget();if(!DOM.contains(this.metaArea,d)&&d!==this.textInput)this.textInput.focus();}.bind(this));}});
__d("legacy:ui-side-nav-message",["NavigationMessage"],function(a,b,c,d){a.NavigationMessage=b('NavigationMessage');},3);
function FutureSideNav(){FutureSideNav.instance&&FutureSideNav.instance.uninstall();FutureSideNav.instance=this;}FutureSideNav.instance=null;FutureSideNav.getInstance=function(){return FutureSideNav.instance||new FutureSideNav();};copyProperties(FutureSideNav.prototype,{init:function(a,b,c){this.root=a;this.items={};this.sections={};this.editor=null;this.editing=false;this.selected=null;this.loading=null;this.keyParam='sk';this.defaultKey=b;this.uri=URI.getRequestURI();this.ajaxPipe=c;this.ajaxPipeEndpoints={};this.sidecol=true;this._installed=true;this._handlePageTransitions=true;PageTransitions.registerHandler(function(d){return this._handlePageTransitions&&this.handlePageTransition(d);}.bind(this));this._eventHandlers=[];this._arbiterSubscriptions=[Arbiter.subscribe(NavigationMessage.NAVIGATION_COMPLETED,this.navigationComplete.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FAILED,this.navigationFailed.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_COUNT_UPDATE,this.navigationCountUpdate.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_SELECT,this.navigationSelect.bind(this)),Arbiter.subscribe(ChannelConstants.getArbiterType('nav_update_counts'),this.navigationCountUpdateFromPresence.bind(this))];this._explicitHover=[];this._ensureHover('sideNavItem');this._eventHandlers.push(Event.listen(window,'resize',this._handleResize.bind(this)));this._checkNarrow();this._selectorSubscriptions=[];window.Selector&&this._selectorSubscriptions.push(Selector.subscribe(['open','close'],function(d,e){var f=Parent.byClass(e.selector,'sideNavItem');f&&CSS.conditionClass(f,'editMenuOpened',d==='open');}));onleaveRegister(this.uninstall.bind(this));if(this._pendingSections)this._pendingSections.forEach(function(d){this.initSection.apply(this,d);}.bind(this));},_handleResize:(function(){var a;return function(){a&&clearTimeout(a);a=this._checkNarrow.bind(this).defer(200);};})(),_checkNarrow:function(){CSS.conditionClass(this.root,'uiNarrowSideNav',Vector2.getElementPosition(this.root).x<20);},_ensureHover:function(a){if(ua.ie()<8)Bootloader.loadComponents('explicit-hover',function(){this._explicitHover.push(new ExplicitHover(this.root,a));}.bind(this));},uninstall:function(){if(this._installed){this._installed=false;this._handlePageTransitions=false;this._arbiterSubscriptions.forEach(Arbiter.unsubscribe);this._selectorSubscriptions.forEach(function(a){Selector.unsubscribe(a);});this._eventHandlers.forEach(function(a){a.remove();});this._explicitHover.forEach(function(a){a.uninstall();});}},initSection:function(a,b){if(!this._installed){this._pendingSections=this._pendingSections||[];this._pendingSections.push(arguments);return;}this._initItems(b);this._initSection(a);},addItem:function(a,b){this._initItem(a,b);},_initItems:function(a){var b=function(c,d){var e=this._initItem(c,d);if(c.children)c.children.forEach(function(f){b(f,e);});}.bind(this);$A(a).forEach(function(c){b(c,null);});},_initItem:function(a,b){var c=this.items[a.id]=this._constructItem(a,b);if(c.equals(this.selected)||a.selected)this.setSelected(c);var d=c.getLinkNode();d&&this._eventHandlers.push(Event.listen(d,'click',function(event){return !this.editing;}.bind(this)));return c;},_initSection:function(a){var b=this.sections[a.id]=this._constructSection(a);this._eventHandlers.push(Event.listen(b.node,'click',this.handleSectionClick.bind(this,b)));DOM.scry(b.node,'div.bookmarksMenuButton').forEach(CSS.show);return b;},_constructItem:function(a,b){return new FutureSideNavItem(a,b);},_constructSection:function(a){return new FutureSideNavSection(a);},handleSectionClick:function(a,event){var b=this._getEventTarget(event,'a'),c=this._getItemForNode(b);if(!b){return;}else if(CSS.hasClass(b.parentNode,'uiMenuItem')){this._handleMenuClick(a,c,b.parentNode,event);}else this._handleLinkClick(a,b,event);},_getEventTarget:function(event,a){var b=event.getTarget();if(b.tagName!==a.toUpperCase()){return Parent.byTag(b,a);}else return b;},_handleMenuClick:function(a,b,c,event){if(CSS.hasClass(c,'rearrange'))this.beginEdit(a);},_handleLinkClick:function(a,b,event){if(CSS.hasClass(b,'navEditDone')){this.editing?this.endEdit():this.beginEdit(a);event.kill();}},getItem:function(a){if(this._isCurrentPath(a)){return this._getItemForKey(this._getKey(a.getQueryData())||this.defaultKey);}else return this._getItemForPath(a.getPath());},getNodeForKey:function(a){var b=this._getItemForKey(a);if(b)return b.node;},_isCurrentPath:function(a){return a.getDomain()===this.uri.getDomain()&&a.getPath()===this.uri.getPath();},_getKey:function(a){return a[this.keyParam];},_getItemForNode:function(a){a=Parent.byClass(a,'sideNavItem');return a&&this.items[a.id];},_getItemForKey:function(a){return this._findItem(function(b){return b.matchKey(a);});},_getItemForPath:function(a){return this._findItem(function(b){return b.matchPath(a);});},_findItem:function(a){for(var b in this.items)if(a(this.items[b]))return this.items[b];},removeItem:function(a){if(a&&this.items[a.id]){DOM.remove(a.node);delete this.items[a.id];}},removeItemByKey:function(a){this.removeItem(this._getItemForKey(a));},moveItem:function(a,b,c){var d=DOM.find(a.node,'ul.uiSideNav');(c?DOM.prependContent:DOM.appendContent)(d,b.node);},setLoading:function(a){this.loading&&this.loading.hideLoading();this.loading=a;this.loading&&this.loading.showLoading();},setSelected:function(a){this.setLoading(null);if(this.selected){this.selected.hideSelected();this.selected.getTop().hideChildren();}this.selected=a;if(this.selected){this.selected.showSelected();this.selected.getTop().showChildren();}},handlePageTransition:function(a){var b=this.getItem(a),c=b&&b.endpoint&&this._doPageTransition(b,a);return c;},_doPageTransition:function(a,b){this.setLoading(a);this._sendPageTransition(a.endpoint,copyProperties(this._getTransitionData(a,b),b.getQueryData()));return true;},_sendPageTransition:function(a,b){b.endpoint=a;Arbiter.inform(NavigationMessage.NAVIGATION_BEGIN,{useAjaxPipe:this._useAjaxPipe(a),params:b});},_getTransitionData:function(a,b){var c={};c.sidecol=this.sidecol;c.path=b.getPath();c[this.keyParam]=a.textKey;c.key=a.textKey;return c;},_useAjaxPipe:function(a){return this.ajaxPipe||this.ajaxPipeEndpoints[a];},navigationComplete:function(){this.loading&&this.setSelected(this.loading);},navigationFailed:function(){this.setLoading(null);},navigationSelect:function(a,b){var c=this._getItemForKey(this._getKey(b));if(b.asLoading){this.setLoading(c);}else this.setSelected(c);},navigationCountUpdate:function(a,b){var c=this._getItemForKey(b&&b.key);if(c)if(typeof b.count!=="undefined"){c.setCount(b.count,b.hide);}else if(typeof b.increment!=="undefined")c.incrementCount(b.increment,b.hide);},navigationCountUpdateFromPresence:function(a,b){b=b.obj;if(b)if(!b.class_name||b.class_name&&CSS.hasClass(this.root,b.class_name))if(b.items)for(var c=0;c<b.items.length;c++)this.navigationCountUpdate(a,b.items[c]);},beginEdit:function(a){if(!this.editing){this.editing=true;CSS.addClass(this.root,'editMode');this._updateTrackingData();Bootloader.loadComponents('sortable-side-nav-js',this._initEditor.bind(this,a));}},endEdit:function(){if(this.editing){CSS.removeClass(this.root,'editMode');this.editor.endEdit();this.editor=null;this.editing=false;this._updateTrackingData();}},_updateTrackingData:function(a){var b=this.root.getAttribute('data-gt')||"{}";try{b=JSON.parse(b);if(this.editing){b.editing=true;}else delete b.editing;this.root.setAttribute('data-gt',JSON.stringify(b));}catch(c){}},_initEditor:function(a){this.editor=a.getEditor();this.editor.beginEdit();}});function FutureSideNavSection(a){this.id=a.id;this.node=this.node||$(a.id);this.editEndpoint=a.editEndpoint;}copyProperties(FutureSideNavSection.prototype,{equals:function(a){return a&&a.id===this.id;},getEditor:function(){return new SortableSideNav(DOM.find(this.node,'ul.uiSideNav'),this.editEndpoint);}});function FutureSideNavItem(a,b){this.id=a.id;this.up=b;this.endpoint=a.endpoint;this.type=a.type;this.node=a.node||$(a.id);this.paths=a.path?$A(a.path):[];this.keys=a.key?$A(a.key):[];var c=this._findKeys(this.keys);this.numericKey=c.numeric||this.keys[0];this.textKey=c.text||this.keys[0];this._pathPattern=this._buildRegex(this.paths);this._keyPattern=this._buildRegex(this.keys);this.hideLoading();this.hideSelected();}copyProperties(FutureSideNavItem.prototype,{equals:function(a){return a&&a.id===this.id;},getLinkNode:function(){return (DOM.scry(this.node,'a.item')[0]||DOM.scry(this.node,'a.subitem')[0]);},matchPath:function(a){return this._matchInput(this._pathPattern,a);},matchKey:function(a){return this._matchInput(this._keyPattern,a);},_matchInput:function(a,b){var c=a&&a.exec(b);return c&&c.slice(1);},getTop:function(){return this.isTop()?this:this.up.getTop();},isTop:function(a){return !this.up;},setCount:function(a,b){return this._updateCount(a,true);},incrementCount:function(a,b){return this._updateCount(a,false);},_updateCount:function(a,b,c){var d=DOM.scry(this.node,'span.count')[0],e=d&&DOM.scry(d,'span.countValue')[0];if(e){var f=b?0:parseInt(DOM.getText(e),10),g=Math.max(0,f+a),h=this.isTop()?'hidden':'hiddenSubitem';DOM.setContent(e,g);c&&CSS.conditionClass(this.node,h,!g);CSS.conditionClass(d,'hidden_elem',!g);if(this.isTop()){var i=DOM.scry(this.node,'div.linkWrap')[0];if(i){CSS.conditionClass(i,'noCount',!g);CSS.conditionClass(i,'hasCount',g);}}}Arbiter.inform('NavigationMessage.COUNT_UPDATE_DONE');},showLoading:function(){CSS.addClass(this.node,'loading');},hideLoading:function(){CSS.removeClass(this.node,'loading');},showSelected:function(){CSS.addClass(this.node,'selectedItem');CSS.hasClass(this.node,'hider')&&CSS.addClass(this._getExpanderParent(),'expandedMode');},hideSelected:function(){CSS.removeClass(this.node,'selectedItem');},showChildren:function(){CSS.addClass(this.node,'open');},hideChildren:function(){CSS.removeClass(this.node,'open');},_getExpanderParent:function(){return Parent.byClass(this.node,'expandableSideNav');},_buildRegex:function(a){if(a.length){var b=a.map(function(c){if(typeof c==="string"){return c.replace(/([^a-z0-9_])/ig,'\\$1');}else if(c&&c.regex)return c.regex;});return new RegExp('^(?:'+b.join('|')+')$');}},_findKeys:function(a){var b=/^(app|group|fl)_/,c={};for(var d=0;d<a.length;d++){var e=b.test(a[d]);if(e&&!c.numeric){c.numeric=a[d];}else if(!e&&!c.text)c.text=a[d];if(c.numeric&&c.text)break;}return c;}});
__d("MegaphoneHelper",["Animation","AsyncRequest","Dialog","ge"],function(a,b,c,d,e,f){var g=b('Animation'),h=b('AsyncRequest'),i=b('Dialog'),j=b('ge'),k={hideStory:function(l,m,n,o,p){var q={mp_id:l,location:m,context:o};new h().setURI('/ajax/megaphone/megaphone_hide.php').setMethod('POST').setData(q).setHandler(function(s){p&&p(s);}).send();var r=j(n);if(r)g(r).to('height',0).duration(500).hide().go();},createModalStory:function(l,m,n,o){var p;if(!l.buttons||!l.buttons.length){l.buttons=i.CLOSE;p=this.hideStory.bind(this,m,n,o,null);}var q=new i(l);if(p)q.setHandler(p);q.show();},buttonOnClick:function(l,m,n,o,p,q){var r=function(){if(p){new h().setURI(o).send();}else document.location.href=o;};if(q){this.hideStory(l,m,'',n,function(){r();});}else r();}};e.exports=k;});
__d("legacy:megaphone",["MegaphoneHelper"],function(a,b,c,d){a.MegaphoneHelper=b('MegaphoneHelper');},3);
__d("PopoverMenuInterface",["Arbiter","ArbiterMixin","Class","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('copyProperties');function k(){}j(k.prototype,h,{getRoot:bagofholding,onShow:bagofholding,onHide:bagofholding,focusAnItem:bagof(false),blur:bagofholding,handleKeydown:bagof(false),done:function(){this.inform('done');}});e.exports=k;});
__d("Popover",["event-extensions","Arbiter","ArbiterMixin","Class","ContextualLayer","ContextualLayerHideOnScroll","CSS","DataStore","DOM","Input","KeyStatus","LayerHideOnEscape","Toggler","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('ContextualLayer'),k=b('ContextualLayerHideOnScroll'),l=b('CSS'),m=b('DataStore'),n=b('DOM'),o=b('Input'),p=b('KeyStatus'),q=b('LayerHideOnEscape'),r=b('Toggler'),s=b('copyProperties');r.subscribe(['show','hide'],function(u,v){var w=m.get(v.getActive(),'Popover');if(w)if(u==='show'){w.showLayer();}else w.hideLayer();});function t(u,v,w,x){this._root=u;this._triggerElem=v;this._behaviors=w;this._config=x;if(!(v.nodeName==='A'&&v.rel==='toggle'))Event.listen(v,'click',function(){r.bootstrap(v);});m.set(u,'Popover',this);}s(t.prototype,h,{_layer:null,_closeListener:null,ensureInit:function(){if(!this._layer)this._init();},showLayer:function(){this.ensureInit();this._layer.show();r.show(this._root);l.addClass(this._root,'selected');this.inform('show');this._triggerElem.setAttribute('aria-expanded','true');},hideLayer:function(){this._layer.hide();this._triggerElem.setAttribute('aria-expanded','false');},isShown:function(){return this._layer.isShown();},setLayerContent:function(u){this.ensureInit();this._layer.setContent(u);},_init:function(){var u=new j({context:this._triggerElem,position:'below'},n.create('div'));u.enableBehaviors([k,q]);r.createInstance(u.getRoot()).setSticky(false);u.subscribe('hide',this._onLayerHide.bind(this));this._behaviors&&u.enableBehaviors(this._behaviors);this._layer=u;if(this._config.alignh)this._layer.setAlignment(this._config.alignh);if(this._config.layer_content)this._layer.setContent(this._config.layer_content);this.inform('init',null,g.BEHAVIOR_PERSISTENT);},_onLayerHide:function(){r.hide(this._root);l.removeClass(this._root,'selected');this.inform('hide');if(p.isKeyDown())o.focus(this._triggerElem);}});e.exports=t;});
__d("PopoverAsyncMenuLoading",["Class","copyProperties","DOM","PopoverMenuInterface"],function(a,b,c,d,e,f){var g=b('Class'),h=b('copyProperties'),i=b('DOM'),j=b('PopoverMenuInterface');function k(l){this.parent.construct(this);this._className=l||'';}g.extend(k,j);h(k.prototype,{_root:null,getRoot:function(){if(!this._root)this._root=i.create('div',{className:this._className},i.create('div',{className:'uiMenuXBorder'},i.create('div',{className:'uiMenuX uiMenuXLoading'},i.create('span',{className:'spinner'}))));return this._root;}});e.exports=k;});
__d("PopoverMenu",["event-extensions","Arbiter","ArbiterMixin","ARIA","BehaviorsMixin","Class","Input","Keys","KeyStatus","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('ARIA'),j=b('BehaviorsMixin'),k=b('Class'),l=b('Input'),m=b('Keys'),n=b('KeyStatus'),o=b('copyProperties');function p(q,r,s,t){this._popover=q;this._triggerElem=r;this._initialMenu=s;q.subscribe('init',this._onLayerInit.bind(this));q.subscribe('show',this._onPopoverShow.bind(this));q.subscribe('hide',this._onPopoverHide.bind(this));t&&this.enableBehaviors(t);}o(p.prototype,h,j);o(p.prototype,{_keydownListener:null,_popoverShown:false,setMenu:function(q){this._menu=q;var r=q.getRoot();this._popover.setLayerContent(r);q.subscribe('done',this._onMenuDone.bind(this));if(this._popoverShown)this._menu.onShow();i.owns(this._triggerElem,r);this.inform('setMenu',null,g.BEHAVIOR_PERSISTENT);},getPopover:function(){return this._popover;},getTriggerElem:function(){return this._triggerElem;},getMenu:function(){return this._menu;},_onLayerInit:function(){this.setMenu(this._initialMenu);},_onPopoverShow:function(){if(this._menu){this._menu.onShow();if(n.isKeyDown())this._menu.focusAnItem();this._keydownListener=Event.listen(document.documentElement,'keydown',this._handleKeydown.bind(this));}this._popoverShown=true;},_onPopoverHide:function(){if(this._menu)this._menu.onHide();if(this._keydownListener){this._keydownListener.remove();this._keydownListener=null;}this._popoverShown=false;},_handleKeydown:function(q){if(q.getModifiers().any)return;var r=Event.getKeyCode(q);switch(r){case m.RETURN:return;case m.UP:case m.DOWN:this._menu.handleKeydown(r);break;default:if(this._menu.handleKeydown(r)===false){this._menu.blur();this._menu.handleKeydown(r);}break;}q.prevent();},_onMenuDone:function(q){this._popover.hideLayer.bind(this._popover).defer();if(n.isKeyDown())l.focus(this._triggerElem);}});e.exports=p;});
__d("PopoverAsyncMenu",["event-extensions","AsyncRequest","Class","CSS","DOM","PopoverAsyncMenuLoading","PopoverMenu","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('AsyncRequest'),h=b('Class'),i=b('CSS'),j=b('DOM'),k=b('PopoverAsyncMenuLoading'),l=b('PopoverMenu'),m=b('copyProperties'),n={},o=0;function p(q,r,s,t,u){this._endpoint=t;this._loadingMenu=s;this._instanceId=o++;n[this._instanceId]=this;this._mouseoverListener=Event.listen(r,'mouseover',this._fetchMenu.bind(this));this.parent.construct(this,q,r,null,u);}p.setMenu=function(q,r){n[q].setMenu(r);};h.extend(p,l);m(p.prototype,{_fetched:false,_mouseoverListener:null,_onLayerInit:function(){if(!this._menu)this.setMenu(this._loadingMenu);this._fetchMenu();},_fetchMenu:function(){if(this._fetched)return;new g().setURI(this._endpoint).setData({pmid:this._instanceId}).send();this._fetched=true;if(this._mouseoverListener){this._mouseoverListener.remove();this._mouseoverListener=null;}}});e.exports=p;});
__d("PopoverMenuOverlappingBorder",["function-extensions","CSS","DOM","Style","copyProperties"],function(a,b,c,d,e,f){b('function-extensions');var g=b('CSS'),h=b('DOM'),i=b('Style'),j=b('copyProperties');function k(l){this._popoverMenu=l;this._popover=l.getPopover();this._triggerElem=l.getTriggerElem();}j(k.prototype,{_shortBorder:null,_setMenuSubscription:null,_showSubscription:null,_menuSubscription:null,enable:function(){this._setMenuSubscription=this._popoverMenu.subscribe('setMenu',this._onSetMenu.bind(this));},disable:function(){this._popoverMenu.unsubscribe(this._setMenuSubscription);this._setMenuSubscription=null;this._removeBorderSubscriptions();this._removeShortBorder();},_onSetMenu:function(){this._removeBorderSubscriptions();this._menu=this._popoverMenu.getMenu();this._renderShortBorder(this._menu.getRoot());this._showSubscription=this._popover.subscribe('show',this._updateBorder.bind(this));this._menuSubscription=this._menu.subscribe(['change','resize'],Function.prototype.defer.shield(this._updateBorder.bind(this)));this._updateBorder();},_updateBorder:function(){var l=this._menu.getRoot(),m=this._triggerElem.offsetWidth;i.set(l,'min-width',m+'px');var n=Math.max(l.offsetWidth-m,0);i.set(this._shortBorder,'width',n+'px');},_renderShortBorder:function(l){this._shortBorder=h.create('div',{className:'uiMenuXShortBorder'});h.appendContent(l,this._shortBorder);g.addClass(l,'uiMenuXWithShortBorder');},_removeShortBorder:function(){if(this._shortBorder){h.remove(this._shortBorder);this._shortBorder=null;g.removeClass(this._popoverMenu.getMenu().getRoot(),'uiMenuXShortBorder');}},_removeBorderSubscriptions:function(){if(this._showSubscription){this._popover.unsubscribe(this._showSubscription);this._showSubscription=null;}if(this._menuSubscription){this._menu.unsubscribe(this._menuSubscription);this._menuSubscription=null;}}});e.exports=k;});
__d("SubMenu",["event-extensions","Arbiter","copyProperties","CSS"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('copyProperties'),i=b('CSS');function j(){}h(j.prototype,{_subMenu:null,_mainMenu:null,_forward:null,_backward:null,init:function(k,l,m,n){this._subMenu=k;this._mainMenu=l;this._forward=m;this._backward=n;g.subscribe('SubMenu/Reset',this._goToMainMenu.bind(this));Event.listen(m,'click',this._goToSubMenu.bind(this));Event.listen(n,'click',this._goToMainMenu.bind(this));},initAsyncChildMenu:function(k){Event.listen(this._forward,'click',function(){this._goToSubMenu();k.load();}.bind(this));},_goToMainMenu:function(){i.hide(this._subMenu);i.show(this._mainMenu);},_goToSubMenu:function(){i.hide(this._mainMenu);i.show(this._subMenu);}});e.exports=j;});
__d("legacy:ui-submenu",["SubMenu"],function(a,b,c,d){a.SubMenu=b('SubMenu');},3);
__d("AsyncMenu",["AsyncRequest","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('copyProperties');function i(){}h(i.prototype,{_uri:null,_elem:null,init:function(j,k){this._uri=j;this._elem=k;},load:function(){this.load=bagofholding;g.bootstrap(this._uri,this._elem);}});e.exports=i;});
__d("legacy:ui-asyncmenu",["AsyncMenu"],function(a,b,c,d){a.AsyncMenu=b('AsyncMenu');},3);
__d("TooltipLink",["Parent","Tooltip"],function(a,b,c,d,e,f){var g=b('Parent'),h=b('Tooltip'),i={setTooltipText:function(j,k){j=g.byTag(j,'a');j&&h.set(j,k);}};e.exports=i;});
__d("RenderManager",["function-extensions","copyProperties"],function(a,b,c,d,e,f){b('function-extensions');var g=b('copyProperties');function h(i){this._isDirty=false;this._obj=i;}g(h.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;this._doPaint.bind(this).defer();}},_doPaint:function(){this._isDirty=false;this._obj.paint();}});e.exports=h;});
__d("CounterDisplay",["Arbiter","CSS","DOM","RenderManager","Run","$","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('RenderManager'),k=b('Run'),l=b('$'),m=b('copyProperties');function n(o,p,q,r,s,t){m(this,{_name:o,_valueNode:l(p),_wrapperNode:l(q)||null,_statusClass:s,_rm:new j(this),_arbiterSubscription:null,_count:0});var u=this._valueNode.firstChild;if(u){var v=parseInt(u.nodeValue,10);if(!isNaN(v))this._count=v;}this._statusNode=r?l(r):null;this._subscribeAll();n.instances.push(this);if(!t)k.onLeave(this._destroy.bind(this),true);}m(n,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(o,p){g.inform(n.EVENT_TYPE_ADJUST+'/'+o,p);},setCount:function(o,p){g.inform(n.EVENT_TYPE_UPDATE+'/'+o,p);}});m(n.prototype,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){this._arbiterSubscription.unsubscribe();delete this._arbiterSubscription;}n.instances.remove(this);},adjustCount:function(o){this._count=Math.max(0,this._count+o);this._rm.dirty();return this;},setCount:function(o){this._count=Math.max(0,o);this._rm.dirty();return this;},paint:function(){i.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)h.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)h.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var o=[n.EVENT_TYPE_ADJUST+'/'+this._name,n.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=g.subscribe(o,this._onInform.bind(this),g.SUBSCRIBE_NEW);},_onInform:function(o,p){p=parseInt(p);if(isNaN(p))return;if(o.indexOf(n.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(p);}else if(o.indexOf(n.EVENT_TYPE_UPDATE)!=-1){this.setCount(p);}else return;return;}});e.exports=n;});
__d("ContextualLayerUpdateOnScroll",["event-extensions","Class","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Class'),h=b('copyProperties');function i(j){this._layer=j;}h(i.prototype,{_subscriptions:[],enable:function(){this._subscriptions=[this._layer.subscribe('show',this._attachScrollListener.bind(this)),this._layer.subscribe('hide',this._removeScrollListener.bind(this))];},disable:function(){while(this._subscriptions.length)this._subscriptions.pop().unsubscribe();this.detach();},_attachScrollListener:function(){if(this._listener)return;var j=this._layer.getContextScrollParent();this._listener=Event.listen(j,'scroll',this._layer.updatePosition.bind(this._layer));},_removeScrollListener:function(){this._listener&&this._listener.remove();this._listener=null;}});e.exports=i;});
__d("TypeaheadShowLoadingIndicator",["CSS","copyProperties"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){this._subscription=this._typeahead.subscribe('loading',function(j,k){g.conditionClass(this._typeahead.getElement(),'typeaheadLoading',k.loading);g.conditionClass(this._typeahead.getView().getElement(),'typeaheadViewLoading',k.loading);}.bind(this));},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;}});e.exports=i;});
__d("legacy:ShowLoadingIndicatorTypeaheadBehavior",["TypeaheadShowLoadingIndicator"],function(a,b,c,d){var e=b('TypeaheadShowLoadingIndicator');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.showLoadingIndicator=function(f){f.enableBehavior(e);};},3);
__d("legacy:DocumentTitle",["DocumentTitle"],function(a,b,c,d){a.DocumentTitle=b('DocumentTitle');},3);
__d("ModalLayer",["event-extensions","CSS","DOMQuery","ScrollAwareDOM","Style","URI","UserAgent","Vector","copyProperties","csx","debounce","ge"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOMQuery'),i=b('ScrollAwareDOM'),j=b('Style'),k=b('URI'),l=b('UserAgent'),m=b('Vector'),n=b('copyProperties'),o=b('csx'),p=b('debounce'),q=b('ge'),r=0,s=null,t=null;function u(){if(!t)t=h.scry(document.body,".-cx-PRIVATE-fbLayout__root")[0];return t;}function v(){h.scry(document.body,'div.swfObject').forEach(function(x){var y=x.getAttribute('data-swfid');if(y&&window[y]){var z=window[y];z.addParam('autostart','false');z.addParam('autoplay','false');z.addParam('play','false');z.addVariable('video_autoplay','0');z.addVariable('autoplay','0');z.addVariable('play','0');var aa=k(z.getAttribute('swf'));aa.addQueryData({autoplay:'0'});aa.setPath(aa.getPath().replace('autoplay=1','autoplay=0'));z.setAttribute('swf',aa.toString());z.write(x);}});}function w(x){this._layer=x;}n(w.prototype,{_subscription:null,_resizeListener:null,enable:function(){if(!u())return;this._subscription=this._layer.subscribe(['show','hide'],function(x){x=='show'?this._addModal():this._removeModal();}.bind(this));if(this._layer.isShown())this._addModal();},disable:function(){if(!u())return;this._subscription.unsubscribe();this._subscription=null;if(this._layer.isShown())this._removeModal();},_addModal:function(){g.addClass(this._layer.getRoot(),'modalWrapper');if(r++===0){s=m.getScrollPosition();var x=u(),y=x.offsetTop-s.y;j.set(x,'top',y+'px');g.addClass(document.documentElement,'modalOpen');if(l.ie()<7){var z=this._layer.getRoot(),aa=function(){var ca=-y+Math.max(z.offsetHeight,z.scrollHeight);j.set(x,'height',ca+'px');};aa();this._resizeListener=Event.listen(window,'resize',p(aa,100));}var ba=h.getDocumentScrollElement();ba.scrollTop=0;this._scrollSubscription=i.subscribe('scroll',function(ca,da){var ea=x.offsetTop-da.delta.y;j.set(x,'top',ea+'px');s=s.add(da.delta);return false;});if(l.firefox()<13)v.defer();}},_removeModal:function(){g.removeClass(this._layer.getRoot(),'modalWrapper');if(--r===0){g.removeClass(document.documentElement,'modalOpen');var x=u();j.set(x,'top','');if(l.ie()<7){j.set(x,'height','');this._resizeListener.remove();this._resizeListener=null;}var y=h.getDocumentScrollElement();y.scrollTop=s.y;this._scrollSubscription.unsubscribe();this._scrollSubscription=null;}}});e.exports=w;});
__d("DialogX",["event-extensions","function-extensions","AccessibleLayer","Arbiter","ArbiterMixin","Class","DOM","Layer","LayerButtons","LayerFormHooks","ModalLayer","Parent","Style","UserAgent","Vector","copyProperties","cx","debounce","getOverlayZIndex"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('AccessibleLayer'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('Class'),k=b('DOM'),l=b('Layer'),m=b('LayerButtons'),n=b('LayerFormHooks'),o=b('ModalLayer'),p=b('Parent'),q=b('Style'),r=b('UserAgent'),s=b('Vector'),t=b('copyProperties'),u=b('cx'),v=b('debounce'),w=b('getOverlayZIndex');function x(z,aa){this.parent.construct(this,z,aa);}j.extend(x,l);t(x,i);t(x.prototype,{_modal:false,_ie:null,_wrapper:null,_configure:function(z,aa){this.parent._configure(z,aa);if(z.modal){this._modal=true;this.enableBehavior(o);}if(z.autohide)var ba=this.subscribe('show',function(){ba.unsubscribe();this.hide.shield(this).defer(z.autohide);}.bind(this));},_getDefaultBehaviors:function(){return this.parent._getDefaultBehaviors().concat([y,g,m,n]);},_buildWrapper:function(z,aa){var ba=k.create('div',{className:"-cx-PRIVATE-uiDialog__content"},aa),ca;this._ie=r.ie();if(this._ie>6&&this._ie<9){ca=[k.create('div',{className:"-cx-PRIVATE-uiDialog__vertical"}),k.create('div',{className:"-cx-PRIVATE-uiDialog__horizontal"}),k.create('div',{className:"-cx-PRIVATE-uiDialog__topLeft"}),k.create('div',{className:"-cx-PRIVATE-uiDialog__topRight"}),k.create('div',{className:"-cx-PRIVATE-uiDialog__bottomLeft"}),k.create('div',{className:"-cx-PRIVATE-uiDialog__bottomRight"}),ba];}else ca=k.create('div',{className:"-cx-PRIVATE-uiDialog__border"},ba);this._wrapper=k.create('div',{className:"-cx-PRIVATE-uiDialog__wrapper"},ca);this.setWidth(z.width);var da="-cx-PRIVATE-uiDialog__positioner";if(z.className)da+=' '+z.className;var ea=k.create('div',{className:da},this._wrapper);if(z.id)ea.id=z.id;return ea;},_getContentRoot:function(){return this._wrapper;},updatePosition:function(){var z=s.getViewportDimensions().y-s.getElementDimensions(this._wrapper).y,aa;if(z<250){if(z>80){aa=z/2;}else aa=40;}else aa=125;if(!this._modal&&(!this._ie||this._ie<7))if(aa<=40){this.enableBehavior(o);}else this.disableBehavior(o);if(this._ie<7){var ba=s.getScrollPosition().y;q.set(this._wrapper,'top',aa+ba+'px');}else q.set(this._wrapper,'margin-top',aa+'px');if(this._causalElement){var ca=w(this._causalElement,this.getInsertParent());q.set(this.getRoot(),'z-index',ca>200?ca:'');}},setWidth:function(z){z=Math.floor(z);if(this._ie>6&&this._ie<9)z-=20;q.set(this._wrapper,'width',z+'px');}});function y(z){this._layer=z;}t(y.prototype,{_subscription:null,_resize:null,enable:function(){this._subscription=this._layer.subscribe(['show','hide'],function(z){if(z==='show'){this._attach();h.inform('layer_shown',{type:'DialogX'});}else{this._detach();h.inform('layer_hidden',{type:'DialogX'});}}.bind(this));},disable:function(){this._subscription.unsubscribe();this._subscription=null;this._resize&&this._detach();},_attach:function(){this._layer.updatePosition();this._resize=Event.listen(window,'resize',v(this._layer.updatePosition.bind(this._layer)));},_detach:function(){this._resize.remove();this._resize=null;}});e.exports=x;});
__d("AsyncDialog",["AsyncRequest","copyProperties","CSS","cx","DialogX","DOM","Parent","tx","URI"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('copyProperties'),i=b('CSS'),j=b('cx'),k=b('DialogX'),l=b('DOM'),m=b('Parent'),n=b('tx'),o=b('URI'),p=new k({width:465,className:"-cx-PRIVATE-uiDialog__loadingDialog"},l.create('div',{className:"-cx-PRIVATE-uiDialog__loadingText"},"Loading...")),q=1,r=[],s=0;function t(){s--;if(!s)p.hide();}function u(w,x){var y=q++;r[y]=x;h(w.getData(),{__asyncDialog:y});var z=false;s++;p.show();function aa(){if(!z)t();}w.setInterceptHandler(function(ba){z=true;t();});w.setFinallyHandler(function(ba){var ca=ba.getPayload();if(ca&&ca.asyncURL)v.send(new g(ca.asyncURL));aa();});w.setAbortHandler(aa);w.send();}var v={send:function(w,x){u(w,x||bagofholding);},bootstrap:function(w,x,y){if(!w)return;var z=m.byClass(x,'stat_elem')||x;if(z&&i.hasClass(z,'async_saving'))return false;var aa=new o(w).getQueryData();aa.causal_element=x?l.getID(x):null;var ba=y==='dialog',ca=new g().setURI(w).setData(aa).setMethod(ba?'GET':'POST').setReadOnly(ba).setRelativeTo(x).setStatusElement(z).setNectarModuleDataSafe(x);v.send(ca);},respond:function(w,x){var y=r[w];if(y){y(x);delete r[w];}}};e.exports=v;});
__d("FullScreen",["event-extensions","Arbiter","CSS","UserAgent","copyProperties","throttle"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('UserAgent'),j=b('copyProperties'),k=b('throttle'),l=j(new g(),{listenForEvent:function(m){var n=k(this.onChange,0,this);Event.listen(m,{webkitfullscreenchange:n,mozfullscreenchange:n,fullscreenchange:n});Event.listen(document,{webkitfullscreenchange:n,mozfullscreenchange:n,fullscreenchange:n});},enableFullScreen:function(m){this.listenForEvent(m);if(m.webkitRequestFullScreen){if(i.chrome()){m.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);}else m.webkitRequestFullScreen();}else if(m.mozRequestFullScreen){m.mozRequestFullScreen();}else if(m.requestFullScreen){m.requestFullScreen();}else return false;return true;},disableFullScreen:function(){if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.exitFullScreen){document.exitFullScreen();}else return false;return true;},isFullScreen:function(){return (document.webkitIsFullScreen||document.fullScreen||document.mozFullScreen);},toggleFullScreen:function(m){if(this.isFullScreen()){this.disableFullScreen();return false;}else return this.enableFullScreen(m);return false;},onChange:function(){var m=this.isFullScreen();h.conditionClass(document.body,'fullScreen',m);this.inform('changed');},isSupported:function(){return (document.webkitCancelFullScreen&&i.chrome())||document.mozCancelFullScreen||document.cancelFullScreen||document.exitFullScreen;}});e.exports=l;});
__d("PhotoSessionLog",["AsyncRequest","Run","Vector","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('Run'),i=b('Vector'),j=b('copyProperties');function k(){}j(k,{UNKNOWN:0,ESC:1,X:2,OUTSIDE:3,UNLOAD:4,NAVIGATE:5,AGGREGATE:6,LEAVE:7,PERMALINK:0,SNOWLIFT:6,AGGREGATION_COUNT:20,set:null,time:null,views:0,fbidList:[],details:{},width:0,height:0,first:false,last:false,logIds:false,version:null,buttonLikes:0,pagingAction:'',faceTagImpressions:0,cycle:false,endOfRelevant:false,relevantCount:0,initLogging:function(l){this.set=null;this.time=new Date();this.views=0;this.hiResLoads=0;this.fullScreenViews={};this.first=true;this.last=false;this.logIds=false;this.version=l;this.buttonLikes=0;this.pagingAction='';this.faceTagImpressions=0;this.cycle=false;this.endOfRelevant=false;this.relevantCount=0;if(l===k.SNOWLIFT){var m=i.getViewportDimensions();this.width=m.x;this.height=m.y;}},setLogFbids:function(l){this.logIds=l;},setPhotoSet:function(l){this.set=l;},addButtonLike:function(){this.buttonLikes++;},setPagingAction:function(l){this.pagingAction=l;},addFaceTagImpression:function(){this.faceTagImpressions++;},setCycle:function(l){this.cycle=l;},setEndOfRelevant:function(l){this.endOfRelevant=l;},setRelevantCount:function(l){this.relevantCount=l;},setEndMetrics:function(l){this.endMetrics=l;},addPhotoView:function(l,m,n){if(this.logIds&&this.views>=this.AGGREGATION_COUNT)this.logPhotoViews(this.AGGREGATE);this.views++;if(l)this.fbidList.push([l.fbid,l.owner,Date.now()]);if(m)this.hiResLoads++;if(n)this.fullScreenViews[l.fbid]=true;},logEnterFullScreen:function(l){this.fullScreenViews[l]=true;},addDetailData:function(l,m){if(!this.details[l])this.details[l]={t:m.num_tags,l:m.has_location,c:m.has_caption,cm:m.comment_count,lk:m.like_count,w:m.width,h:m.height,ad:'{}',p:this.pagingAction};},updateAdData:function(l,m){if(this.details[l])this.details[l].ad=JSON.stringify(m);},logPhotoViews:function(l){if((!this.views)||(this.version===k.SNOWLIFT&&l==k.LEAVE))return;if(l!=this.AGGREGATE)this.last=true;var m={set:this.set,time:new Date()-this.time,fbids:this.logIds?this.fbidList:[],details:this.logIds?this.details:{},first:this.first,last:this.last,close:l?l:this.UNKNOWN,button_likes:this.buttonLikes,version:this.version,face_imp:this.faceTagImpressions,endmetric:this.endMetrics,cycle:this.cycle,end_relev:this.endOfRelevant,relev_count:this.relevantCount};if(this.version===k.SNOWLIFT){var n=i.getViewportDimensions();m.width=n.x||this.width;m.height=n.y||this.height;if(this.hiResLoads>0)m.hires_loads=this.hiResLoads;if(this.last){var o=Object.keys(this.fullScreenViews).length;if(o>0)m.fullscreen=o;}}new g().setURI('/ajax/photos/logging/session_logging.php').setAllowCrossPageTransition(true).setOption('asynchronous',(l!=k.UNLOAD)).setOption('suppressErrorHandlerWarning',true).setData(m).send();this.views=0;this.hiResLoads=0;this.fbidList=[];this.details={};this.first=false;this.buttonLikes=0;if(this.last){this.set=null;this.logIds=false;this.fullScreenViews={};}}});h.onUnload(function(){k.logPhotoViews(k.UNLOAD);});h.onLeave(function(){k.logPhotoViews(k.LEAVE);});e.exports=k;});
__d("PhotosConst",[],function(a,b,c,d,e,f){var g={VIEWER_PERMALINK:0,VIEWER_SNOWLIFT:6,VIEWER_VAULTBOX:8,BULK_EDITOR:3,FLASH_UPLOADER:4,SIZE_NORMAL:'n'};e.exports=g;});
__d("PhotosUtils",["copyProperties","Rect","Vector"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('Rect'),i=b('Vector');function j(){}g(j,{getNearestBox:function(k,l){var m=Infinity,n=null;for(var o in k){var p=k[o];if(p.contains(l)){var q=l.distanceTo(p.getCenter());if(q<m){m=q;n=o;}}}return n;},absoluteToNormalizedPosition:function(k,l){var m=i.getElementPosition(k),n=i.getElementDimensions(k),o=l.sub(m).mul(100/n.x,100/n.y);o.domain='pure';return o;},normalizedToAbsolutePosition:function(k,l){var m=i.getElementPosition(k),n=i.getElementDimensions(k),o=l.mul(n.x/100,n.y/100).add(m);o.domain='document';return o;}});e.exports=j;});
__d("PhotoStreamCache",["array-extensions","HTML","PhotosConst","PhotoEverstoreLogger","Rect","UIPagelet","URI","Vector","copyProperties","createArrayFrom"],function(a,b,c,d,e,f){b('array-extensions');var g=b('HTML'),h=b('PhotosConst'),i=b('PhotoEverstoreLogger'),j=b('Rect'),k=b('UIPagelet'),l=b('URI'),m=b('Vector'),n=b('copyProperties'),o=b('createArrayFrom');function p(){}n(p,{ERROR:'error',HTML:'html',IMAGE_DATA:'image',EXTRA:'extra',BUFFER_SIZE:3,INIT_BUCKET_SIZE:4,FULL_BUCKET_SIZE:12,ERROR_ID:-1,INIT_PLACEHOLDER:1});n(p.prototype,{init:function(q,r){this.version=q;this.pageletName=r;this.bufferSize=p.BUFFER_SIZE;this.fullBucketSize=p.FULL_BUCKET_SIZE;this.initError=false;this.isActive=true;this.leftLock=false;this.rightLock=false;this.reset();},reset:function(){this.cache={image:{},extra:{},html:{}};this.fbidList=[];this.loaded=false;this.allLoaded=false;this.permalinkMap={};this.position=0;this.totalCount=null;this.firstCursor=null;this.firstCursorIndex=null;},waitForInitData:function(){this.fbidList.push(p.INIT_PLACEHOLDER);},destroy:function(){this.reset();this.isActive=false;},isLoaded:function(){return this.loaded;},canPage:function(){if(!this.isLoaded())return false;if(this.totalCount!==null)return this.totalCount>1;return this.getLength()>1;},errorInCurrent:function(){if(this.initError){return true;}else if(!this.isLoaded())return false;return this.checkErrorAt(this.getCursor());},getLength:function(){return this.fbidList.length;},getPhotoSet:function(){return this.photoSetQuery.set;},getPhotoSetQuery:function(){return this.photoSetQuery;},getCurrentImageData:function(){return this.getImageData(this.getCursor());},getImageData:function(q){return this.getCacheContent(q,p.IMAGE_DATA);},getCurrentHtml:function(){return this.getCacheContent(this.getCursor(),p.HTML);},getCurrentExtraData:function(){return this.getCacheContent(this.getCursor(),p.EXTRA);},getCacheContent:function(q,r){if(!q||q===p.ERROR_ID||q===p.INIT_PLACEHOLDER)return null;return this.cache[r][q];},getCursorPos:function(){return this.position;},getCursor:function(){if(this.position>=0&&this.position<this.getLength())return this.fbidList[this.position];return null;},getCursorForURI:function(q){return this.permalinkMap[q];},calculatePositionForMovement:function(q){var r=this.position+q;if(this.allLoaded){var s=this.getLength();r=(s+r%s)%s;}return r;},isValidMovement:function(q){if(!this.isLoaded()||!this.canPage())return false;var r=this.calculatePositionForMovement(q);return this.getCursor()>0||(r>=0&&r<this.getLength());},moveCursor:function(q){if(!this.isValidMovement(q))return;this.position=this.calculatePositionForMovement(q);if(q!==0)this.loadMoreIfNeccessary(q>0);},checkErrorAt:function(q){if(!this.isLoaded())return false;if(q===p.ERROR_ID)return true;return false;},getRelativeMovement:function(q){for(var r=0;r<this.getLength();r++)if(this.fbidList[r]==q)return r-this.position;return null;},preloadImages:function(q){var r,s,t=this.getLength(),u=this.cache.image,v=p.BUFFER_SIZE;if(t>v*2){r=(this.position+t-v%t)%t;s=(this.position+v)%t;}else{r=0;s=t-1;}while(r!=s){var w=this.fbidList[r];if(u[w]&&u[w].url)if(q&&!u[w].resource){u[w].resource=new Image();u[w].resource.src=u[w].url;if(u[w].everstoreLogThis===true)i.logImmediately(u[w].resource.src);}else if(!q&&!u[w].small){u[w].small=new Image();u[w].small.src=u[w].smallurl||u[w].url;if(u[w].everstoreLogThis===true)i.logImmediately(u[w].small.src);}r=(r+1)%t;}},loadMoreIfNeccessary:function(q){if(this.allLoaded||(q&&this.rightLock)||(!q&&this.leftLock))return;var r=q?1:-1,s=this.position+this.bufferSize*r;if(s<0&&!this.checkErrorAt(this.getEndCursor(false))){this.leftLock=true;this.fetch(this.fullBucketSize,false);}else if(s>this.getLength()&&!this.checkErrorAt(this.getEndCursor(true))){this.rightLock=true;this.fetch(this.fullBucketSize,true);}},getEndCursor:function(q){return q?this.fbidList[this.getLength()-1]:this.fbidList[0];},calculateRelativeIndex:function(q,r,s){if(!this.totalCount)return null;var t=this.fbidList.indexOf(r),u=this.fbidList.indexOf(s);if(t===-1||u===-1)return null;var v=u-t;return (q+v+this.totalCount)%this.totalCount;},calculateDistance:function(q,r){var s=this.fbidList.indexOf(q),t=this.fbidList.indexOf(r);if(s===-1||t===-1)return null;return (t-s+this.getLength())%this.getLength();},fetch:function(q,r){var s=this.getEndCursor(r),t=n({cursor:s,version:this.version,end:this.getEndCursor(!r),fetchSize:r?q:-1*q,relevant_count:this.relevantCount},this.photoSetQuery);if(this.totalCount&&this.firstCursorIndex!==null){t.total=this.totalCount;t.cursorIndex=this.calculateRelativeIndex(this.firstCursorIndex,this.firstCursor,s);}k.loadFromEndpoint(this.pageletName,null,t,{usePipe:true,jsNonblock:true,crossPage:true});},storeToCache:function(q){var r={};if(!this.isActive)return r;if('error' in q){this.processErrorResult(q.error);r.error=true;return r;}if('init' in q){this.processInitResult(q.init);r.init={logids:q.init.logids,fbid:q.init.fbid,loggedin:q.init.loggedin,fromad:q.init.fromad};}if('image' in q){this.processImageResult(q.image);r.image=true;}if('data' in q){this.processDataResult(q.data);r.data=true;}return r;},processInitResult:function(q){if(this.loaded)return;this.loaded=true;this.photoSetQuery=q.query;if(q.bufferSize)this.bufferSize=q.bufferSize;if(q.fullBucketSize)this.fullBucketSize=q.fullBucketSize;if(this.fbidList.length===0){this.fbidList.push(q.fbid);this.rightLock=true;}else{var r=this.fbidList.indexOf(p.INIT_PLACEHOLDER);if(r!=-1)this.fbidList[r]=q.fbid;}this.firstCursor=q.fbid;if('initIndex' in q&&'totalCount' in q){this.firstCursorIndex=q.initIndex;this.totalCount=q.totalCount;}if(this.version==h.VIEWER_PERMALINK)this.fetch(p.INIT_BUCKET_SIZE,true);},processImageResult:function(q){for(var r in q){if(r===this.firstCursor&&q[r].everstoreLogThis)i.logImmediately(q[r].url);this.cache.image[r]=q[r];if(q[r].dimensions)this.cache.image[r].dimensions=m.deserialize(q[r].dimensions);if(q[r].smalldims)this.cache.image[r].smalldims=m.deserialize(q[r].smalldims);this.permalinkMap[l(q[r].info.permalink).getUnqualifiedURI().toString()]=r;}},attachToFbidsList:function(q,r,s){if(this.allLoaded)return;if(r===-1){for(var t=q.length-1;t>=0;t--){this.fbidList.unshift(q[t]);this.position++;}this.leftLock=false;}else{for(var u=0;u<q.length;u++)this.fbidList.push(q[u]);this.rightLock=false;}if(s)this.setAllLoaded();},setAllLoaded:function(){this.allLoaded=true;if(this.getCursor()===null)this.position=this.calculatePositionForMovement(0);},processDataResult:function(q){for(var r in q){if(!this.cache.html[r])this.cache.html[r]={};for(var s in q[r].html){var t=q[r].html[s];if(typeof t==='string')t=g(t).getRootNode();this.cache.html[r][s]=o(t.childNodes);}if(!('extra' in q[r])){this.cache.extra[r]=null;continue;}this.cache.extra[r]={tagRects:{}};if(!Array.isArray(q[r].extra.tagRects))for(var u in q[r].extra.tagRects)if(q[r].extra.tagRects[u])this.cache.extra[r].tagRects[u]=j.deserialize(q[r].extra.tagRects[u]);}},processErrorResult:function(q){if(!this.isLoaded()){this.initError=true;return;}var r=q.side,s=[p.ERROR_ID];this.attachToFbidsList(s,r);},setTotalCount:function(q){this.totalCount=q;},setFirstCursorIndex:function(q){this.firstCursorIndex=q;}});e.exports=p;});
__d("PhotoSnowliftAds",["array-extensions","event-extensions","copyProperties","CSS","DataStore","DOM","PhotoSessionLog","UIPagelet","URI","Vector"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('copyProperties'),h=b('CSS'),i=b('DataStore'),j=b('DOM'),k=b('PhotoSessionLog'),l=b('UIPagelet'),m=b('URI'),n=b('Vector'),o={DEFAULT_UNITS_REFRESH_RATE:30000,UNITS_REGISTER_DELAY:1000,root:null,availableDimensions:null,loadQuery:null,lastLoadTime:0,minAds:100,units:null,isLogAdData:null,showSmallerAd:false,egoEnabled:false,refreshUnitsRate:null,adsStatus:'null',adsEvents:{},resetEvents:function(){this.adsStatus='reset';this.adsEvents={};},addEvent:function(p,q){if(q)this.adsStatus=p;var r=Date.now();this.adsEvents[p+'_'+r]=r;},init:function(p,q,r){this.reset();this.root=p;this.snowlift=q;this.showSmallerAd=r.showsmallerad;this.egoEnabled=r.ego_enabled;this.minAds=r.min_ads;this.addEvent('init',true);this.refreshUnitsRate=o.DEFAULT_UNITS_REFRESH_RATE;if(r.refresh_fast)this.refreshUnitsRate=r.refresh_rate;},reset:function(){this.lastLoadTime=0;this.units=[];this.resetEvents();this.addEvent('reset',true);},resize:function(p){this.availableDimensions=p;this.loadQuery=this.snowlift.getLoadQuery();this.processResize();},calculateUnitSizes:function(p,q){var r={};p.forEach(function(s){var t=s.root.firstChild.offsetHeight;s.units.forEach(function(v){if(!h.hasClass(v,'hidden')){var w=this.getHeight(v.firstChild,q);t-=w;}}.bind(this));var u={height:t,visible:false};s.units.forEach(function(v){var w=this.getIsAds(v),x=this.getHeight(v.firstChild,q),y=this.getUnitId(v);r[y]={height:x,visible:false,priority:0,is_ads:w,section_ref:u};}.bind(this));}.bind(this));return r;},calculateVisibleUnits:function(p,q,r){var s=0,t=this.getUnitPriority(q);t.forEach(function(u){if(q.hasOwnProperty(u)){var v=q[u],w=v.height;if(!v.section_ref.visible)w+=v.section_ref.height;v.height_below=r-w;v.visible=v.height_below>=0&&w>0;if(v.visible){v.section_ref.visible=true;r-=w;s++;}}}.bind(this));return q;},displayUnits:function(p,q){p.forEach(function(r){var s=false;r.units.forEach(function(t){var u=this.getUnitId(t),v=q[u],w=v.visible,x=v.height_below,y=v.is_ads;h.conditionClass(t,'hidden',!w);s=s||w;this.calcUnitStats(this.units[y][u],w,x);}.bind(this));h.conditionClass(r.root,'hidden',!s);}.bind(this));},getUnitPriority:function(p){var q=[],r=0,s=0;for(var t in p){var u=p[t];q.push(t);var v=this.minAds+r+s;if(u.is_ads){if(s<this.minAds)v=s;s++;}else r++;u.priority=v;}q=q.sort(function(w,x){var y=p[w],z=p[x];return y.priority-z.priority;}.bind(this));return q;},updateUnitsStatus:function(){var p=this.availableDimensions.x,q=this.availableDimensions.y,r=this.calculateUnitSizes(this.sections,p);r=this.calculateVisibleUnits(this.sections,r,q);this.displayUnits(this.sections,r);},calcUnitStats:function(p,q,r){var s=Date.now();if(p.visible)p.totalTime+=s-p.lastShowTime;if(p.trackingCode!==null&&p.totalTime>=this.UNITS_REGISTER_DELAY){var t=p.trackingCode;p.trackingCode=null;this.registerImpression(t,p.registerUrl);}p.visible=q;p.heightBelow=r;p.lastShowTime=s;},prepareResize:function(){var p=function(q){var r=j.create('div',{className:'inner'}),s=j.create('div',{className:'wrapper'},r);j.replace(q,s);j.setContent(r,q);return s;};this.sections=j.scry(this.root,'div.ego_section').map(function(q){return {root:p(q),units:j.scry(q,'div.ego_unit').map(p)};});},processResize:function(){if(this.isLoading||this.lastLoadTime===0||this.availableDimensions===null){this.setLogData();return;}this.updateUnitsStatus();this.setLogData();var p=this.nextRegisterTime();if(p!==Infinity)this.processResize.bind(this).defer(p,true);},setIsLogAdData:function(p){this.isLogAdData=p;this.addEvent('setIsLogAdData',false);this.setLogData();},setLogData:function(){var p=this.snowlift.getImageId();if(this.isLogAdData&&p){var q=n.getElementDimensions(this.snowlift.getImage()),r=n.getElementDimensions(this.snowlift.getRHCHeader()),s=n.getElementDimensions(this.snowlift.getRHCBody()),t=n.getElementDimensions(this.snowlift.getRHCFooter()),u={query_set:this.snowlift.getLoadQuery().set,window_x:window.innerWidth,window_y:window.innerHeight,image_x:q.x,image_y:q.y,header_x:r.x,header_y:r.y,body_x:s.x,body_y:s.y,footer_x:t.x,footer_y:t.y,ads_below_space:this.getAdsBelowSpace(),time:Date.now(),adsStatus:this.adsStatus,adsEvents:this.adsEvents};k.updateAdData(p,u);}},getAdsBelowSpace:function(){var p=[],q=this.units[1];for(var r in q)if(q.hasOwnProperty(r))p.push(q[r].heightBelow);return p;},getIsAds:function(p){var q=j.scry(p,'div.fbAdUnit');return q.length;},getUnitId:function(p){if(this.getIsAds(p)){return this.getAdId(p);}else return this.getEgoId(p);},getEgoId:function(p){var q=j.find(p,'div.fbEgoUnit'),r=q.getAttribute('data-ego'),s=JSON.parse(r).egoid;return s;},getAdId:function(p){var q=j.find(p,'div.fbAdUnit'),r=q.getAttribute('data-ad'),s=JSON.parse(r).adid;return s;},nextRegisterTime:function(){var p=Infinity,q=g(g({},this.units[0]),this.units[1]);for(var r in q)if(q.hasOwnProperty(r)){var s=q[r];if(s.trackingCode!==null&&s.visible)p=Math.min(p,this.UNITS_REGISTER_DELAY-s.totalTime);}return p;},getHeight:function(p,q){var r=i.get(p,'height');if(r&&r.x===q)return r.y;return this.cacheHeight(p,q);},cacheHeight:function(p,q){var r={x:q,y:p.offsetHeight};i.set(p,'height',r);return r.y;},loadAdsAndEgo:function(){this.resetEvents();this.addEvent('adsRequested',true);l.loadFromEndpoint('WebEgoPane',this.root.id,{pid:34,data:[this.loadQuery.set,true,this.egoEnabled]},{crossPage:true,bundle:false});},unitsLoaded:function(p,q){var r;if(q){r='/ai.php';this.addEvent('adsLoaded',true);}else{r='/ajax/ei.php';this.addEvent('egoLoaded',true);}var s={};for(var t in p)if(p.hasOwnProperty(t))s[t]={trackingCode:p[t],totalTime:0,lastShowTime:0,heightBelow:-10000,visible:false,registerUrl:r};this.units[q]=s;if(q)this.waitForImages(this.imagesLoaded.bind(this));},imagesLoaded:function(){this.prepareResize();this.addEvent('imagesLoaded',true);this.lastLoadTime=Date.now();this.isLoading=false;this.processResize();h.removeClass(this.root,'loading');},loadAdsFromUserActivity:function(){var p=Date.now(),q=this.refreshUnitsRate;if(!this.isLoading&&p-this.lastLoadTime>q){h.addClass(this.root,'loading');this.isLoading=true;this.loadAdsAndEgo();}},registerImpression:function(p,q){var r=j.create('iframe',{src:m(q).addQueryData({aed:p}),width:0,height:0,frameborder:0,scrolling:'no',className:'fbEmuTracking'});r.setAttribute('aria-hidden','true');j.appendContent(this.root,r);},waitForImages:function(p){var q=j.scry(this.root,'img.img'),r=q.length,s=r;if(s===0)p();var t=function(){s--;if(s===0)p.defer();};for(var u=0;u<r;u++){var v=q[u];if(v.complete){t();}else Event.listen(v,{load:t,error:t,abort:t});}}};e.exports=o;});
__d("PhotoViewer",["Bootloader","copyProperties"],function(a,b,c,d,e,f){var g=b('Bootloader'),h=b('copyProperties');function i(){this.image=null;this.root=null;this.stream=null;}h(i,{bootstrap:function(j,k){g.loadModules(['PhotoSnowlift'],function(l){l.bootstrap(j,k);});}});h(i.prototype,{getEventPrefix:bagof(null),getEventString:function(j){var k=this.getEventPrefix();if(k)return k+'.'+j;return null;},getImage:function(){return this.image;},getPosition:function(){return this.stream?this.stream.getCursor():null;},getRoot:function(){return this.root;},getSourceString:bagof(null),getVersionConst:bagof(null)});e.exports=i;});
__d("PhotoSnowlift",["array-extensions","event-extensions","function-extensions","Arbiter","AsyncDialog","AsyncRequest","Bootloader","Class","CSS","Dialog","DOM","DOMControl","DOMScroll","FullScreen","ImageUtils","KeyEventController","Keys","LinkController","Locale","PageTransitions","Parent","PhotosConst","PhotoSessionLog","PhotoSnowliftAds","PhotoStreamCache","PhotosUtils","PhotoViewer","Rect","ScrollableArea","Style","Toggler","UIPagelet","URI","UserAgent","Vector","$","computeRelativeURI","copyProperties","createArrayFrom","ge","goURI","tx","userAction"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncDialog'),i=b('AsyncRequest'),j=b('Bootloader'),k=b('Class'),l=b('CSS'),m=b('Dialog'),n=b('DOM'),o=b('DOMControl'),p=b('DOMScroll'),q=b('FullScreen'),r=b('ImageUtils'),s=b('KeyEventController'),t=b('Keys'),u=b('LinkController'),v=b('Locale'),w=b('PageTransitions'),x=b('Parent'),y=b('PhotosConst'),z=b('PhotoSessionLog'),aa=b('PhotoSnowliftAds'),ba=b('PhotoStreamCache'),ca=b('PhotosUtils'),da=b('PhotoViewer'),ea=b('Rect'),fa=b('ScrollableArea'),ga=b('Style'),ha=b('Toggler'),ia=b('UIPagelet'),ja=b('URI'),ka=b('UserAgent'),la=b('Vector'),ma=b('$'),na=b('computeRelativeURI'),oa=b('copyProperties'),pa=b('createArrayFrom'),qa=b('ge'),ra=b('goURI'),sa=b('tx'),ta=b('userAction'),ua=b('event-extensions').$E;function va(){this.parent.construct(this);}oa(va,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_PIXELS:'image_pixels',STATE_IMAGE_DATA:'image',LOADING_TIMEOUT:2000,PAGER_FADE:3000,FULL_SCREEN_PADDING:10,STAGE_HIRES_MAX:{x:2048,y:2048},STAGE_NORMAL_MAX:{x:960,y:960},STAGE_MIN:{x:520,y:520},SIDEBAR_SIZE_MAX:340,SIDEBAR_SIZE_MIN:285,STAGE_CHROME:{x:102,y:42},VIDEO_BOTTOM_BAR_SPACE:40,GOPREV_AREA:120,TIMELINE_STRETCH_WIDTH:843,TIMELINE_STRETCH_MIN:480,MIN_TAG_DISTANCE:83,PADDING_MIN:40,_instance:null,getInstance:function(){if(!va._instance)va._instance=new va();return va._instance;},initInstance:function(wa,xa){va.getInstance().init(wa,xa);},addPhotoFbids:function(wa,xa,ya,za){va.getInstance().addPhotoFbids(wa,xa,ya,za);},attachFollowFlyout:function(wa){n.insertAfter(ma('fbPhotoSnowliftSubscribe'),wa);},attachSubscribeFlyout:function(wa){n.insertAfter(ma('fbPhotoSnowliftSubscribe'),wa);},attachTagger:function(wa){va.getInstance().attachTagger(wa);},preload:function(wa,xa){va.getInstance().preload(wa,xa);},bootstrap:function(wa,xa){if(xa.getAttribute('data-vaultbox')){j.loadModules(['VaultBox'],function(ya){ya.bootstrap(wa,xa);});return;}if(wa&&ja(wa).getQueryData().hasOwnProperty('share_id')){j.loadModules(['SpotlightShareViewer'],function(ya){ya.bootstrap(wa,xa);});return;}va.getInstance().bootstrap(wa,xa);},closeRefresh:function(){va.getInstance().closeRefresh();},deletePhoto:function(wa){va.getInstance().deletePhoto(wa);},getImage:function(){return va.getInstance().getImage();},getImageId:function(){return va.getInstance().getImageId();},getLoadQuery:function(){return va.getInstance().getLoadQuery();},getRHCBody:function(){return va.getInstance().getRHCBody();},getRHCFooter:function(){return va.getInstance().getRHCFooter();},getRHCHeader:function(){return va.getInstance().getRHCHeader();},getRoot:function(){return va.getInstance().getRoot();},likePhotoSkipConfirmation:function(wa){va.getInstance().likePhotoSkipConfirmation(wa);},saveTagsFromPayload:function(wa){va.getInstance().saveTagsFromPayload(wa);},saveTagsFromPayloadDelayed:function(wa){va.saveTagsFromPayload.curry(wa).defer(2000);},handleServerError:function(wa,xa){va.getInstance().handleServerError(wa,xa);},storeFromData:function(wa){va.getInstance().storeFromData(wa);},swapData:function(){va.getInstance().swapData();},touchMarkup:bagofholding,updateTotalCount:function(wa,xa,ya){va.getInstance().updateTotalCount(wa,xa,ya);}});k.extend(va,da);oa(va.prototype,{switchTimer:null,imageRefreshTimer:null,imageLoadingTimer:null,lastPage:0,currentMinSize:null,extraClass:null,currentImageSize:null,resetUriStack:true,thumbSrc:null,shouldStretch:false,stageMax:va.STAGE_NORMAL_MAX,stageChrome:va.STAGE_CHROME,stagePagerPrev:null,ua:null,showHiRes:false,showHover:false,skipLikePhotoConfirmation:false,isShowingLikePhotoConfirmation:false,preload:function(wa,xa){j.loadModules(['fb-photos-snowlift-css','Live','PhotoTagApproval','PhotoTagger','PhotoTags','TagTokenizer','fb-photos-snowlift-fullscreen-css'],bagofholding);var ya=this.getImageSrc(ja(wa).getQueryData());if(ya)(new Image()).src=ya;},bootstrap:function(wa,xa){this.preload(wa,xa);aa.reset();this.resetUriStack=true;if(this.isOpen)if(this.openExplicitly){this.closeCleanup();this.resetUriStack=false;}else return;this.ua=ta('snowlift',xa,null,'FORCE').set_namespace('snowlift').set_ua_id('open');this.returningToStart=false;this.loading&&l.removeClass(this.loading,'loading');if(xa){l.addClass((this.loading=xa),'loading');this.getThumbAndSize(xa);}else this.loading=null;g.inform('PhotoSnowlift.GO',wa,g.BEHAVIOR_STATE);this.loadFrameIfUninitialized();},getEventPrefix:function(){return 'PhotoSnowlift';},getRoot:function(){return this.root;},getSourceString:function(){return 'snowlift';},getVersionConst:function(){return y.VIEWER_SNOWLIFT;},getImage:function(){return this.image;},getImageId:function(){return this.stream.getCursor();},getRHCHeader:function(){return this.rhcHeader;},getRHCBody:function(){return this.ufiForm;},getRHCFooter:function(){return this.rhcFooter;},getLoadQuery:function(){return this.loadQuery;},getOwnerId:function(){var wa=this.stream.getCurrentImageData();if(wa)return wa.info.owner;return null;},getThumbAndSize:function(wa){this.currentImageSize=null;this.thumbSrc=null;var xa=ja(wa.getAttribute('ajaxify')).getQueryData();if(!xa.size)return;var ya=la.deserialize(xa.size);if(!ya.x||!ya.y)return;this.currentImageSize=ya;if(!l.hasClass(wa,'uiMediaThumb')&&!l.hasClass(wa,'uiPhotoThumb')&&!l.hasClass(wa,'uiScaledThumb'))return;if(wa.getAttribute('data-cropped'))return;var za=n.scry(wa,'img')[0],ab=n.scry(wa,'i')[0],bb=x.byAttribute(wa,'data-size');this.shouldStretch=bb&&this.currentImageSize&&za&&bb.getAttribute('data-size')==="2"&&this.currentImageSize.x>this.currentImageSize.y&&this.currentImageSize.x<=va.TIMELINE_STRETCH_WIDTH&&za.offsetWidth===va.TIMELINE_STRETCH_WIDTH;var cb;if(za){cb=za.src;}else if(ab){cb=ga.get(ab,'backgroundImage').replace(/.*url\("?([^"]*)"?\).*/,'$1');}else return;this.thumbSrc=cb;},loadFrameIfUninitialized:function(){if(this.root)return;new i('/ajax/photos/snowlift/init.php').setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();},init:function(wa,xa){this.showHiRes=xa.hires;this.showHover=xa.pivot_hover;z.setEndMetrics(xa.pivot_end_metric);this.showEndPivot=xa.pivot_end;this.fullscreen=xa.hires&&q.isSupported();this.showOGVideos=xa.og_videos;this.stageMax=this.showHiRes?va.STAGE_HIRES_MAX:va.STAGE_NORMAL_MAX;var ya=qa('fbPhotoSnowlift');if(!ya){ya=n.appendContent(document.body,wa)[0];this.initialLoad=false;}if(this.root==ya)return;this.initializeNodes(ya);aa.init(this.sideAdUnit,this,xa);if(!this.subscription){u.registerHandler(this.handleNavigateAway.bind(this));this.subscription=g.subscribe('PhotoSnowlift.GO',function(za,ab){this.openExplicitly=true;this.loading&&l.removeClass(this.loading,'loading');this.open(ab);}.bind(this));}this.transitionHandlerRegistered=false;this.returningToStart=false;w.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));if(this.fullscreen)q.subscribe('changed',this.onFullScreenChange.bind(this));},onFullScreenChange:function(){if(q.isFullScreen()){if(!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))this.collapseRHC();var wa=this.stream.getCurrentImageData();if(wa&&wa.url&&this.image.src!==wa.url&&this.shouldShowHiRes(wa))this.switchImage(wa.url);this.adjustForResize();}else this.uncollapseRHC();ha.hide();},initializeNodes:function(wa){this.root=wa;this.container=n.find(wa,'div.fbPhotoSnowliftContainer');this.snowliftPopup=n.find(this.container,'div.fbPhotoSnowliftPopup');this.rhc=n.find(this.snowliftPopup,'div.rhc');this.rhcHeader=n.find(this.rhc,'div.rhcHeader');this.rhcFooter=n.find(this.rhc,'div.rhcFooter');this.ufiForm=n.find(this.rhc,'form.fbPhotosSnowliftFeedbackForm');this.ufiInputContainer=ma('fbPhotoSnowliftFeedbackInput');this.scroller=n.find(this.ufiForm,'div.rhcScroller');this.scrollerBody=n.find(this.scroller,'div.uiScrollableAreaBody');this.stageWrapper=n.find(this.snowliftPopup,'div.stageWrapper');this.errorBox=n.find(this.stageWrapper,'div.stageError');this.image=n.find(this.stageWrapper,'img.spotlight');this.stage=n.find(this.stageWrapper,'div.stage');this.videoStage=n.find(this.stageWrapper,'div.videoStage');this.prevPager=n.find(this.snowliftPopup,'a.snowliftPager.prev');this.nextPager=n.find(this.snowliftPopup,'a.snowliftPager.next');this.stageActions=n.find(wa,'div.stageActions');this.buttonActions=n.find(this.stageActions,'div.fbPhotosPhotoButtons');this.sideAdUnit=ma('fbPhotoSnowliftAdsSide');l.conditionClass(this.root,'fullScreenAvailable',this.fullscreen);},initializeScroller:function(){this.initializeScroller=bagofholding;this.scrollableArea=fa.fromNative(this.scroller,{fade:true,persistent:true});var wa=function(event){var xa=ua(event).getTarget();if(n.contains(this.ufiInputContainer,xa)){var ya=o.getInstance(xa);if(ya){this.scrollableArea.scrollToBottom();var za=ya.subscribe('resize',function(){var bb=this.scrollableArea.isScrolledToBottom();this.adjustScroller();bb&&this.scrollableArea.scrollToBottom();}.bind(this)),ab=Event.listen(xa,'blur',function(){ya.unsubscribe(za);ab.remove();});}}}.bind(this);g.subscribe('ufi/comment',function(xa,ya){if(this.ufiForm===ya.form){this.adjustScrollerIfNecessary();this.scrollableArea.scrollToBottom();}}.bind(this));Event.listen(this.rhc,'click',function(event){var xa=event.getTarget();if(x.byTag(xa,'a')||x.byTag(xa,'button')||n.isNodeOfType(xa,'input'))this.adjustScrollerIfNecessary();}.bind(this));g.subscribe('reflow',function(){if(this.isOpen)this.adjustScroller();}.bind(this));g.subscribe(['reflow','CommentUFI.Pager'],function(){if(this.isOpen)this.adjustScroller();}.bind(this));if(this.ufiForm.attachEvent){this.ufiForm.attachEvent('onfocusin',wa);}else this.ufiForm.addEventListener('focus',wa,true);},openHandler:function(wa){if(this.isOpen||wa.getPath()!='/photo.php'||this.returningToStart||wa.getQueryData().closeTheater||wa.getQueryData().permPage||wa.getQueryData().makeprofile){this.openHandlerRegistered=false;return false;}this.open(wa);this._uriStack.push(ja(wa).getQualifiedURI().toString());w.transitionComplete();return true;},getImageSrc:function(wa){if(wa.smallsrc){if(!wa.size)return wa.smallsrc;var xa=la.deserialize(wa.size),ya=this.getStageSize(xa);if(ya.x<=va.STAGE_NORMAL_MAX.x&&ya.y<=va.STAGE_NORMAL_MAX.y)return wa.smallsrc;}return wa.src;},open:function(wa){var xa=ja(wa).getQueryData(),ya=this.getImageSrc(xa);if(ya){delete xa.src;delete xa.smallsrc;}if(this.resetUriStack)this._uriStack=[];if(!this.initialLoad){xa.firstLoad=true;this.initialLoad=true;}this.sessionID=Date.now();this.loadQuery=oa(xa,{ssid:this.sessionID});this.isOpen=true;this.pagersShown=false;this.refreshOnClose=false;this.hilitedTag=null;this.loadingStates={image:false,html:false};this.replaceUrl=false;this.stream=new ba();this.stream.init(y.VIEWER_SNOWLIFT,'PhotoViewerPagelet');this.fetchInitialData();this.setLoadingState(va.STATE_HTML,true);this.rhcCollapsed=false;this.keyHandlers=[s.registerKey('ESCAPE',this.closeListener.bind(this))];j.loadModules(['fb-photos-snowlift-css'],this._open.bind(this,wa,ya));if(this.showEndPivot)j.loadModules(['PhotoPivot'],function(za){this.pivots=za.getInstance();if(xa.relevant_count)this.pivots.setRelevantCount(xa.relevant_count);}.bind(this));},_open:function(wa,xa){this.createLoader(xa);l.show(this.root);(function(){var ab=la.getScrollPosition();l.addClass(document.documentElement,'theaterMode');var bb=p.getScrollbarSize();if(bb===0){this.extraClass='zeroScrollbar';}else if(bb===20){this.extraClass='scrollbar20';}else this.extraClass='defaultScrollbar';l.addClass(document.body,this.extraClass);p.scrollTo(ab,0);}).defer();this.ua&&this.ua.add_event('frame');g.inform('layer_shown',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.OPEN');this.stageHandlers=[Event.listen(window,'resize',this.adjustForResize.bind(this)),Event.listen(this.root,'click',this.closeListener.bind(this)),Event.listen(this.stageWrapper,'click',this.buttonListener.bind(this)),Event.listen(this.stageWrapper,'mouseleave',function(event){this.unhiliteAllTags();this.hidePagers();}.bind(this)),Event.listen(this.stageWrapper,'mousemove',this.hilitePagerOnMouseMove.bind(this)),Event.listen(this.stageWrapper,'mousemove',this.hiliteTagsOnMouseMove.bind(this))];this.stageHandlers.push(Event.listen(this.container,'click',(function(event){var ab=event.getTarget();if(x.byClass(ab,'rotateRight')){this.rotate('right');}else if(x.byClass(ab,'rotateLeft')){this.rotate('left');}else if(this.fullscreen)if(x.byClass(ab,'fbPhotoSnowliftFullScreen')){this.toggleFullScreen();}else if(x.byClass(ab,'fbPhotoSnowliftCollapse'))this.toggleCollapse();}).bind(this)));var ya=qa('fbPhotoSnowliftFeedback');if(ya)this.stageHandlers.push(Event.listen(ya,'click',function(event){if(x.byClass(event.getTarget(),'like_link'))this.toggleLikeButton();var ab=x.byClass(event.getTarget(),'uiUfiCollapsedComment');if(ab)l.addClass(ab,'uiUfiCollapsedCommentToggle');}.bind(this)));var za=qa('fbPhotoSnowliftOnProfile');if(za)this.stageHandlers.push(Event.listen(za,'click',function(event){if(x.byClass(event.getTarget(),'fbPhotoRemoveFromProfileLink'))this.refreshOnClose=true;}.bind(this)));if(this.resetUriStack)this.startingURI=ja.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI();if(!xa)this.setLoadingState(va.STATE_IMAGE_DATA,true);if(!this.transitionHandlerRegistered){w.registerHandler(this.transitionHandler.bind(this));this.transitionHandlerRegistered=true;}z.initLogging(z.SNOWLIFT);if(this.pivots)z.setRelevantCount(this.pivots.relevantCount);if(ka.firefox()<13)this.turnFlashAutoplayOff.defer();(function(){this.root.focus();}).bind(this).defer();},toggleFullScreen:function(){var wa=q.toggleFullScreen(document.documentElement);if(wa){var xa=this.stream.getCurrentImageData();if(xa&&xa.url&&this.image.src!==xa.url&&this.shouldShowHiRes(xa))(new Image()).src=xa.url;z.logEnterFullScreen(this.stream.getCursor());}},getStream:function(){return this.stream;},fetchInitialData:function(){this.ua&&this.ua.add_event('init_data');this.stream.waitForInitData();ia.loadFromEndpoint('PhotoViewerInitPagelet',null,this.loadQuery,{usePipe:true,jsNonblock:true,crossPage:true});},turnFlashAutoplayOff:function(){n.scry(document,'div.swfObject').forEach(function(wa){var xa=wa.getAttribute('data-swfid');if(xa&&window[xa]){var ya=window[xa];ya.addParam('autostart','false');ya.addParam('autoplay','false');ya.addParam('play','false');ya.addVariable('video_autoplay','0');ya.addVariable('autoplay','0');ya.addVariable('play','0');var za=ja(ya.getAttribute('swf'));za.addQueryData({autoplay:'0'});za.setPath(za.getPath().replace('autoplay=1','autoplay=0'));ya.setAttribute('swf',za.toString());ya.write(wa);}});},toggleCollapse:function(){if(this.rhcCollapsed){this.uncollapseRHC();}else this.collapseRHC();},collapseRHC:function(){this.rhcCollapsed=true;l.addClass(this.root,'collapseRHC');this.adjustForResize();},uncollapseRHC:function(){this.rhcCollapsed=false;l.removeClass(this.root,'collapseRHC');this.adjustForResize();},closeHandler:function(){if(!this.isOpen)return;if(ja.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI().toString()==this.startingURI.toString()){this.close();return;}this.close();this.returnToStartingURI(this.refreshOnClose);},returnToStartingURI:function(wa,xa){if(!wa)if(xa){this.squashNextTransition(ra.curry(xa));}else this.squashNextTransition();this.returningToStart=true;var ya=g.subscribe('page_transition',function(){this.returningToStart=false;ya.unsubscribe();}),za=wa||isNaN(ka.opera()),ab=this._uriStack.length;if(za&&ab<window.history.length){window.history.go(-ab);}else{var bb=this.startingURI,cb=new ja(bb).removeQueryData('closeTheater');if(bb.getQueryData().sk=='approve'&&bb.getPath()=='/profile.php'){cb.removeQueryData('highlight');cb.removeQueryData('notif_t');}ra(cb);}},squashNextTransition:function(wa){this.squashNext=true;w.registerHandler(function xa(){if(this.squashNext){this.squashNext=false;if(wa)wa.defer();w.transitionComplete();return true;}return false;}.bind(this));},handleNavigateAway:function(wa){var xa=na(w._most_recent_uri.getQualifiedURI(),wa.getAttribute('href'));if(this.isOpen&&(xa instanceof ja)&&xa.getUnqualifiedURI().toString()!=this.startingURI.toString()&&xa.getPath()!='/photo.php'){if(!this.closingAction)this.closingAction=z.NAVIGATE;this.close();this.returnToStartingURI(false,xa);return false;}return true;},closeListener:function(event){if(this.isOpen&&!m.getCurrent()){if(Event.getKeyCode(event)==t.ESC){if(!l.hasClass(this.root,'taggingMode')&&!l.hasClass(this.root,'fbPhotoSnowliftEditMode')){this.closingAction=z.ESC;Event.kill(event);this.closeHandler();}return;}var wa=event.getTarget(),xa=x.byClass(wa,'closeTheater'),ya=xa||wa==this.root||wa==n.find(this.root,'div.fbPhotoSnowliftOuter')||wa==n.find(this.root,'div.fbPhotoSnowliftInner');if(ya){if(q.isFullScreen()){if(xa)q.toggleFullScreen();return;}if(xa){this.closingAction=z.X;}else this.closingAction=z.OUTSIDE;Event.kill(event);this.closeHandler();}}},close:function(){if(!this.isOpen)return;if(this.fullscreen)q.disableFullScreen();ta('snowlift',null,null,'FORCE').set_namespace('snowlift').set_ua_id('close');l.hide(this.root);this.openExplicitly=false;this.closeCleanup.bind(this).defer();},closeCleanup:function(){var wa=la.getScrollPosition();l.removeClass(document.documentElement,'theaterMode');l.removeClass(document.body,this.extraClass);p.scrollTo(wa,0);l.removeClass(this.root,'dataLoaded');this.keyHandlers.forEach(function(ya){ya.remove();});this.keyHandlers=null;z.logPhotoViews(this.closingAction);this.destroy();l.hide(this.errorBox);l.hide(this.image);this.currentImageSize=null;this.thumbSrc=null;this.shouldStretch=false;this.resetUriStack=true;l.removeClass(this.stageWrapper,'showVideo');n.empty(this.videoStage);this.uncollapseRHC();this.currentMinSize=null;this.setStagePagersState('reset');this.recacheData();n.empty(this.sideAdUnit);this.stream.destroy();var xa=this.closingAction===z.NAVIGATE;this.closingAction=null;if(!this.openHandlerRegistered){w.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;}g.inform('layer_hidden',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.CLOSE',xa);this.root.setAttribute('aria-busy','true');this.isOpen=false;},createLoader:function(wa){if(this.currentImageSize===null){this.adjustStageSize(va.STAGE_MIN);}else{var xa=this.getStageSize(this.currentImageSize);xa=new la(Math.max(xa.x,va.STAGE_MIN.x),Math.max(xa.y,va.STAGE_MIN.y));var ya=this.getImageSizeInStage(this.currentImageSize,xa);if(this.thumbSrc===null){this.adjustStageSize(ya);}else this.useImage(n.create('img',{className:'spotlight',alt:'',src:this.thumbSrc,style:{width:ya.x+'px',height:ya.y+'px'}}),ya,false);}this.setLoadingState(this.STATE_IMAGE_PIXELS,true);if(wa)(function(){var za=new Image();za.onload=a.async_callback(function(){if(!this.isOpen||this.pendingImageUrl!=wa)return;if(!this.stream||!this.stream.errorInCurrent()){this.switchImage(wa,this.currentImageSize);this.ua&&this.ua.add_event('image');this.setLoadingState(va.STATE_IMAGE_DATA,false);}}.bind(this),'photo_theater');za.src=this.pendingImageUrl=wa;}).bind(this).defer();l.hide(this.stageActions);this.setStagePagersState('disabled');},initDataFetched:function(wa){z.setPhotoSet(this.stream.getPhotoSet());z.setLogFbids(wa.logids);var xa=this.stream.getCurrentImageData();z.addPhotoView(xa.info,this.shouldShowHiRes(xa),this.fullscreen&&q.isFullScreen());if(!this.pageHandlers){this.pageHandlers=[Event.listen(this.root,'click',this.pageListener.bind(this)),Event.listen(this.root,'mouseleave',this.mouseLeaveListener.bind(this))];this.keyHandlers=this.keyHandlers.concat([s.registerKey('LEFT',this.pageListener.bind(this)),s.registerKey('RIGHT',this.pageListener.bind(this)),s.registerKey('L',this.likePhotoWithKey.bind(this),function(event,ya){event=ua(event);return (ya=='onkeyup'&&s.filterEventTargets(event,ya)&&s.filterEventModifiers(event,ya));})]);}l.show(this.stageActions);this.root.setAttribute('aria-busy','false');this.isLoggedInViewer=wa.loggedin;this.disableAds=!this.isLoggedInViewer||wa.fromad;this.loadAds();},adjustScrollerIfNecessary:function(){clearTimeout(this.scrollerTimeout);this.scrollerTimeout=this.adjustScroller.bind(this).defer();},adjustScroller:function(){clearTimeout(this.scrollerTimeout);this.initializeScroller();this.scrollableArea.resize();var wa=la.getElementDimensions(this.rhc),xa=wa.y;xa-=la.getElementDimensions(this.rhcHeader).y;xa-=la.getElementDimensions(this.ufiInputContainer).y;var ya=la.getElementDimensions(this.scrollerBody).y;if(ya>=xa){ga.set(this.scroller,'height',xa+'px');l.addClass(this.rhc,'pinnedUfi');xa=0;}else{ga.set(this.scroller,'height','auto');l.removeClass(this.rhc,'pinnedUfi');xa-=ya;}var za=la.getElementDimensions(this.ufiInputContainer).y;ga.set(this.ufiForm,'padding-bottom',za+'px');aa.resize(new la(wa.x,xa));this.scrollableArea.adjustGripper();},adjustForResize:function(){this.currentMinSize=null;this.adjustStageSize();this.adjustForNewData();},shouldShowHiRes:function(wa){if(!this.showHiRes||!wa||!wa.smallurl)return false;var xa=this.getStageSize(wa.dimensions),ya=this.getImageSizeInStage(wa.dimensions,xa);return (ya.x>va.STAGE_NORMAL_MAX.x||ya.y>va.STAGE_NORMAL_MAX.y);},getImageURL:function(wa){if(wa.video){return null;}else if(wa.smallurl&&!this.shouldShowHiRes(wa))return wa.smallurl;return wa.url;},getImageDimensions:function(wa){if(wa.smalldims&&(!this.shouldShowHiRes(wa)||this.image.src===wa.smallurl))return wa.smalldims;return wa.dimensions;},getStageSize:function(wa,xa){var ya=la.getViewportDimensions(),za=new la(wa.x,wa.y);if(xa)za=new la(Math.max(wa.x,xa.x),Math.max(wa.y,xa.y));var ab,bb;if(this.fullscreen&&q.isFullScreen()){return new la((this.rhcCollapsed?screen.width:screen.width-va.SIDEBAR_SIZE_MAX),screen.height-va.FULL_SCREEN_PADDING*2);}else{ab=Math.min(za.x,this.stageMax.x,(ya.x-va.SIDEBAR_SIZE_MAX-va.STAGE_CHROME.x));bb=Math.min(za.y,this.stageMax.y,ya.y-va.STAGE_CHROME.y);}if(ab===0&&bb===0)return new la(0,0);var cb=ab/bb,db=za.x/za.y;if(cb<db)return new la(ab,Math.ceil(ab/db));return new la(Math.ceil(bb*db),bb);},getImageSizeInStage:function(wa,xa){var ya=wa.x,za=wa.y;if(ya>=xa.x||za>=xa.y){var ab=xa.x/xa.y,bb=ya/za;if(ab<bb){ya=xa.x;za=Math.ceil(ya/bb);}else if(ab>bb){za=xa.y;ya=Math.ceil(za*bb);}else{ya=xa.x;za=xa.y;}}return new la(ya,za);},adjustStageSize:function(wa){var xa=this.currentImageSize;if(wa){xa=wa;}else{var ya=this.stream&&this.stream.getCurrentImageData();if(ya)xa=this.getImageDimensions(ya);}if(!xa)return;this.currentImageSize=xa;var za=0;if(this.shouldStretch&&!this.getVideoOnStage()&&xa.x>xa.y&&xa.x<=va.TIMELINE_STRETCH_WIDTH&&xa.x>=va.TIMELINE_STRETCH_MIN){xa.y=Math.round(xa.y*va.TIMELINE_STRETCH_WIDTH/xa.x);xa.x=va.TIMELINE_STRETCH_WIDTH;}else if(this.getVideoOnStage()){za=va.VIDEO_BOTTOM_BAR_SPACE*2;xa.y+=za;}var ab=this.getStageSize(xa,this.currentMinSize);if(!this.currentMinSize)this.currentMinSize=new la(0,0);this.currentMinSize=new la(Math.max(ab.x,va.STAGE_MIN.x,this.currentMinSize.x),Math.max(ab.y,va.STAGE_MIN.y,this.currentMinSize.y));var bb=this.getImageSizeInStage(xa,this.currentMinSize),cb=this.currentMinSize.x-bb.x,db=this.currentMinSize.y-bb.y;if(cb>0&&cb<va.PADDING_MIN){this.currentMinSize.x-=cb;}else if(db>0&&db<va.PADDING_MIN)this.currentMinSize.y-=db;var eb=this.currentMinSize.x+va.SIDEBAR_SIZE_MAX;if(this.rhcCollapsed)eb=this.currentMinSize.x;this.snowliftPopup.style.cssText='width:'+eb+'px;'+'height:'+this.currentMinSize.y+'px;';var fb=this.currentMinSize.y-za+'px';if(ka.firefox()||ka.ie()<8){var gb=ga.get(this.stageWrapper,'font-size');if(ka.ie()&&gb.indexOf('px')<0){var hb=n.create('div');hb.style.fontSize=gb;hb.style.height='1em';gb=hb.style.pixelHeight;}fb=((this.currentMinSize.y-za)/parseFloat(gb))+'em';}this.stageWrapper.style.cssText='width:'+this.currentMinSize.x+'px;'+'line-height:'+fb+';';if(ka.ie()<8){ga.set(this.root,'height',la.getViewportDimensions().y+'px');ga.set(this.container,'min-height',(this.currentMinSize.y+va.STAGE_CHROME.y)+'px');}this.image.style.cssText='width:'+bb.x+'px;'+'height:'+bb.y+'px;';this.adjustScrollerIfNecessary();},adjustForNewData:function(){if(!this.image)return;var wa=n.scry(this.stage,'div.tagsWrapper')[0],xa=la.getElementDimensions(this.image);if(wa){ga.set(wa,'width',xa.x+'px');ga.set(wa,'height',xa.y+'px');if(ka.ie()<=7){var ya=n.scry(this.root,'div.tagContainer')[0];if(ya)l.conditionClass(wa,'ie7VerticalFix',la.getElementDimensions(ya).y>xa.y);}}},setLoadingState:function(wa,xa){switch(wa){case va.STATE_IMAGE_PIXELS:l.conditionClass(this.root,'imagePixelsLoading',xa);break;case va.STATE_IMAGE_DATA:this.loadingStates[wa]=xa;l.conditionClass(this.root,'imageLoading',xa);break;case va.STATE_HTML:this.loadingStates[wa]=xa;l.conditionClass(this.root,'dataLoading',xa);this.rhc.setAttribute('aria-busy',xa?'true':'false');break;}},destroy:function(){this.stageHandlers.forEach(function(wa){wa.remove();});if(this.pageHandlers){this.pageHandlers.forEach(function(wa){wa.remove();});this.pageHandlers=null;}},checkState:function(wa){if(wa!=va.STATE_ERROR&&!this.loadingStates[wa])return;switch(wa){case va.STATE_IMAGE_DATA:var xa=this.stream.getCurrentImageData();if(xa){var ya=this.getImageURL(xa);if(ya){this.switchImage(ya,null,true);}else if(xa.video)this.switchVideo(xa.video,true);this.setLoadingState(wa,false);}break;case va.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(wa,false);}break;default:if(this.stream.errorInCurrent()){l.hide(this.image);l.show(this.errorBox);}break;}},buttonListener:function(event){var wa=event.getTarget(),xa=Date.now();if(x.byClass(wa,'fbPhotoTagApprovalBox'))return;if(xa-this.lastPage<350)return;if(x.byClass(wa,'fbPhotosPhotoLike')){this.likePhoto();}else if(x.byClass(wa,'tagApproveIgnore'))this.updateTagBox(event,wa);},likePhoto:function(){z.addButtonLike();var wa=ma('fbPhotoSnowliftFeedback'),xa=n.scry(wa,'button.like_link')[0];if(xa){xa.click();}else{xa=n.find(wa,'a.UFILikeLink');xa.click();this.toggleLikeButton();}},toggleLikeButton:function(){var wa=n.scry(this.buttonActions,'a.fbPhotosPhotoLike')[0];if(wa){l.toggleClass(wa,'viewerLikesThis');l.removeClass(wa,'viewerAlreadyLikedThis');}},likePhotoWithKey:function(){if(this.isShowingLikePhotoConfirmation)return;if(this.skipLikePhotoConfirmation){this.likePhoto();}else h.send(new i('/photos/confirm_like.php'),function(wa){this.isShowingLikePhotoConfirmation=true;wa.subscribe('confirm',this.onCloseLikePhotoConfirmDialog.bind(this));wa.subscribe('cancel',this.onCloseLikePhotoConfirmDialog.bind(this));}.bind(this));return false;},likePhotoSkipConfirmation:function(wa){this.skipLikePhotoConfirmation=wa;this.likePhoto();},onCloseLikePhotoConfirmDialog:function(){this.isShowingLikePhotoConfirmation=false;},updateTagBox:function(wa,xa){this.unhiliteAllTags();var ya=qa(wa);if(!ya)return;l.addClass(ya,'tagBox');l.addClass(ya,'tagBoxPendingResponse');l.removeClass(ya,'tagBoxPending');l.hide(n.find(ya,'span.tagForm'));if(xa){l.show(n.find(ya,'span.tagApproved'));}else l.show(n.find(ya,'span.tagIgnored'));},rotate:function(wa){var xa=this.stream.getCursor();if(this.getVideoOnStage()){var ya=(wa=='left')?270:90;j.loadModules(['VideoRotate'],function(ab){new ab(xa).motionRotate(ya);});return;}var za=oa({fbid:xa,cs_ver:y.VIEWER_SNOWLIFT},this.stream.getPhotoSetQuery());za[wa]=1;this.setLoadingState(va.STATE_IMAGE_DATA,true);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);l.hide(this.image);new i('/ajax/photos/photo/rotate/').setAllowCrossPageTransition(true).setData(za).setErrorHandler(this.rotationError.bind(this,xa)).setFinallyHandler(this.rotationComplete.bind(this,xa)).setMethod('POST').setReadOnly(false).send();},rotationComplete:function(wa,xa){if(wa==this.stream.getCursor()){this.setLoadingState(va.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));this.swapData();}},rotationError:function(wa,xa){if(wa==this.stream.getCursor()){this.setLoadingState(va.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));j.loadModules(['AsyncResponse'],function(ya){ya.defaultErrorHandler(xa);});}},saveTagsFromPayload:function(wa){this.storeFromData(wa);if('data' in wa&&this.stream.getCursor() in wa.data)this.swapData();},saveEdit:function(){if(!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))return;j.loadModules(['PhotoInlineEditor','Form'],function(wa,xa){var ya=wa.getInstance(this.getViewerConst());ya&&xa.bootstrap(ya.getForm().controller);}.bind(this));},mouseLeaveListener:function(event){this.unhiliteAllTags();this.reHilitePendingTag();},hilitePagerOnMouseMove:function(event){var wa=la.getEventPosition(event),xa=la.getElementPosition(this.stage);if(v.isRTL()){var ya=la.getElementDimensions(this.stage);this.stagePagerPrev=ya.x-(wa.x-xa.x)<va.GOPREV_AREA;}else this.stagePagerPrev=wa.x-xa.x<va.GOPREV_AREA;l.conditionClass(this.prevPager,'hilightPager',this.stagePagerPrev);l.conditionClass(this.nextPager,'hilightPager',!this.stagePagerPrev);var za,ab=event.getTarget();if(!x.byClass(ab,'snowliftOverlay')&&!x.byClass(ab,'bottomBarActions')&&!x.byClass(ab,'snowliftPager'))za=va.PAGER_FADE;this.showPagers(za);},showPagers:function(wa){clearTimeout(this.fadePagerTimer);this.setStagePagersState('active');if(typeof wa!=='undefined')this.fadePagerTimer=this.hidePagers.bind(this).defer(wa);},hidePagers:function(){var wa=n.scry(this.getRoot(),'.fbPhotosPhotoActionsMenu')[0];if(wa)return;clearTimeout(this.fadePagerTimer);this.setStagePagersState('inactive');},unhiliteAllTags:function(){n.scry(this.stage,'div.tagsWrapper div.hover').forEach(function(wa){l.removeClass(wa,'hover');});this.hilitedTag=null;},switchHilitedTags:function(wa,xa){if(this.switchTimer!==null){clearTimeout(this.switchTimer);this.switchTimer=null;}this.unhiliteAllTags();var ya=qa(wa);if(ya){this.hilitedTag=wa;l.addClass(ya,'hover');if(l.hasClass(ya,'tagBoxPending')&&!l.hasClass(ya,'showPendingTagName')&&xa===true){n.scry(this.stage,'div.tagsWrapper div.showPendingTagName').forEach(function(za){l.removeClass(za,'showPendingTagName');});l.addClass(ya,'showPendingTagName');}}},reHilitePendingTag:function(){var wa=qa(this.hilitedTag);if(wa&&l.hasClass(wa,'showPendingTagName'))return;var xa=n.scry(this.stage,'div.tagsWrapper div.showPendingTagName')[0];if(xa)this.switchHilitedTags(xa.id);},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.switchTimer!==null)return;var wa=event.getTarget();if(x.byClass(wa,'fbPhotoSnowliftTagApproval')||x.byClass(wa,'tagPointer'))return;var xa=x.byClass(wa,'tagBoxPending'),ya=(this.hilitedTag&&l.hasClass(ma(this.hilitedTag),'tagBoxPending')),za=((!this.hilitedTag&&xa)||(!ya&&xa));if(za){this.switchHilitedTags(xa.id);return;}if(xa&&(xa.id==this.hilitedTag))return;var ab=250,bb=ca.absoluteToNormalizedPosition(this.image,la.getEventPosition(event)),cb=ca.getNearestBox(this.stream.getCurrentExtraData().tagRects,bb);if(!cb){if(!ya){this.unhiliteAllTags();this.reHilitePendingTag();}return;}if(this.currentTagHasPrecedence(bb))return;var db=null;if(ya){var eb={};eb[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];db=ca.getNearestBox(eb,bb);}if(db!==null&&ya)return;if(this.hilitedTag!=cb)if(ya){this.switchTimer=this.switchHilitedTags.bind(this,cb).defer(ab);}else{if(this.showHover){if(!this.seenTags)this.seenTags=[];if(!this.seenTags[cb]){z.addFaceTagImpression();this.seenTags[cb]=true;}}this.switchHilitedTags(cb);}},currentTagHasPrecedence:function(wa){if(!this.hilitedTag)return false;var xa=this.stream.getCurrentExtraData().tagRects[this.hilitedTag],ya=new ea(xa.t+(xa.h()/2),xa.r,xa.b,xa.l,xa.domain);return ya.contains(wa);},getVideoOnStage:function(){var wa=this.stream&&this.stream.getCurrentImageData();return wa&&wa.video;},shouldPageOnAction:function(wa,xa){if(!this.isOpen||this.isShowingLikePhotoConfirmation)return false;var ya=n.isNode(xa)&&(x.byClass(xa,'snowliftPager')||x.byClass(xa,'stagePagers')||x.byClass(xa,'pivotPageColumn')),za=n.isNode(xa)&&x.byClass(xa,'stage'),ab=((za&&l.hasClass(this.root,'taggingMode'))||x.byClass(xa,'tagBoxPending')||x.byClass(xa,'tagBoxPendingResponse')||x.byClass(xa,'fbPhotoTagApprovalBox')||x.byClass(xa,'tag'));if(ab)return false;return wa==t.LEFT||wa==t.RIGHT||ya||za;},pageListener:function(event){var wa=Event.getKeyCode(event),xa=event.getTarget();if(!this.shouldPageOnAction(wa,xa))return;var ya=0;if(wa==t.RIGHT){ya=1;z.setPagingAction('key_right');}else if(wa==t.LEFT){ya=-1;z.setPagingAction('key_left');}else if(x.byClass(xa,'next')){ya=1;z.setPagingAction('click_next');}else if(x.byClass(xa,'prev')){ya=-1;z.setPagingAction('click_prev');}else if(!this.stagePagerPrev){ya=1;z.setPagingAction('click_stage');}else{ya=-1;z.setPagingAction('click_stage_back');}if(l.hasClass(this.root,'fbPhotoSnowliftEditMode')){this.warnLeavePage(ya);}else{this.page(ya);ta('a',xa,event,'FORCE').set_namespace('snowlift').set_ua_id(z.pagingAction);}},warnLeavePage:function(wa){new m().setTitle("Are you sure you want to leave this page?").setBody("You have unsaved changes that will be lost if you leave the page.").setButtons([{name:'leave_page',label:"Leave this Page",handler:this.page.bind(this,wa)},{name:'continue_editing',label:"Stay on this Page",className:'inputaux'}]).setModal(true).show();},page:function(wa,xa){if(!this.stream.isValidMovement(wa)){this.showPagers(va.PAGER_FADE);return;}this.lastPage=Date.now();this.unhiliteAllTags();this.seenTags=[];var ya=this.getVideoOnStage();if(ya)this.switchVideo(ya,false);if(this.pivots&&this.pivots.page(wa))return;g.inform('PhotoSnowlift.PAGE');ha.hide();this.recacheData();this.stream.moveCursor(wa);l.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(va.STATE_HTML,true);l.show(this.errorBox);return;}var za=this.stream.getCurrentImageData();if(za){var ab=this.getImageURL(za);if(ab){this.switchImage(ab,null,true);}else if(za.video)this.switchVideo(za.video,true);if(!xa){this.replaceUrl=true;ra(za.info.permalink);}}else{this.setLoadingState(va.STATE_IMAGE_PIXELS,true);this.setLoadingState(va.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(va.STATE_HTML,true);this.disableAds=!this.isLoggedInViewer;this.loadAds();},logImpressionDetailsForPhoto:function(){var wa=[].concat(n.scry(ma('fbPhotoSnowliftTagList'),'input.photoImpressionDetails'),n.scry(ma('fbPhotoSnowliftFeedback'),'input.photoImpressionDetails'));if(wa.length===0)return;var xa={};for(var ya=0;ya<wa.length;ya++)xa[wa[ya].name]=wa[ya].value;if(this.getVideoOnStage()){xa.width=0;xa.height=0;}else{var za=this.getImageDimensions(this.stream.getCurrentImageData());xa.width=za.x;xa.height=za.y;}z.addDetailData(this.stream.getCursor(),xa);aa.setIsLogAdData(true);},loadAds:function(){if(this.disableAds)return;aa.loadAdsFromUserActivity();},transitionHandler:function(wa){if(wa.getQueryData().closeTheater||wa.getQueryData().permPage||wa.getQueryData().makeprofile||this.returningToStart){if(this.isOpen)this.close();this.transitionHandlerRegistered=false;return false;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(wa.getQualifiedURI().toString());w.transitionComplete();return true;}var xa=this._uriStack.length;if(xa>=2&&this._uriStack[xa-2]==wa.getQualifiedURI().toString())this._uriStack.pop();var ya=this.stream.getCursorForURI(wa.getUnqualifiedURI().toString());if(ya){var za=this.stream.getRelativeMovement(ya);this.page(za,true);w.transitionComplete();return true;}if(this.isOpen){this.close();w.transitionComplete();return true;}this.transitionHandlerRegistered=false;return false;},recacheData:function(){if(!this.loadingStates.html){var wa=this.stream.getCurrentHtml();for(var xa in wa){wa[xa]=pa(ma(xa).childNodes);n.empty(ma(xa));}}},reloadIfTimeout:function(){if(!r.hasLoaded(this.image)){var wa=this.makeNewImage(this.image.src,true);Event.listen(wa,'load',this.useImage.bind(this,wa,null,true));}},useImage:function(wa,xa,ya){if(ya&&r.hasLoaded(this.image))return;n.replace(this.image,wa);this.image=wa;this.adjustStageSize(xa);},makeNewImage:function(wa,xa){if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}else if(!xa)this.imageRefreshTimer=setTimeout(this.reloadIfTimeout.bind(this),va.LOADING_TIMEOUT);var ya=n.create('img',{className:'spotlight',alt:''});ya.setAttribute('aria-describedby','fbPhotosSnowliftCaption');ya.setAttribute('aria-busy','true');Event.listen(ya,'load',a.async_callback(function(){clearTimeout(this.imageRefreshTimer);this.image.setAttribute('aria-busy','false');this.setLoadingState(this.STATE_IMAGE_PIXELS,false);(function(){if(this.isOpen){this.adjustStageSize();this.adjustForNewData();}}).bind(this).defer();}.bind(this),'photo_theater'));ya.src=wa;return ya;},switchImage:function(wa,xa,ya){l.hide(this.image);l.hide(this.errorBox);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);var za=this.stream&&this.stream.getCurrentImageData();if(za)z.addPhotoView(za.info,this.shouldShowHiRes(za),this.fullscreen&&q.isFullScreen());this.useImage(this.makeNewImage(wa,false),xa,false);if(ya)this.stream.preloadImages(this.shouldShowHiRes(za));},switchVideo:function(wa,xa){var ya='swf_'+wa;if(xa){l.addClass(this.stageWrapper,'showVideo');var za=n.create('div',{className:'videoStageContainer'});n.appendContent(this.videoStage,za);za.id=wa;if(window[ya]&&!qa(ya))window[ya].write(wa);this.adjustStageSizeForVideo.bind(this,ya).defer();}else{window[ya]&&window[ya].addVariable('video_autoplay',0);this.videoLoadTimer&&clearTimeout(this.videoLoadTimer);n.empty(this.videoStage);l.removeClass(this.stageWrapper,'showVideo');}},checkVideoStatus:function(wa){if(this.videoLoadTimer)clearTimeout(this.videoLoadTimer);var xa=this.getVideoOnStage();if(!xa){return;}else{var ya='swf_'+xa;if(wa!==ya)return;this.adjustStageSizeForVideo(wa);}},adjustStageSizeForVideo:function(wa){var xa=qa(wa);if(!xa){this.videoLoadTimer=setTimeout(this.checkVideoStatus.bind(this,wa),200);}else this.adjustStageSize(new la(xa.width,xa.height));},handleServerError:function(wa,xa){n.setContent(this.errorBox,wa);this.storeFromData(xa);},swapData:function(){var wa,xa=this.stream.getCurrentHtml();if(xa){this.setLoadingState(va.STATE_HTML,false);for(var ya in xa){wa=qa(ya);wa&&n.setContent(wa,xa[ya]);}g.inform('PhotoSnowlift.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData())g.inform('PhotoSnowlift.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);}this.showPagers(va.PAGER_FADE);this.adjustScroller();this.scrollableArea.showScrollbar(false);this.adjustForNewData();this.logImpressionDetailsForPhoto();},updateTotalCount:function(wa,xa,ya){var za=this.stream.getCurrentHtml();if(za){var ab=ma('fbPhotoSnowliftPositionAndCount');n.replace(ab,ya);ab=ya;l.show(ab);var bb='fbPhotoSnowliftPositionAndCount';za[bb]=pa(ab.childNodes);}this.stream.setTotalCount(wa);this.stream.setFirstCursorIndex(xa);},addPhotoFbids:function(wa,xa,ya,za){if(za&&this.sessionID&&za!=this.sessionID)return;var ab=this.stream.getCursor()===null;this.stream.attachToFbidsList(wa,xa,ya);if(ya&&ab)this.page(0,true);if(this.pivots&&ya)this.pivots.setCycleCount(this.stream.calculateDistance(this.stream.getCursor(),this.stream.firstCursor));if(!this.pagersShown&&this.stream.canPage())this.setStagePagersState('ready');},attachTagger:function(wa){n.appendContent(this.stageActions,wa);},storeFromData:function(wa){if(!this.isOpen)return;if(wa.ssid&&this.sessionID&&this.sessionID!=wa.ssid)return;var xa=this.stream.storeToCache(wa);if('error' in xa){this.checkState(va.STATE_ERROR);return;}if('init' in xa){this.initDataFetched(xa.init);if(this.openExplicitly){this.replaceUrl=true;ra(this.stream.getCurrentImageData().info.permalink);}if(this.stream.canPage())this.setStagePagersState('ready');this.ua&&this.ua.add_event('ufi');}if('image' in xa)this.checkState(va.STATE_IMAGE_DATA);if('data' in xa)this.checkState(va.STATE_HTML);},setStagePagersState:function(wa){switch(wa){case 'ready':l.addClass(this.root,'pagingReady');this.pagersShown=true;this.ua&&this.ua.add_event('arrows');return;case 'active':l.addClass(this.root,'pagingActivated');return;case 'inactive':l.removeClass(this.root,'pagingActivated');return;case 'disabled':case 'reset':l.removeClass(this.root,'pagingReady');return;}},deletePhoto:function(wa){this.closeRefresh();},closeRefresh:function(){this.refreshOnClose=true;this.closeHandler();},onHiliteTag:function(wa,xa){if(xa.version!=y.VIEWER_SNOWLIFT)return;var ya=xa.tag;if(ya){this.switchHilitedTags(ya,true);}else this.unhiliteAllTags();},onUpdateTagBox:function(wa,xa){if(xa.version==y.VIEWER_SNOWLIFT)this.updateTagBox(xa.id,xa.approve);}});e.exports=va;});
__d("highlight",["Animation","Style"],function(a,b,c,d,e,f){var g=b('Animation'),h=b('Style');function i(j,k,l){new g(j).from('background','#fff9d7').to('background',l||'#fff').ease(g.ease.both).duration(2000).ondone(function(){h.set(j,'background','');k&&k();}).go();}e.exports=i;});
__d("ScrollHighlight",["DOMScroll","highlight","CSS"],function(a,b,c,d,e,f){var g=b('DOMScroll'),h=b('highlight'),i=b('CSS'),j={actOn:function(k){g.scrollTo(k);h(k,null,'#EDEFF4');i.removeClass(k,'highlightComment');}};e.exports=j;});
__d("ScrollingPager",["Arbiter","copyProperties","CSS","OnVisible","UIPagelet","$","ge"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('CSS'),j=b('OnVisible'),k=b('UIPagelet'),l=b('$'),m=b('ge'),n={};function o(p,q,r,s){this.scroll_loader_id=p;this.pagelet_src=q;this.data=r;this.options=s||{};if(this.options.target_id){this.target_id=this.options.target_id;this.options.append=true;}else this.target_id=p;this.handler=null;}h(o,{getInstance:function(p){return n[p];}});h(o.prototype,{setBuffer:function(p){this.options.buffer=p;this.onvisible&&this.onvisible.setBuffer(p);},getBuffer:function(){return this.options.buffer;},register:function(){this.onvisible=new j(l(this.scroll_loader_id),this.getHandler(),false,this.options.buffer,this.options);n[this.scroll_loader_id]=this;},getInstance:function(p){return n[p];},getHandler:function(){if(this.handler)return this.handler;function p(q){var r=m(this.scroll_loader_id);if(!r){this.onvisible.remove();return;}i.addClass(r.firstChild,'async_saving');var s=this.options.handler;this.options.handler=function(){g.inform('ScrollingPager/loadingComplete');s&&s.apply(null,arguments);};if(q)this.data.pager_fired_on_init=true;k.loadFromEndpoint(this.pagelet_src,this.target_id,this.data,this.options);}return p.bind(this);},setHandler:function(p){this.handler=p;},removeOnVisible:function(){this.onvisible.remove();}});e.exports=o;});
__d("ButtonGroup",["function-extensions","copyProperties","createArrayFrom","CSS","DataStore","Parent"],function(a,b,c,d,e,f){b('function-extensions');var g=b('copyProperties'),h=b('createArrayFrom'),i=b('CSS'),j=b('DataStore'),k=b('Parent'),l='firstItem',m='lastItem';function n(s,t){var u=k.byClass(s,t);if(!u)throw new Error('invalid use case');return u;}function o(s){return i.shown(s)&&h(s.childNodes).some(i.shown);}function p(s){var t,u,v;h(s.childNodes).forEach(function(w){v=o(w);i.removeClass(w,l);i.removeClass(w,m);i.conditionShow(w,v);if(v){t=t||w;u=w;}});t&&i.addClass(t,l);u&&i.addClass(u,m);i.conditionShow(s,t);}function q(s,t){var u=n(t,'uiButtonGroupItem');s(u);p(u.parentNode);}function r(s){this._root=n(s,'uiButtonGroup');j.set(this._root,'ButtonGroup',this);p(this._root);}r.getInstance=function(s){var t=n(s,'uiButtonGroup'),u=j.get(t,'ButtonGroup');return u||new r(t);};g(r.prototype,{hideItem:q.curry(i.hide),showItem:q.curry(i.show),toggleItem:q.curry(i.toggle)});e.exports=r;});
__d("legacy:ui-scrolling-pager-js",["ScrollingPager"],function(a,b,c,d){a.ScrollingPager=b('ScrollingPager');},3);
var StreamShareVideo={_endpoints:[],_thumbs:[],registerThumb:function(a,b,c,d){StreamShareVideo._endpoints[a+' '+c]=d;StreamShareVideo._thumbs[a+' '+c]=b;},clickTitle:function(a,b,event){if(StreamShareVideo._shouldFollowHref(event))return true;var c=ge(StreamShareVideo._thumbs[a+' '+b]);if(c){CSS.addClass(c,"uiVideoThumbLoading");AsyncRequest.bootstrap(StreamShareVideo._endpoints[a+' '+b],c);return false;}return true;},clickTimeline:function(a,b,event){if(StreamShareVideo._shouldFollowHref(event))return true;CSS.addClass(a,'externalShareLoading');CSS.removeClass(a,'externalShareUnitVideo');AsyncRequest.bootstrap(b,a);return false;},_shouldFollowHref:function(event){event=$E(event);if(!event)return false;if(event.getModifiers().any||event.isMiddleClick())return true;return false;}};